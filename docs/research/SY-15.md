# SY-15 Research: Phase 14 -- File Logging

## Overview

Add file-based logging with rotation to the Telegram bot (`synapse-telegram`). Define `LoggingConfig` in `synapse-core/src/config.rs`, add `tracing-appender` to `synapse-telegram`, and rewrite the tracing initialization to use a layered subscriber that outputs to both stdout and a rolling file appender. Only `synapse-telegram` gets file logging; `synapse-cli` remains stdout-only.

---

## Existing Infrastructure

### 1. Tracing in `synapse-telegram` (NEEDS REPLACEMENT)

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-telegram/src/main.rs` (lines 24-30)

Current tracing initialization:
```rust
tracing_subscriber::fmt()
    .with_env_filter(
        tracing_subscriber::EnvFilter::from_default_env()
            .add_directive("synapse_telegram=info".parse()?),
    )
    .init();
```

This creates a plain stdout-only `fmt` subscriber. It will be replaced by a layered subscriber using `tracing_subscriber::registry()`.

**Current dependencies in `synapse-telegram/Cargo.toml`:**
- `tracing = "0.1"` -- for `tracing::info!`, `tracing::warn!`, etc.
- `tracing-subscriber = { version = "0.3", features = ["env-filter"] }` -- needs `registry` feature added

### 2. Tracing in `synapse-cli` (NO CHANGE)

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-cli/src/main.rs`

The CLI does not use tracing at all. It uses `eprintln!` for warnings and `println!` for output. No changes needed.

### 3. `Config` Struct (NEEDS NEW FIELD)

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-core/src/config.rs` (line 34-75)

Current fields: `provider`, `api_key`, `model`, `system_prompt`, `system_prompt_file`, `session`, `mcp`, `telegram`.

A new `logging: Option<LoggingConfig>` field is needed. Following the existing pattern where optional config sections use `Option<T>` with `#[serde(default)]` (e.g., `session: Option<SessionConfig>`, `mcp: Option<McpSettings>`, `telegram: Option<TelegramConfig>`).

### 4. `config.example.toml` (ALREADY HAS SKELETON)

**File:** `/Users/comrade77/RustroverProjects/synapse/config.example.toml` (lines 70-80)

The `[logging]` section already exists as commented-out documentation:
```toml
# Logging configuration (file-based output with rotation)
# Omit this section entirely to disable file logging (stdout only).
# [logging]
# Directory to write log files to (relative or absolute path)
# directory = "logs"
#
# Maximum number of rotated log files to keep (oldest deleted when exceeded)
# max_files = 7
#
# Rotation strategy: "daily", "hourly", or "never"
# rotation = "daily"
```

This is already complete and matches the PRD. No changes needed to `config.example.toml`.

### 5. `docs/vision.md` -- File Logging Section (ALREADY EXISTS)

**File:** `/Users/comrade77/RustroverProjects/synapse/docs/vision.md` (lines 569-575)

Already contains:
```
### File Logging (Telegram Bot)

When deployed on a VPS, the Telegram bot supports file-based logging with rotation
via the `[logging]` section in `config.toml`. Uses `tracing-appender` with a
non-blocking writer. Files follow the naming pattern
`synapse-telegram.YYYY-MM-DD.log` (daily rotation). Old files are automatically
deleted when `max_files` is exceeded.
```

Also, `tracing-appender` is already listed in the Core Dependencies table at line 32: `Logging | tracing, tracing-subscriber, tracing-appender | Structured logging with file rotation`.

### 6. `docs/idea.md` -- Already Mentions File Logging

**File:** `/Users/comrade77/RustroverProjects/synapse/docs/idea.md` (line 19)

Already contains: `- **File-based logging**: Configurable log rotation for production deployments (Telegram bot)`

### 7. `docs/tasklist.md` -- Phase 14 Listed but Not Started

**File:** `/Users/comrade77/RustroverProjects/synapse/docs/tasklist.md` (lines 31, 230-238)

Phase 14 is listed as "Not Started" with all 5 tasks unchecked.

### 8. `lib.rs` Re-exports

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-core/src/lib.rs` (line 15)

Currently exports: `pub use config::{Config, ConfigError, McpSettings, SessionConfig, TelegramConfig};`

Will need to add `LoggingConfig` to this re-export list.

---

## Components That Need Changes

### Task 14.1: Add `LoggingConfig` Struct to `synapse-core/src/config.rs`

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-core/src/config.rs`

**Required changes:**

1. Add `LoggingConfig` struct with three fields and serde defaults:
   ```rust
   /// File-based logging configuration with rotation.
   ///
   /// Deserialized from the `[logging]` section in `config.toml`.
   /// Omit the section entirely to disable file logging (stdout only).
   #[derive(Debug, Clone, PartialEq, Deserialize)]
   pub struct LoggingConfig {
       /// Directory to write log files to (relative or absolute path).
       #[serde(default = "default_log_directory")]
       pub directory: String,

       /// Maximum number of rotated log files to keep.
       /// Oldest files are deleted when this limit is exceeded.
       #[serde(default = "default_max_files")]
       pub max_files: usize,

       /// Rotation strategy: "daily", "hourly", or "never".
       #[serde(default = "default_rotation")]
       pub rotation: String,
   }
   ```

2. Add default value functions:
   ```rust
   fn default_log_directory() -> String {
       "logs".to_string()
   }

   fn default_max_files() -> usize {
       7
   }

   fn default_rotation() -> String {
       "daily".to_string()
   }
   ```

3. Add `Default` impl for `LoggingConfig`:
   ```rust
   impl Default for LoggingConfig {
       fn default() -> Self {
           Self {
               directory: default_log_directory(),
               max_files: default_max_files(),
               rotation: default_rotation(),
           }
       }
   }
   ```

4. Add `logging: Option<LoggingConfig>` field to `Config` struct:
   ```rust
   /// File logging configuration (rotation, directory, max files).
   #[serde(default)]
   pub logging: Option<LoggingConfig>,
   ```

5. Update `Config::default()` to include `logging: None`.

6. Update `lib.rs` re-export to include `LoggingConfig`.

**Pattern to follow:** `SessionConfig` (config.rs lines 78-100) uses the exact same pattern: struct with `#[serde(default = "...")]` fields, named default functions, and `Default` impl.

**Required unit tests:**

- `test_logging_config_defaults` -- Verify `LoggingConfig::default()` produces `directory = "logs"`, `max_files = 7`, `rotation = "daily"`.
- `test_config_without_logging_section` -- Parse TOML without `[logging]`, verify `config.logging == None`.
- `test_config_with_logging_section` -- Parse full `[logging]` with custom values, verify all fields.
- `test_config_with_logging_section_partial_defaults` -- Parse `[logging]` with only `directory`, verify `max_files` and `rotation` get defaults.
- `test_config_with_empty_logging_section` -- Parse `[logging]` with no fields, verify all defaults apply.

### Task 14.2: Add Dependencies to `synapse-telegram`

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-telegram/Cargo.toml`

**Required changes:**

1. Add `tracing-appender` as a new dependency:
   ```toml
   tracing-appender = "0.2"
   ```

2. Add `registry` feature to `tracing-subscriber`:
   ```toml
   tracing-subscriber = { version = "0.3", features = ["env-filter", "registry"] }
   ```

**Version compatibility notes:**
- `tracing-appender 0.2.4` (latest) is compatible with `tracing-subscriber 0.3.x`
- Both are part of the `tokio-rs/tracing` ecosystem and designed to work together
- `tracing-subscriber 0.3.22` is already in the lockfile

### Task 14.3: Rewrite Tracing Init with Layered Subscriber

**File:** `/Users/comrade77/RustroverProjects/synapse/synapse-telegram/src/main.rs` (lines 24-30)

**Current code to replace:**
```rust
tracing_subscriber::fmt()
    .with_env_filter(
        tracing_subscriber::EnvFilter::from_default_env()
            .add_directive("synapse_telegram=info".parse()?),
    )
    .init();
```

**Required behavior based on `config.logging`:**

**Case 1: `config.logging` is `None` (no `[logging]` section)**
- Preserve current stdout-only behavior exactly as-is
- No file I/O, no guard needed

**Case 2: `config.logging` is `Some(logging_config)`**
- Create the log directory if it doesn't exist
- Build a `RollingFileAppender` using the builder pattern:
  ```rust
  let file_appender = tracing_appender::rolling::RollingFileAppender::builder()
      .rotation(rotation)           // Rotation::DAILY, HOURLY, or NEVER
      .filename_prefix("synapse-telegram")
      .max_log_files(logging_config.max_files)
      .build(&logging_config.directory)?;
  ```
- Wrap in non-blocking writer:
  ```rust
  let (non_blocking, _guard) = tracing_appender::non_blocking(file_appender);
  ```
- Create layered subscriber with both stdout and file layers:
  ```rust
  use tracing_subscriber::{Layer, prelude::*};

  let env_filter = tracing_subscriber::EnvFilter::from_default_env()
      .add_directive("synapse_telegram=info".parse()?);

  let stdout_layer = tracing_subscriber::fmt::layer()
      .with_filter(env_filter);

  let file_layer = tracing_subscriber::fmt::layer()
      .with_writer(non_blocking)
      .with_ansi(false);  // No ANSI color codes in file output

  tracing_subscriber::registry()
      .with(stdout_layer)
      .with(file_layer)
      .init();
  ```
- The `_guard` must be kept alive for the entire process lifetime. It should be stored as `let _guard = ...` in `main()` before the dispatcher loop.

**Rotation string mapping:**
```rust
let rotation = match logging_config.rotation.as_str() {
    "daily" => tracing_appender::rolling::Rotation::DAILY,
    "hourly" => tracing_appender::rolling::Rotation::HOURLY,
    "never" => tracing_appender::rolling::Rotation::NEVER,
    other => {
        tracing::warn!("Unknown rotation '{}', falling back to daily", other);
        tracing_appender::rolling::Rotation::DAILY
    }
};
```

**Important design considerations:**

1. **Config loading happens after tracing init:** Currently, tracing is initialized at line 25 and config is loaded at line 35. Since file logging depends on config, there are two approaches:
   - **Option A (recommended):** Move config loading before tracing init. Load config first (without tracing), then initialize tracing based on config. Any config loading errors would be reported to stderr.
   - **Option B:** Initialize a minimal stdout-only subscriber first, load config, then replace the subscriber. This is more complex and unnecessary.

   Option A is simpler and aligns with the design: `Config::load()` already uses `tracing::warn!` in error cases via `unwrap_or_else`, but since tracing isn't initialized yet, those log lines would be silently dropped. This is acceptable because the fallback behavior (`Config::default()`) means file logging would be disabled anyway.

2. **Directory creation:** The log directory should be created before building the file appender. Use `std::fs::create_dir_all()`. If directory creation fails, fall back to stdout-only with a warning to stderr.

3. **`_guard` lifetime:** The `WorkerGuard` returned by `tracing_appender::non_blocking()` flushes buffered logs when dropped. It must be stored as `let _guard = ...` in `main()` and live until after the dispatcher completes. Since the dispatcher loop runs on line 108-118, the guard declared before it will naturally be dropped after it.

4. **File naming:** `tracing-appender` with `filename_prefix("synapse-telegram")`, `filename_suffix("log")`, and `Rotation::DAILY` produces files named `synapse-telegram.YYYY-MM-DD.log`.

5. **EnvFilter for file layer:** The file layer should also respect `RUST_LOG` for log level filtering. Each layer can have its own filter, or a single global filter can be used. The simplest approach is to apply the env filter as a global layer on the registry, so both stdout and file layers inherit it.

**Revised layered subscriber with single global filter:**
```rust
use tracing_subscriber::{Layer, prelude::*};

let env_filter = tracing_subscriber::EnvFilter::from_default_env()
    .add_directive("synapse_telegram=info".parse()?);

let stdout_layer = tracing_subscriber::fmt::layer();

let file_layer = tracing_subscriber::fmt::layer()
    .with_writer(non_blocking)
    .with_ansi(false);

tracing_subscriber::registry()
    .with(env_filter)
    .with(stdout_layer)
    .with(file_layer)
    .init();
```

### Task 14.4: Update `config.example.toml`

**File:** `/Users/comrade77/RustroverProjects/synapse/config.example.toml`

The `[logging]` section (lines 70-80) is already complete with correct commented-out documentation. **No changes needed.**

### Task 14.5: Update Documentation Files

**`docs/idea.md`:** Already mentions file-based logging at line 19. No change needed.

**`docs/vision.md`:** Already has the "File Logging (Telegram Bot)" section at lines 569-575 and `tracing-appender` in the dependency table. No change needed.

**`docs/tasklist.md`:** Task checkboxes need to be checked off and the Phase 14 row in the progress table updated to "Complete" after implementation. This will be done during the commit phase.

---

## `tracing-appender` API Research

### `RollingFileAppender::builder()` (v0.2.4)

The builder pattern is the recommended way to construct a `RollingFileAppender`:

```rust
use tracing_appender::rolling::{RollingFileAppender, Rotation};

let appender = RollingFileAppender::builder()
    .rotation(Rotation::DAILY)           // DAILY, HOURLY, MINUTELY, WEEKLY, NEVER
    .filename_prefix("synapse-telegram") // Prefix before date stamp
    .max_log_files(7)                    // Keep last 7 files, delete oldest
    .build("/path/to/logs")?;            // Returns Result<RollingFileAppender, InitError>
```

**Builder methods:**
| Method | Type | Default | Description |
|--------|------|---------|-------------|
| `rotation(Rotation)` | `Rotation` | `Rotation::NEVER` | Rotation schedule |
| `filename_prefix(impl Into<String>)` | `String` | `""` | Prefix before date |
| `filename_suffix(impl Into<String>)` | `String` | `""` | Suffix after date |
| `max_log_files(usize)` | `usize` | No limit | Max retained files; 0 = no limit |
| `build(impl AsRef<Path>)` | -- | -- | Build the appender; returns `Result` |

**`Rotation` constants:**
- `Rotation::DAILY` -- Rotates at midnight UTC
- `Rotation::HOURLY` -- Rotates every hour
- `Rotation::MINUTELY` -- Rotates every minute
- `Rotation::WEEKLY` -- Rotates every Sunday at midnight UTC
- `Rotation::NEVER` -- Never rotates (single file)

### Non-blocking Writer

```rust
let (non_blocking, guard) = tracing_appender::non_blocking(appender);
// `guard` must be held for the process lifetime
// Dropping `guard` flushes buffered data and stops the background writer thread
```

### Layered Subscriber with `registry()`

Requires `tracing-subscriber` with `registry` feature:

```rust
use tracing_subscriber::prelude::*;

tracing_subscriber::registry()
    .with(layer_1)
    .with(layer_2)
    .init();
```

Each layer can have its own filter via `.with_filter()`, or a global filter can be applied to the registry.

---

## Reordering in `main()`

The current `main()` flow in `synapse-telegram/src/main.rs`:

1. Initialize tracing (line 25)
2. Log startup (line 32)
3. Load config (line 35)
4. Resolve bot token (line 41)
5. Create bot (line 44)
6. Create storage (line 47-56)
7. Auto-cleanup (line 58-73)
8. Create provider (line 76)
9. Initialize MCP (line 79-80)
10. Create agent (line 83-90)
11. Rebuild chat map (line 93-98)
12. Wrap config in Arc (line 101)
13. Set up handler and dispatcher (line 104-118)
14. Graceful shutdown (line 121-128)

**New flow:**

1. Load config (moved up, before tracing)
2. Initialize tracing (conditional: stdout-only or stdout+file based on config)
3. Log startup
4. Resolve bot token
5. ... (rest unchanged)

This reordering is necessary because tracing initialization depends on `config.logging`.

---

## Dependencies and Patterns

### New Dependencies

| Crate | Version | Target | Feature |
|-------|---------|--------|---------|
| `tracing-appender` | `0.2` | `synapse-telegram` | -- |
| `tracing-subscriber` | `0.3` (existing) | `synapse-telegram` | Add `registry` feature |

### No New Dependencies for `synapse-core`

`LoggingConfig` is a plain data struct with `serde::Deserialize`. No new crate dependencies needed in `synapse-core`.

---

## Deviations from Requirements

**None.** The existing codebase is well-aligned with the requirements:

- `config.example.toml` already has the `[logging]` section documented
- `docs/vision.md` already mentions `tracing-appender` and file logging
- `docs/idea.md` already mentions file-based logging
- The `Config` struct follows a consistent `Option<T>` pattern for optional sections
- `tracing-subscriber 0.3.22` is already in use and compatible with `tracing-appender 0.2.4`
- The layered subscriber approach (`registry()` + `.with()`) is the standard `tracing-subscriber` pattern

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `tracing-appender` `builder().build()` returns `Err` on invalid directory | Low | Medium | Create directory with `std::fs::create_dir_all()` before building; fall back to stdout-only on error |
| Non-blocking writer guard dropped early | Low | High | Declare `_guard` in `main()` before dispatcher loop; Rust's drop order guarantees it outlives the dispatcher |
| Config loaded before tracing is initialized | Low | Low | Config loading errors that would have been logged via `tracing::warn!` are silently dropped. Acceptable because fallback to `Config::default()` means logging will be stdout-only anyway |
| `max_log_files` behavior differs from expectations | Low | Low | `tracing-appender` v0.2.4 builder docs confirm: "Keeps the last n log files on disk. When a new file is created, if the total number exceeds the max, the oldest is deleted." Verified via docs.rs |
| `rotation` field accepts invalid strings | Low | Low | Map unknown rotation values to `Rotation::DAILY` with a warning. Document valid values in config example |
| File appender creation failure blocks bot startup | Low | High | If file appender fails to initialize, fall back to stdout-only with a warning to stderr rather than crashing |

---

## Test Strategy

### Unit Tests for `LoggingConfig` (in `synapse-core/src/config.rs`)

1. `test_logging_config_defaults` -- Verify `LoggingConfig::default()` returns `directory = "logs"`, `max_files = 7`, `rotation = "daily"`.
2. `test_config_without_logging_section` -- Parse TOML without `[logging]`, verify `config.logging.is_none()`.
3. `test_config_with_logging_section` -- Parse TOML with `[logging]\ndirectory = "/var/log/synapse"\nmax_files = 30\nrotation = "hourly"`, verify all fields.
4. `test_config_with_logging_section_partial_defaults` -- Parse TOML with `[logging]\ndirectory = "/tmp/logs"`, verify `max_files = 7` and `rotation = "daily"` (defaults).
5. `test_config_with_empty_logging_section` -- Parse TOML with just `[logging]`, verify all fields get their defaults.

### Integration/Manual Tests for `synapse-telegram`

The tracing initialization logic is in `main()` and involves filesystem I/O plus the tracing global subscriber. This is best tested manually or via integration tests:

1. Start bot with `[logging]` section -- verify log directory created and file appears.
2. Start bot without `[logging]` section -- verify stdout-only behavior.
3. Start bot with custom rotation/directory -- verify correct file naming.

---

## Implementation Order

1. **Task 14.1** -- Add `LoggingConfig` struct + field on `Config` + unit tests (no external dependencies)
2. **Task 14.2** -- Add `tracing-appender` dependency and `registry` feature to `synapse-telegram/Cargo.toml`
3. **Task 14.3** -- Rewrite tracing init in `synapse-telegram/src/main.rs` (depends on 14.1 + 14.2)
4. **Task 14.4** -- Update `config.example.toml` (already done -- verify only)
5. **Task 14.5** -- Update `docs/tasklist.md` progress checkboxes and status

Tasks 14.1 and 14.2 can be done in parallel. Task 14.3 depends on both. Tasks 14.4 and 14.5 are documentation-only and can be done last.

---

## Resolved Questions

- **User preference check:** The PRD has no open questions. The user was asked for implementation preferences and chose to proceed with documented requirements only.
- **`tracing-appender` version:** v0.2.4 (latest) is compatible with `tracing-subscriber 0.3.22` already in the lockfile.
- **`max_log_files` API:** Confirmed via docs.rs that `RollingFileAppender::builder().max_log_files(n)` is the correct API. Passing `0` disables automatic deletion.
- **`Rotation` enum:** Uses associated constants (`Rotation::DAILY`, `HOURLY`, `NEVER`), not function calls.
- **Config reordering:** Config must be loaded before tracing init to determine whether file logging is enabled. This is a safe reordering.
- **`config.example.toml`:** Already contains the `[logging]` section -- no changes needed.
- **`docs/vision.md` and `docs/idea.md`:** Already reference file logging and `tracing-appender` -- no changes needed.
