# SY-21 Research: Code Refactoring II

## 1. Existing Code Patterns and Contracts

### 1.1 Truncation Implementations (Scenario 21.1)

Three independent truncation implementations exist:

**A. `synapse-cli/src/commands.rs` (line 145):**
```rust
pub(crate) fn truncate(s: &str, max_len: usize) -> String {
    let char_count = s.chars().count();
    if char_count <= max_len {
        s.to_string()
    } else if max_len <= 3 {
        ".".repeat(max_len)
    } else {
        let truncated: String = s.chars().take(max_len - 3).collect();
        format!("{}...", truncated)
    }
}
```
Used in `handle_command` at lines 76-79 for session list display (provider, model, preview). Has a `max_len <= 3` guard that returns `"."` repeated. Tests in `commands::tests` (lines 162-176) and a duplicate test in `main.rs` (line 259).

**B. `synapse-telegram/src/commands.rs` (line 89):**
```rust
fn truncate_content(content: &str, max_chars: usize) -> String {
    if content.chars().count() <= max_chars {
        content.to_string()
    } else {
        let truncated: String = content.chars().take(max_chars).collect();
        format!("{}...", truncated)
    }
}
```
Used in `format_history` (line 112) to truncate history messages to 150 chars. Missing the `max_len <= 3` guard.

**C. `synapse-core/src/storage/sqlite.rs` (lines 206-213):**
```rust
let preview = preview.map(|p| {
    if p.chars().count() > 50 {
        let truncated: String = p.chars().take(47).collect();
        format!("{}...", truncated)
    } else {
        p
    }
});
```
Inline truncation to 50 chars (47 + "...") for session preview in `list_sessions()`. Hardcoded limit, not parameterized.

**Duplicate test:** `synapse-cli/src/main.rs` line 259 re-tests the same `truncate` function already tested in `commands::tests`.

All three are char-safe (use `.chars()`, not byte slicing), consistent with commit `3a4e33a`.

### 1.2 OpenAI-Compatible Providers (Scenario 21.2)

**`synapse-core/src/provider/deepseek.rs` (130 lines)** and **`synapse-core/src/provider/openai.rs` (113 lines)** are structurally identical thin wrappers over `openai_compat.rs` (776 lines).

Both have identical struct fields:
```rust
pub struct DeepSeekProvider {  // or OpenAiProvider
    client: reqwest::Client,
    api_key: String,
    model: String,
    max_tokens: u32,
}
```

Both have identical `new()` constructors, and their `LlmProvider` implementations are identical except for the `API_ENDPOINT` constant:
- DeepSeek: `https://api.deepseek.com/chat/completions`
- OpenAI: `https://api.openai.com/v1/chat/completions`

Each implements `complete()`, `complete_with_tools()`, and `stream()` with the exact same delegation pattern to `openai_compat::build_api_messages`, `openai_compat::ApiRequest`, `openai_compat::complete_request`, and `openai_compat::stream_sse`. Neither overrides `stream_with_tools()`.

The shared `openai_compat.rs` module exposes types and helpers as `pub(super)`:
- `ApiRequest`, `build_api_messages()`, `complete_request()`, `stream_sse()`, `to_oai_tools()`, `SSE_DONE_MARKER`

**`synapse-core/src/provider/factory.rs`** constructs providers:
```rust
"deepseek" => Box::new(DeepSeekProvider::new(api_key, model, config.max_tokens)),
"openai" => Box::new(OpenAiProvider::new(api_key, model, config.max_tokens)),
```

### 1.3 CLI Session Helpers (Scenario 21.3)

**Storage init + cleanup** is duplicated in `synapse-cli/src/main.rs`:

REPL path (lines 70-77):
```rust
let session_config = config.session.clone().unwrap_or_default();
let storage = create_storage(session_config.database_url.as_deref())
    .await
    .context("Failed to create storage")?;
if session_config.auto_cleanup {
    let _ = storage.cleanup(&session_config).await;
}
```

One-shot path (lines 94-103):
```rust
let session_config = config.session.clone().unwrap_or_default();
let storage = create_storage(session_config.database_url.as_deref())
    .await
    .context("Failed to create storage")?;
if session_config.auto_cleanup {
    let _ = storage.cleanup(&session_config).await;
}
```

**Session load-or-create** is duplicated between:

`main.rs` (lines 106-128):
```rust
let (session, history) = if let Some(session_id) = args.session {
    let session = storage.get_session(session_id).await...;
    let messages = storage.get_messages(session_id).await...;
    (session, messages)
} else {
    let session = Session::new(&config.provider, &config.model);
    storage.create_session(&session).await...;
    (session, Vec::new())
};
```

`repl.rs` (lines 82-105):
```rust
let (session, history) = match session_id {
    Some(id) => {
        let session = storage.get_session(id).await...;
        let messages = storage.get_messages(id).await...;
        (session, messages)
    }
    None => {
        let session = Session::new(&config.provider, &config.model);
        storage.create_session(&session).await...;
        (session, Vec::new())
    }
};
```

Identical logic with minor syntactic differences (`if let` vs `match`).

### 1.4 Telegram Duplication (Scenario 21.4)

**Auth checks** -- Inline in three places:
1. `handlers.rs` lines 66-74 (`handle_message`)
2. `commands.rs` lines 62-71 (`handle_command`)
3. `commands.rs` lines 645-653 (`handle_callback`)

All follow the same pattern: extract `user_id`, get `allowed_users`, call `is_authorized()`, return `Ok(())` if unauthorized.

**`format!("tg:{}", chat_id)`** -- 3 source occurrences:
- `commands.rs` line 206 (`cmd_new`)
- `commands.rs` line 544 (`do_delete`)
- `handlers.rs` line 203 (`resolve_session`)

**"No sessions" strings** -- 6 occurrences:
- `commands.rs` line 287: `"No sessions. Send a message or use /new to start one."`
- `commands.rs` line 306: `"No sessions. Send a message or use /new to start one."`
- `commands.rs` line 417: `"No sessions. Send a message or use /new to start one."`
- `commands.rs` line 445: `"No sessions. Send a message or use /new to start one."`
- `commands.rs` line 472: `"No sessions available."` (different wording)
- `commands.rs` line 512: `"No sessions available."` (different wording)

Four use the full hint; two use a shorter variant. The PRD's `NO_SESSIONS_HINT` constant should unify these to a single string.

**`TELEGRAM_MSG_LIMIT`** -- Defined twice:
- `handlers.rs` line 19: `const TELEGRAM_MSG_LIMIT: usize = 4096;`
- `format.rs` line 242: `const TELEGRAM_MSG_LIMIT: usize = 4096;`

**`cmd_switch_keyboard` and `cmd_delete_keyboard`** -- Structurally identical (lines 405-430 and 433-458). Both call `fetch_chat_sessions`, handle `None` with the same "No sessions" message, and on `Some` call `build_session_keyboard` with different action strings (`"switch"` vs `"delete"`) and prompt messages (`"Select a session to switch to:"` vs `"Select a session to delete:"`).

**`cmd_list` duplicates `fetch_chat_sessions`** -- `cmd_list` (lines 272-336) manually reads `chat_map`, extracts `session_uuids`, calls `storage.list_sessions()`, and filters. The `fetch_chat_sessions` helper (lines 339-375) already does the same thing. `cmd_list` should use it instead.

### 1.5 Dead Code and Magic Numbers (Scenario 21.5)

**`stream_with_tools()`** on the `LlmProvider` trait (line 140 of `provider.rs`):
```rust
fn stream_with_tools(
    &self,
    messages: &[Message],
    _tools: &[ToolDefinition],
) -> Pin<Box<dyn Stream<Item = Result<StreamEvent, ProviderError>> + Send + '_>> {
    self.stream(messages)
}
```
Never called by `Agent`. `agent.rs` only calls `complete_with_tools()` in the tool loop and `provider.stream()` / `provider.stream_owned()` for streaming. No provider overrides `stream_with_tools()`. It is dead code.

Referenced in documentation: `CLAUDE.md` line 89, `README.md` line 322, various docs.

**Magic numbers identified:**
- `40` in `cmd_list` (line 321): `.chars().take(40)` for session preview
- `20` in `build_session_keyboard` (line 391): `.chars().take(20)` for keyboard button preview
- `150` in `format_history` (line 112): `truncate_content(&m.content, 150)` for history truncation
- `10` in `format_history` (line 109): `.saturating_sub(10)` for message limit
- `50` / `47` in `sqlite.rs` (lines 207-208): session preview truncation limit
- `5` in `repl.rs` (line 138): `initial_area.height.saturating_sub(5)` approximate layout offset

### 1.6 Type Safety (Scenario 21.6)

**`LoggingConfig.rotation` is a `String`** -- `synapse-core/src/config.rs` line 190:
```rust
#[serde(default = "default_rotation")]
pub rotation: String,
```
With `default_rotation()` returning `"daily".to_string()`. Matched with `lc.rotation.as_str()` in `synapse-telegram/src/main.rs` line 68:
```rust
let rotation = match lc.rotation.as_str() {
    "daily" => tracing_appender::rolling::Rotation::DAILY,
    "hourly" => tracing_appender::rolling::Rotation::HOURLY,
    "never" => tracing_appender::rolling::Rotation::NEVER,
    other => { /* fallback warning */ }
};
```

A `Rotation` enum with `#[serde(rename_all = "lowercase")]` would catch invalid values at deserialization time.

**`Arc<Box<dyn SessionStore>>`** -- 15 occurrences in Telegram source files:
- `main.rs` line 141 (construction)
- `commands.rs`: lines 59, 176, 234, 275, 345, 408, 436, 467, 507, 576, 611, 641
- `handlers.rs`: lines 62, 187

The double indirection (`Arc` wrapping a `Box`) is unnecessary. `Arc<dyn SessionStore>` is sufficient and idiomatic. The `dptree::deps![]` macro uses type-based matching, so changing the type requires updating all injection sites simultaneously.

### 1.7 Small Polish (Scenario 21.7)

**REPL layout constants** -- The same layout constraints appear in two places:

`render.rs` lines 22-26:
```rust
let layout = Layout::vertical([
    Constraint::Min(3),
    Constraint::Length(3),
    Constraint::Length(1),
])
```

`repl.rs` lines 146-150 (inside the draw closure):
```rust
let layout = Layout::vertical([
    Constraint::Min(3),
    Constraint::Length(3),
    Constraint::Length(1),
])
```

And `repl.rs` line 138: `let mut history_height = initial_area.height.saturating_sub(5);`

These should be named constants: `REPL_MIN_HISTORY_HEIGHT = 3`, `REPL_INPUT_HEIGHT = 3`, `REPL_STATUS_HEIGHT = 1`.

**`ChatSessions` struct literals** -- 13 occurrences in source code (excluding the struct definition and impl block):
- `main.rs` line 285 (in `rebuild_chat_map`)
- `commands.rs` lines 190, 526 (in `cmd_new` and `do_delete`)
- `handlers.rs` line 219 (in `resolve_session`)
- `commands.rs` tests: lines 1035, 1044, 1055, 1068, 1093, 1142, 1168, 1194

All follow the same pattern: `ChatSessions { sessions: ..., active_idx: ... }`. A `ChatSessions::new(session_id)` constructor would centralize the default construction. Note: test constructions with non-default `active_idx` values would still need the struct literal or a builder.

**`Ok(r) | Err(r) => r`** -- 4 occurrences in `commands.rs`:
- Line 585 (in `cmd_switch`)
- Line 620 (in `cmd_delete`)
- Line 688 (in `handle_callback`, switch branch)
- Line 691 (in `handle_callback`, delete branch)

These can be replaced with `.unwrap_or_else(|e| e)` since both `Ok` and `Err` carry the same type (`String`).

### 1.8 Large Module Structure (Scenario 21.8)

**`synapse-telegram/src/commands.rs` (1214 lines):**
- Lines 1-82: Command enum, `handle_command` dispatcher
- Lines 84-269: Helper functions (`truncate_content`, `format_history`, `cmd_start`, `cmd_help`, `cmd_new`, `cmd_history`)
- Lines 270-337: `cmd_list`
- Lines 339-401: `fetch_chat_sessions`, `build_session_keyboard`
- Lines 403-705: Keyboard commands, callback handlers (`cmd_switch_keyboard`, `cmd_delete_keyboard`, `do_switch`, `do_delete`, `cmd_switch`, `cmd_delete`, `handle_callback`)
- Lines 707-1214: Tests

Split target: `commands.rs` (slash command handlers, ~600 lines) + `commands/keyboard.rs` (keyboard builders, `do_switch`, `do_delete`, `handle_callback`, ~600 lines).

**`synapse-telegram/src/format.rs` (702 lines):**
- Lines 1-239: `md_to_telegram_html`, `escape_html`
- Lines 240-330: `TELEGRAM_MSG_LIMIT`, `OpenTag`, `chunk_html`
- Lines 331-702: Tests

Split target: `format.rs` (Markdown conversion, ~400 lines) + `format/chunk.rs` (HTML chunking, ~300 lines).

**`synapse-core/src/provider/anthropic.rs` (674 lines):**
- Lines 1-234: Provider struct, `new()`, helper methods (`extract_system`, `build_api_messages`, `send_request`, `parse_response`)
- Lines 236-333: Serde types (`ApiRequest`, `AnthropicTool`, `ApiContent`, `ApiMessage`, `ApiResponse`, `ContentBlock`, `ApiError`, `ErrorDetail`)
- Lines 335-674: `LlmProvider` impl, streaming, tests

Split target: `anthropic.rs` (provider impl, ~350 lines) + `anthropic/types.rs` (serde structs, ~320 lines). The types module would be `pub(super)` or `pub(crate)` since the types are internal.

## 2. Layers and Dependencies

### Dependency Flow for Each Scenario

```
Scenario 21.1 (truncation):
  synapse-core/src/text.rs (NEW) -- single truncate function
    ↑ imported by:
    ├── synapse-cli/src/commands.rs (delete local truncate)
    ├── synapse-telegram/src/commands.rs (delete local truncate_content)
    └── synapse-core/src/storage/sqlite.rs (replace inline truncation)

Scenario 21.2 (providers):
  synapse-core/src/provider/openai_compat.rs -- add OpenAiCompatProvider struct
    ↑ used by:
    ├── synapse-core/src/provider/deepseek.rs -- newtype wrapping OpenAiCompatProvider
    └── synapse-core/src/provider/openai.rs -- newtype wrapping OpenAiCompatProvider
    ↑ constructed by:
    └── synapse-core/src/provider/factory.rs

Scenario 21.3 (CLI helpers):
  synapse-cli/src/session_helpers.rs (NEW) -- init_storage + load_or_create_session
    ↑ used by:
    ├── synapse-cli/src/main.rs
    └── synapse-cli/src/repl.rs

Scenario 21.4 (Telegram dedup):
  All changes within synapse-telegram/src/*.rs
  No cross-crate dependencies added.

Scenario 21.5 (dead code + constants):
  synapse-core/src/provider.rs -- remove stream_with_tools from trait
  synapse-telegram/src/commands.rs -- extract named constants
  docs: CLAUDE.md, README.md -- remove stream_with_tools references

Scenario 21.6 (type safety):
  synapse-core/src/config.rs -- Rotation enum
  synapse-telegram/src/main.rs -- update match site
  synapse-telegram/src/*.rs -- Arc<Box<dyn SessionStore>> -> Arc<dyn SessionStore>

Scenario 21.7 (polish):
  synapse-cli/src/repl.rs, synapse-cli/src/repl/render.rs -- layout constants
  synapse-telegram/src/handlers.rs -- ChatSessions::new()
  synapse-telegram/src/commands.rs -- unwrap_or_else pattern

Scenario 21.8 (splits):
  synapse-telegram/src/commands.rs -> commands.rs + commands/keyboard.rs
  synapse-telegram/src/format.rs -> format.rs + format/chunk.rs
  synapse-core/src/provider/anthropic.rs -> anthropic.rs + anthropic/types.rs
```

### New Dependencies Required

None. All changes are internal refactoring within existing crate dependencies.

### New Files Required

- `synapse-core/src/text.rs` (scenario 21.1)
- `synapse-cli/src/session_helpers.rs` or similar (scenario 21.3, could also be `helpers.rs`)
- `synapse-telegram/src/commands/keyboard.rs` (scenario 21.8)
- `synapse-telegram/src/format/chunk.rs` (scenario 21.8)
- `synapse-core/src/provider/anthropic/types.rs` (scenario 21.8)

## 3. Task Ordering and Dependencies

The PRD specifies these ordering constraints:

1. **21.1** (unified truncate) should complete first -- later tasks may use the shared function.
2. **21.5** (remove `stream_with_tools`) should complete before **21.8** (split `anthropic.rs`) -- avoid carrying dead code into the new submodule.
3. **21.6** (`Arc<Box<dyn SessionStore>>` removal) should complete before **21.8** (split `commands.rs`) -- avoid propagating the old type into new files.

Recommended execution order:
1. 21.1 (truncation unification)
2. 21.2 (provider consolidation)
3. 21.3 (CLI session helpers)
4. 21.4 (Telegram deduplication)
5. 21.5 (dead code + constants)
6. 21.6 (type safety)
7. 21.7 (small polish)
8. 21.8 (module splits)

## 4. Existing Test Infrastructure

### Test Counts

```
synapse-core:     ~35 tests (provider, storage, config, agent, session, mcp, message)
synapse-cli:      ~15 tests (args parsing, truncate)
synapse-telegram: ~68 tests (commands, format, handlers, main)
```

### Tests Affected by Each Scenario

- **21.1**: `test_truncate`, `test_truncate_multibyte_chars` in `synapse-cli/src/commands.rs` move to `synapse-core/src/text.rs`. Delete duplicate `test_truncate` from `synapse-cli/src/main.rs` (line 259). `test_truncate_content_*` and `test_format_history_*` in Telegram `commands.rs` will import the shared function.

- **21.2**: `test_deepseek_provider_new` and `test_openai_provider_new` will need updating for the newtype pattern. Field assertions (`provider.api_key`, etc.) may need accessor methods or test through the generic struct.

- **21.5**: No tests call `stream_with_tools()` directly. Removing it from the trait requires removing any test that references it (grep found none in test modules).

- **21.6**: `Rotation` enum needs deserialization tests for `"daily"`, `"hourly"`, `"never"`. Config tests in `synapse-core/src/config.rs` that parse TOML with `rotation = "daily"` should continue passing. `Arc<Box<dyn SessionStore>>` to `Arc<dyn SessionStore>` change affects the mock store in `synapse-telegram/src/main.rs` tests -- the mock construction pattern changes.

- **21.8**: Test modules move with their parent code. Re-exports ensure test imports remain valid.

## 5. Limitations and Risks

### Truncation Semantic Differences

The three truncation implementations have slightly different behaviors:
- CLI `truncate`: Has `max_len <= 3` guard returning `"."` repeated
- Telegram `truncate_content`: No `max_len <= 3` guard
- SQLite inline: Hardcoded to 50/47 chars, different threshold check (`> 50` vs `<= max_len`)

The unified function should adopt the CLI version's behavior (with the `max_len <= 3` guard) as it is the most defensive. Callers that previously used `truncate_content` (which lacked this guard) will gain the protection, which is safe since `max_chars` is always >= 10 in practice.

### `Arc<Box<dyn SessionStore>>` Migration

The `dptree::deps![]` macro in the Telegram dispatcher uses type-based matching. Changing `Arc<Box<dyn SessionStore>>` to `Arc<dyn SessionStore>` requires updating:
1. The construction site in `main.rs` line 141
2. The `dptree::deps![]` injection (wherever `storage` is injected)
3. All 15 function signatures in `commands.rs`, `handlers.rs`
4. The mock store construction in test modules

All changes must be made simultaneously for the code to compile.

### OpenAiCompatProvider Consolidation

The `openai_compat.rs` helpers (`build_api_messages`, `complete_request`, `stream_sse`) are currently `pub(super)`. When wrapping them in a generic struct, the struct's `LlmProvider` impl must live in `openai_compat.rs` itself (since it calls `pub(super)` helpers). The newtypes in `deepseek.rs` and `openai.rs` delegate all trait methods to the inner `OpenAiCompatProvider`.

The existing `test_deepseek_provider_new` and `test_openai_provider_new` tests directly access struct fields (`provider.api_key`). With newtypes, these fields are on the inner struct. The tests can either access through the inner field or be rewritten to test through the trait.

### Module Split Re-exports

When splitting `commands.rs` into `commands.rs` + `commands/keyboard.rs`, the file `commands.rs` becomes a module root. Per Rust 2018+ convention (no `mod.rs`), the file stays as `commands.rs` and a directory `commands/` is created alongside it with `keyboard.rs` inside. The parent `commands.rs` declares `mod keyboard;` and re-exports public items. Since `handle_callback` is public (called by the dispatcher), it must be re-exported.

Same pattern applies to `format.rs` -> `format/chunk.rs` and `anthropic.rs` -> `anthropic/types.rs`.

## 6. Resolved Questions

The PRD has no open questions. All specifications are clear:

- Char-safe truncation using `.chars()` (not byte slicing) -- matches commit `3a4e33a`
- `Rotation` enum with `#[serde(rename_all = "lowercase")]` for backward compatibility
- No `mod.rs` files -- Rust 2018+ convention per `docs/conventions.md`
- No external behavior changes
- Pre-commit gate (`cargo fmt --check && cargo clippy -- -D warnings && cargo test`) after every task

## 7. New Technical Questions Discovered

### Question 1: CLI Helper Module Location

The PRD says "Extract `load_or_create_session()` shared between `main.rs` and `repl.rs`" but does not specify the file name. Options:
- `synapse-cli/src/session_helpers.rs` (explicit purpose)
- `synapse-cli/src/helpers.rs` (generic)
- Inline in `main.rs` as a private function (since `repl.rs` is a submodule of the binary)

Since both `main.rs` and `repl.rs` need access, a separate module declared in `main.rs` (`mod session_helpers;`) is most natural.

### Question 2: `ChatSessions::new` Signature

The PRD says `ChatSessions::new(session_id: Uuid)` creates a `ChatSessions` with one session. But some construction sites create empty `ChatSessions` (e.g., `or_insert_with(|| ChatSessions { sessions: vec![], active_idx: 0 })`). Should there be both `ChatSessions::new(session_id)` (one session) and `ChatSessions::empty()` (no sessions)? Or should `new` take an `Option<Uuid>`?

### Question 3: Keyboard Prompt Text in Unified Builder

`cmd_switch_keyboard` sends "Select a session to switch to:" and `cmd_delete_keyboard` sends "Select a session to delete:". The PRD says to merge these into `build_action_keyboard`. The prompt text is sent by the caller, not the keyboard builder, so the unification is straightforward -- the prompt remains at the call site and only the keyboard construction + fetch logic is merged.

## 8. Deviations from Requirements

None identified. All PRD claims about duplication counts, line numbers, and patterns have been verified against the current codebase and are accurate.
