# SY-16 Research: Phase 15 — Code Refactoring

## Ticket

SY-16 — Phase 15: Code Refactoring

## Summary

This document captures the technical context for implementing seven internal refactoring tasks across the Synapse workspace. All changes are purely internal; no external behaviour changes are permitted. The research validates each PRD requirement against the current codebase and identifies exact file locations, line ranges, patterns, and risks.

---

## 1. Dead Code and Vestigial Modules

### 1.1 `placeholder` module

- **Location:** `synapse-core/src/lib.rs` lines 25-31.
- **Declaration:** `pub mod placeholder { pub fn hello() -> &'static str { "Hello from synapse-core!" } }`
- **Consumers:** Grep confirms zero imports of `placeholder` or `hello()` from any crate.
- **Action:** Delete lines 25-31.

### 1.2 Unused `StreamEvent` variants

- **Location:** `synapse-core/src/provider/streaming.rs` lines 36-67.
- **Variants to remove:** `ToolCall { id, name, input }`, `ToolResult { id, output }`, `Error(ProviderError)`.
- **Current consumers:**
  - `streaming.rs` tests (lines 80-106): test these variants directly — tests must be removed.
  - `synapse-cli/src/main.rs` line 213: `Some(Ok(StreamEvent::Error(e)))` arm.
  - `synapse-cli/src/repl.rs` line 646: `Some(Ok(StreamEvent::Error(e)))` arm.
  - `synapse-cli/src/main.rs` line 216: wildcard `Some(Ok(_))` arm (covers ToolCall/ToolResult).
- **Action:** Remove the three variants; remove their test cases in `streaming.rs`; remove the `StreamEvent::Error(e)` match arms and the `Some(Ok(_))` wildcard arms in CLI `main.rs` and `repl.rs`. After removal, the match on `StreamEvent` needs only `TextDelta` and `Done`.

### 1.3 `#[allow(dead_code)]` annotations

- **Location:** `synapse-core/src/provider/deepseek.rs` line 315-316: `finish_reason: Option<String>` on `StreamChoice`.
- **Location:** `synapse-core/src/provider/openai.rs` line 194-195: same `finish_reason` field on `StreamChoice`.
- **Action:** Add serde-justification comments explaining these fields are populated by deserialization.

---

## 2. OpenAI-Compatible Provider Extraction

### 2.1 Duplication Analysis

**Identical types (structurally equivalent except naming prefix):**

| Type | DeepSeek (deepseek.rs) | OpenAI (openai.rs) |
|------|------------------------|--------------------|
| `ApiMessage` | lines 230-243 | lines 124-133 |
| `ApiRequest` | lines 183-194 | lines 86-93 |
| `StreamingApiRequest` | lines 197-210 | lines 96-104 |
| `*Tool` | `DeepSeekTool` lines 213-218 | `OpenAiTool` lines 107-112 |
| `*Function` | `DeepSeekFunction` lines 221-227 | `OpenAiFunction` lines 115-121 |
| `*ToolCall` | `DeepSeekToolCall` lines 246-253 | `OpenAiToolCall` lines 136-142 |
| `*ToolCallFunction` | `DeepSeekToolCallFunction` lines 255-259 | `OpenAiToolCallFunction` lines 145-149 |
| `ApiResponse` | lines 262-266 | lines 152-155 |
| `Choice` | lines 269-273 | lines 158-161 |
| `ChoiceMessage` | lines 276-283 | lines 164-169 |
| `ApiError` | lines 286-290 | lines 172-175 |
| `ErrorDetail` | lines 292-297 | lines 178-181 |
| `StreamChunk` | lines 300-304 | lines 184-187 |
| `StreamChoice` | lines 307-317 | lines 190-196 |
| `StreamDelta` | lines 320-324 | lines 199-202 |

**Identical functions:**

| Function | DeepSeek | OpenAI |
|----------|----------|--------|
| `build_api_messages()` | lines 68-105 | lines 45-82 |
| `complete_request()` | lines 108-179 (on DeepSeekProvider) | lines 349-420 (on OpenAiProvider) |
| `to_*_tools()` | `to_deepseek_tools()` lines 327-345 | `to_openai_tools()` lines 205-223 |
| `stream()` impl body | lines 379-474 | lines 257-344 |

The only differences are:
1. **API endpoint URL:** DeepSeek = `https://api.deepseek.com/chat/completions`, OpenAI = `https://api.openai.com/v1/chat/completions`.
2. **Auth header:** Both use `Bearer {api_key}` — identical.
3. **Type naming prefix:** `DeepSeek*` vs `OpenAi*` — trivially unified to `Oai*`.

### 2.2 Proposed `openai_compat.rs` Module

- **New file:** `synapse-core/src/provider/openai_compat.rs`
- **Contents:**
  - All 15 shared serde types (with `Oai` prefix).
  - `pub fn build_api_messages(messages: &[Message]) -> Vec<ApiMessage>`
  - `pub async fn complete_request(client: &reqwest::Client, endpoint: &str, api_key: &str, request: &ApiRequest) -> Result<Message, ProviderError>`
  - `pub fn to_oai_tools(tools: &[ToolDefinition]) -> Option<Vec<OaiTool>>`
  - `pub fn stream_sse(client: reqwest::Client, endpoint: &str, api_key: String, model: String, messages: Vec<Message>, max_tokens: u32) -> Pin<Box<dyn Stream<...>>>`
  - `pub const SSE_DONE_MARKER: &str = "[DONE]"` (also relevant to task 15.3).
- **Reduced providers:** Each becomes ~50-80 lines: struct definition, `new()`, `LlmProvider` impl delegating to `openai_compat`.
- **Anthropic provider:** Not part of this extraction; uses a different API format (content blocks, no OpenAI-style messages).

### 2.3 Test Strategy

All existing tests in `deepseek.rs` and `openai.rs` test serde types and serialization. After extraction:
- Move serde tests to `openai_compat.rs` (test once, not twice).
- Keep provider-specific tests only for endpoint/model wiring.
- Add `provider.rs` module declaration: `mod openai_compat;`.

---

## 3. Constants and Methods for Magic Strings

### 3.1 `Role::as_str()` and `Role::from_str()`

- **Location for addition:** `synapse-core/src/message.rs` on `impl Role`.
- **Current manual matching:**
  - `synapse-core/src/provider/deepseek.rs` lines 72-77 (`build_api_messages`).
  - `synapse-core/src/provider/openai.rs` lines 49-54 (`build_api_messages`).
  - `synapse-core/src/storage/sqlite.rs` lines 95-113 (`parse_role`, `role_to_string`).
  - `synapse-cli/src/main.rs` lines 322-327 (display labels — these use `[SYSTEM]` etc., different from as_str; keep manual).
- **Note:** `Role` already has `#[serde(rename_all = "lowercase")]` so serde already handles serialization. The `as_str()` method provides programmatic access to the same lowercase string. `from_str()` can be implemented via `std::str::FromStr` trait.
- After adding `Role::as_str()`, the `SqliteStore::role_to_string()` and `SqliteStore::parse_role()` can delegate to it, and `build_api_messages()` can use `m.role.as_str().to_string()` instead of the manual match.

### 3.2 `SSE_DONE_MARKER`

- **Hard-coded locations:** `deepseek.rs` line 441, `openai.rs` line 313 — both check `event.data == "[DONE]"`.
- **Action:** Add `pub const SSE_DONE_MARKER: &str = "[DONE]"` in `openai_compat.rs` (since both are OpenAI-compat providers).

### 3.3 `ERROR_REPLY` in Telegram handlers

- **Location:** `synapse-telegram/src/handlers.rs` line 69 and line 123 — both use the literal `"Sorry, I encountered an error. Please try again."`.
- **Action:** Add `const ERROR_REPLY: &str = "Sorry, I encountered an error. Please try again."` at the top of `handlers.rs`.

### 3.4 `DEFAULT_TRACING_DIRECTIVE` in Telegram main

- **Location:** `synapse-telegram/src/main.rs` lines 42, 75, 95 — all use `"synapse_telegram=info"` as a parsed directive.
- **Action:** Add `const DEFAULT_TRACING_DIRECTIVE: &str = "synapse_telegram=info"` at the top of `main.rs`.

### 3.5 Provider/env-var constants in factory

- **Location:** `synapse-core/src/provider/factory.rs` lines 64-68 — hard-coded `"DEEPSEEK_API_KEY"`, `"ANTHROPIC_API_KEY"`, `"OPENAI_API_KEY"`.
- **Action:** Add constants at the top of `factory.rs`:
  ```rust
  const DEEPSEEK_API_KEY_ENV: &str = "DEEPSEEK_API_KEY";
  const ANTHROPIC_API_KEY_ENV: &str = "ANTHROPIC_API_KEY";
  const OPENAI_API_KEY_ENV: &str = "OPENAI_API_KEY";
  ```

---

## 4. Structured Tracing in synapse-core

### 4.1 Current State

- `synapse-core/Cargo.toml`: No `tracing` dependency.
- `synapse-cli/Cargo.toml`: No `tracing` dependency.
- `synapse-telegram/Cargo.toml`: Has `tracing = "0.1"` and `tracing-subscriber`.
- `tracing` is already a transitive dependency in the workspace (via `tracing-subscriber` in `synapse-telegram`), so adding it to `synapse-core` adds zero new crates.

### 4.2 `eprintln!` to Replace

| File | Line | Usage |
|------|------|-------|
| `synapse-core/src/mcp/tools.rs` | 57 | `eprintln!("Warning: MCP server '{}' failed to start: {}", name, e)` |
| `synapse-cli/src/main.rs` | 74 | `eprintln!("Warning: MCP initialization failed: {}", e)` |
| `synapse-cli/src/main.rs` | 80 | `eprintln!("Warning: MCP config error: {}", e)` |
| `synapse-cli/src/repl.rs` | 675 | `eprintln!("Session: {}", session.id)` |

Note: `synapse-telegram/src/main.rs` lines 35, 54, 106 also use `eprintln!`, but these are for tracing init fallback and config load fallback — they fire BEFORE tracing is initialized, so they must remain `eprintln!`.

### 4.3 Instrumentation Points

Per PRD requirements:
- **Agent tool loop** (`agent.rs` `complete()`): `tracing::debug!` or `tracing::info!` on tool call iterations.
- **Provider HTTP requests** (`deepseek.rs`, `openai.rs`, `anthropic.rs`, or `openai_compat.rs` after extraction): `tracing::debug!` on request/response.
- **Factory** (`factory.rs` `create_provider()`): `tracing::info!` on provider creation.
- **Storage** (`sqlite.rs`): `tracing::debug!` on session CRUD operations.
- **Config** (`config.rs` `load()`): `tracing::debug!` on resolved config path.
- **MCP** (`tools.rs`, `mcp.rs`): `tracing::info!` on tool discovery, `tracing::debug!` on tool execution.

### 4.4 Dependencies to Add

```toml
# synapse-core/Cargo.toml
tracing = "0.1"

# synapse-cli/Cargo.toml
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }
```

The CLI needs `tracing-subscriber` to initialize a subscriber (even a minimal stdout-only one) so that tracing macros in `synapse-core` actually output. Without a subscriber, `tracing::warn!` in core would be silently dropped.

---

## 5. Shared Utility Extraction

### 5.1 `init_mcp_client()` Duplication

- **CLI copy:** `synapse-cli/src/main.rs` lines 68-84.
- **Telegram copy:** `synapse-telegram/src/main.rs` lines 208-224.
- **Differences:** CLI uses `eprintln!` for warnings; Telegram uses `tracing::warn!`.
- **Proposed location:** `synapse-core/src/mcp.rs` (or new submodule `synapse-core/src/mcp/init.rs`).
- **Signature:** `pub async fn init_mcp_client(config_path: Option<&str>) -> Option<McpClient>`.
- **Warning handling:** After task 15.4 adds `tracing` to core, the shared function can use `tracing::warn!`, and both CLI and Telegram benefit from structured warnings.

### 5.2 `Agent::from_config()` Factory Method

- **Current pattern (duplicated 3 times):**
  ```rust
  let provider = create_provider(&config)?;
  let agent = {
      let a = Agent::new(provider, mcp_client);
      match config.system_prompt {
          Some(ref prompt) => a.with_system_prompt(prompt),
          None => a,
      }
  };
  ```
- **Locations:**
  - CLI `main.rs` lines 184-190 (one-shot mode).
  - CLI `repl.rs` uses `Agent::new` directly (line varies, delegated from `run_repl`).
  - Telegram `main.rs` lines 158-164.
- **Proposed method:**
  ```rust
  impl Agent {
      pub fn from_config(config: &Config, mcp_client: Option<McpClient>) -> Result<Self, ProviderError> {
          let provider = create_provider(config)?;
          let mut agent = Self::new(provider, mcp_client);
          if let Some(ref prompt) = config.system_prompt {
              agent = agent.with_system_prompt(prompt);
          }
          Ok(agent)
      }
  }
  ```
- **Note:** This creates a dependency from `Agent` on `Config` and `create_provider`, which are already in `synapse-core`. No circular dependency.

---

## 6. File Splitting

### 6.1 `repl.rs` (1168 lines)

- **Current structure:** Single file with `TerminalGuard`, `ReplApp` struct, rendering functions, input handling, and `run_repl()` orchestrator.
- **Proposed split:**
  - `synapse-cli/src/repl/app.rs` — `ReplApp` struct definition, state machine fields, state transitions.
  - `synapse-cli/src/repl/render.rs` — All `draw_*` and `render_*` functions, TUI layout logic.
  - `synapse-cli/src/repl/input.rs` — Key event handling, `handle_key_event()`.
  - `synapse-cli/src/repl.rs` — Module declarations, `TerminalGuard`, `run_repl()` orchestrator, re-exports.
- **Convention check:** Uses Rust 2018+ module system (no `mod.rs`). The directory `synapse-cli/src/repl/` will contain the submodules, declared from `synapse-cli/src/repl.rs`.

### 6.2 CLI `main.rs` — Extract `commands.rs`

- **Current content to extract:** `handle_command()` (lines 250-349), `Commands` enum (lines 43-49), `SessionAction` enum (lines 51-65), `truncate()` helper (lines 352-360).
- **Proposed file:** `synapse-cli/src/commands.rs`.
- **Remaining in `main.rs`:** `Args` struct, `init_mcp_client()`, `main()`, `get_message()`, tests.

---

## 7. Public API Surface and Async Fix

### 7.1 Current `lib.rs` Re-exports (24 items)

```rust
pub use agent::{Agent, AgentError};                                                    // 2
pub use config::{Config, ConfigError, LoggingConfig, McpSettings, SessionConfig, TelegramConfig}; // 6
pub use mcp::{McpClient, McpConfig, McpError, McpServerConfig, ToolDefinition, load_mcp_config};  // 6
pub use message::{Message, Role, ToolCallData};                                        // 3
pub use provider::{AnthropicProvider, DeepSeekProvider, LlmProvider, MockProvider,
    OpenAiProvider, ProviderError, StreamEvent, create_provider};                       // 8
pub use session::{Session, SessionSummary, StoredMessage};                             // 3
pub use storage::{CleanupResult, SessionStore, SqliteStore, StorageError, create_storage}; // 5
```

**Total: 33 re-exported items** (not 24 as estimated in PRD).

### 7.2 Actual Imports by Consumer Crates

**synapse-cli/src/main.rs imports:**
`Agent, Config, McpClient, Message, Role, Session, StoredMessage, StreamEvent, create_provider, create_storage, load_mcp_config`

**synapse-cli/src/repl.rs imports:**
`Agent, AgentError, Config, LlmProvider, McpClient, Message, Role, Session, SessionStore, StoredMessage, StreamEvent`

**synapse-telegram/src/main.rs imports:**
`Agent, Config, McpClient, SessionStore, SessionSummary, create_provider, create_storage, load_mcp_config`

**synapse-telegram/src/handlers.rs imports (via path, not re-export):**
`synapse_core::message::{Message as CoreMessage, Role}`, `synapse_core::session::Session`, `synapse_core::{Agent, Config, SessionStore, StoredMessage}`

**synapse-telegram/src/main.rs test imports:**
`synapse_core::config::SessionConfig`, `synapse_core::session::{Session, StoredMessage}`, `synapse_core::storage::{CleanupResult, SessionStore, StorageError}`, `synapse_core::{Config, TelegramConfig}`

### 7.3 Items Never Imported via Re-export

Comparing all consumer imports against `lib.rs` re-exports:

| Re-export | CLI main | CLI repl | TG main | TG handlers | TG tests | Needed? |
|-----------|----------|----------|---------|-------------|----------|---------|
| `Agent` | Y | Y | Y | Y | - | Y |
| `AgentError` | - | Y | - | - | - | Y |
| `Config` | Y | Y | Y | Y | Y | Y |
| `ConfigError` | - | - | - | - | - | N |
| `LoggingConfig` | - | - | - | - | - | N |
| `McpSettings` | - | - | - | - | - | N |
| `SessionConfig` | - | - | - | - | via path | N (uses path import) |
| `TelegramConfig` | - | - | - | - | via re-export | Y |
| `McpClient` | Y | Y | Y | - | - | Y |
| `McpConfig` | - | - | - | - | - | N |
| `McpError` | - | - | - | - | - | N |
| `McpServerConfig` | - | - | - | - | - | N |
| `ToolDefinition` | - | - | - | - | - | N |
| `load_mcp_config` | Y | - | Y | - | - | Y |
| `Message` | Y | Y | - | via path | - | Y |
| `Role` | Y | Y | - | via path | - | Y |
| `ToolCallData` | - | - | - | - | - | N |
| `AnthropicProvider` | - | - | - | - | - | N |
| `DeepSeekProvider` | - | - | - | - | - | N |
| `LlmProvider` | - | Y | - | - | - | Y |
| `MockProvider` | - | - | - | - | - | N |
| `OpenAiProvider` | - | - | - | - | - | N |
| `ProviderError` | - | - | - | - | - | N |
| `StreamEvent` | Y | Y | - | - | - | Y |
| `create_provider` | Y | - | Y | - | - | Y |
| `Session` | Y | Y | - | via path | via path | Y |
| `SessionSummary` | - | - | Y | - | - | Y |
| `StoredMessage` | Y | Y | - | via re-export | via path | Y |
| `CleanupResult` | - | - | - | - | via path | N (uses path import) |
| `SessionStore` | - | Y | Y | via re-export | via path | Y |
| `SqliteStore` | - | - | - | - | - | N |
| `StorageError` | - | - | - | - | via path | N (uses path import) |
| `create_storage` | Y | - | Y | - | - | Y |

**Items to REMOVE from re-export (never imported via re-export by consumers):**
1. `ConfigError`
2. `LoggingConfig`
3. `McpSettings`
4. `SessionConfig`
5. `McpConfig`
6. `McpError`
7. `McpServerConfig`
8. `ToolDefinition`
9. `ToolCallData`
10. `AnthropicProvider`
11. `DeepSeekProvider`
12. `MockProvider`
13. `OpenAiProvider`
14. `ProviderError`
15. `CleanupResult`
16. `SqliteStore`
17. `StorageError`

That is 17 items to remove (PRD estimated ~16). Consumers that need these use path imports (`synapse_core::storage::StorageError`, etc.) which will still work since the modules remain `pub`.

### 7.4 Async Convention Violation

- **Location:** `synapse-core/src/storage/sqlite.rs` line 62: `std::fs::create_dir_all(parent)`.
- **Context:** Called inside `SqliteStore::new()` which is `async fn`.
- **Fix:** Replace with `tokio::fs::create_dir_all(parent).await`.
- **Dependency change:** Add `"fs"` to tokio features in `synapse-core/Cargo.toml`:
  ```toml
  tokio = { version = "1", features = ["rt", "macros", "process", "fs"] }
  ```

---

## 8. Existing Patterns and Conventions

### 8.1 Module System
- All modules use Rust 2018+ convention (no `mod.rs`). Verified across the entire codebase.

### 8.2 Error Handling
- `synapse-core`: `thiserror` enums, `?` propagation, no `unwrap()`/`expect()` in production code.
- CLI/Telegram: `anyhow` with `.context()`.

### 8.3 Testing
- Tests colocated in same file via `#[cfg(test)] mod tests`.
- Naming: `test_<function>_<scenario>`.
- Async tests: `#[tokio::test]`.

---

## 9. Deviations from Requirements

### 9.1 `repl.rs` Line Count

**PRD states:** "`repl.rs` is 1168 lines" and the phase doc says "678 prod lines."
**Actual:** `wc -l` reports 1168 lines total. The phase doc likely refers to lines excluding tests. Both are consistent.

### 9.2 Re-export Count

**PRD states:** "~24 items" and "remove ~16 items."
**Actual:** 33 items re-exported; 17 items can be removed. Slightly different from the PRD estimate but directionally correct.

### 9.3 No Other Deviations

All other PRD requirements match the current codebase exactly.

---

## 10. Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| Removing `StreamEvent::Error` breaks CLI match arms | Remove the match arm at the same time; the `Some(Err(e))` arm already handles errors from the stream. |
| OpenAI-compat extraction changes serialization | Run existing serialization tests against the new shared types to verify byte-identical JSON output. |
| `repl.rs` split breaks visibility | All submodules in `repl/` use `pub(crate)` or `pub(super)` as needed; `run_repl()` stays the single public entry point. |
| Removing re-exports breaks doc examples | Doc examples in core use `synapse_core::provider::MockProvider` (path import), not the re-export. Verified. |
| `Agent::from_config()` creates a tight coupling | `Config` and `create_provider` are already in `synapse-core`; this is internal coupling, not cross-crate. Acceptable. |
| `tracing` in `synapse-cli` requires subscriber init | Must add a minimal `tracing_subscriber::fmt().init()` in CLI `main()` or tracing macros from core will be silently dropped. |

---

## 11. Task Dependencies

Per PRD constraints:
1. **15.1** (dead code) must complete before **15.2** (OpenAI-compat extraction).
2. **15.2** should complete before **15.3** (constants, since `SSE_DONE_MARKER` goes in `openai_compat.rs`) and **15.4** (tracing, since the extracted module needs instrumentation).
3. **15.4** (tracing) should complete before **15.5** (shared utilities, since `init_mcp_client()` will use `tracing::warn!`).
4. **15.6** (file splitting) and **15.7** (API surface + async fix) are independent of each other but benefit from being last since earlier tasks may move code.

**Recommended order:** 15.1 -> 15.2 -> 15.3 -> 15.4 -> 15.5 -> 15.6 -> 15.7

---

## 12. Resolved Questions

No open questions from the PRD. All specifications are clear and validated against the codebase.
