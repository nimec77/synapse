# SY-14 Tasklist: System Prompt (Phase 13)

Status: IMPLEMENT_STEP_OK

## Context

Wire `config.system_prompt` through the `Agent` to all provider calls. The plumbing already
exists (`Role::System` enum variant, `Session.system_prompt` field, DB column `system_prompt TEXT`)
but nothing injects a system prompt today. This ticket adds a `system_prompt` field to `Config`,
adds `system_prompt` and a `with_system_prompt()` builder to `Agent`, implements a private
`build_messages()` helper that prepends a `Role::System` message on-the-fly before every provider
call, wires the config value into CLI and Telegram agent construction, and documents the field in
`config.example.toml`.

No deviations were identified — the plan confirms zero gaps between existing code and requirements.

---

## Tasks

### Task 1: Add `system_prompt` field to `Config` in `synapse-core/src/config.rs`

- [x] Add `system_prompt: Option<String>` to the `Config` struct with `#[serde(default)]` so it
  defaults to `None` when the field is absent from TOML.
- [x] Place the field after `model` and before `session` in the struct definition, matching the
  logical ordering in `config.example.toml`.
- [x] Add `system_prompt: None` to the `Config::default()` implementation.

**Acceptance criteria:**
- A TOML file containing `system_prompt = "You are helpful."` deserializes to
  `config.system_prompt == Some("You are helpful.".to_string())`.
- A TOML file without the `system_prompt` field deserializes to `config.system_prompt == None`
  (no parse error, no default value other than `None`).

---

### Task 2: Add unit tests for `Config.system_prompt` in `synapse-core/src/config.rs`

- [x] `test_config_with_system_prompt` — Parse TOML with `system_prompt = "You are helpful."`,
  verify `config.system_prompt == Some("You are helpful.".to_string())`.
- [x] `test_config_without_system_prompt` — Parse TOML without the field, verify
  `config.system_prompt == None`.
- [x] `test_config_default_system_prompt` — Verify `Config::default().system_prompt == None`.

**Acceptance criteria:**
- All three tests pass under `cargo test -p synapse-core`.
- No existing config tests regress.

---

### Task 3: Add `system_prompt` field and `with_system_prompt()` builder to `Agent`

- [x] Add `system_prompt: Option<String>` as a private field on the `Agent` struct in
  `synapse-core/src/agent.rs`.
- [x] Initialize `system_prompt: None` in `Agent::new()` so all existing call sites remain
  unchanged (no signature change to `Agent::new()`).
- [x] Implement `pub fn with_system_prompt(mut self, prompt: impl Into<String>) -> Self` as a
  builder method on `Agent`, setting `self.system_prompt = Some(prompt.into())`.
- [x] Update the `Agent` struct doc comment example to illustrate `with_system_prompt()` usage.

**Acceptance criteria:**
- Existing `Agent::new(provider, mcp_client)` call sites compile and work without modification.
- `Agent::new(provider, None).with_system_prompt("test")` compiles and sets the field to
  `Some("test".to_string())`.

---

### Task 4: Add unit tests for `Agent` builder in `synapse-core/src/agent.rs`

- [x] `test_agent_default_system_prompt_none` — Create agent with `Agent::new()`, verify
  `system_prompt` defaults to `None`.
- [x] `test_agent_with_system_prompt` — Create agent with `.with_system_prompt("test")`, verify
  the field is set to `Some("test".to_string())`.

**Acceptance criteria:**
- Both tests pass under `cargo test -p synapse-core`.
- The builder method is chainable (returns `Self`), consistent with `Session::with_system_prompt()`.

---

### Task 5: Implement `build_messages()` private helper in `synapse-core/src/agent.rs`

- [x] Implement `fn build_messages(&self, messages: &[Message]) -> Vec<Message>` as a private
  method on `Agent`.
- [x] When `self.system_prompt` is `Some(prompt)`, return a new `Vec<Message>` with
  `Message::new(Role::System, prompt)` prepended before all `messages`.
- [x] When `self.system_prompt` is `None`, return `messages.to_vec()` unchanged.
- [x] The original `messages` slice must never be mutated with the system message.

**Acceptance criteria:**
- `build_messages()` returns `[System("..."), ...original_messages]` when a system prompt is set.
- The original `messages` slice is unmodified after `build_messages()` is called.

---

### Task 6: Integrate `build_messages()` into `Agent::complete()`, `stream()`, and `stream_owned()`

- [x] In `Agent::complete()`: replace direct `messages` reference to provider with
  `self.build_messages(messages)` on each iteration of the tool call loop. Tool call results
  continue to be appended to the original `messages` (not to `provider_messages`).
- [x] In `Agent::stream()` (no-tools path): call `self.build_messages(messages)` to produce
  `provider_messages` before calling `self.provider.stream(&provider_messages)`.
- [x] In `Agent::stream_owned()` (no-tools path): call `self.build_messages(&messages)` to
  produce `provider_messages` before calling `self.provider.stream(&provider_messages)`.
- [x] When tools are active, `stream()` and `stream_owned()` already delegate to `complete()`,
  which handles `build_messages()` internally — no additional change needed for those paths.

**Acceptance criteria:**
- The system prompt is prepended on every provider call, including each iteration of the tool
  call loop.
- The system message is never accumulated in the `messages` vector passed between iterations,
  ensuring it is never stored in the database.

---

### Task 7: Add unit tests for `build_messages()` and `Agent::complete()` integration

- [x] `test_build_messages_with_system_prompt` — Agent with system prompt "You are helpful." and
  messages `[User("Hi")]`; verify result is `[System("You are helpful."), User("Hi")]`.
- [x] `test_build_messages_without_system_prompt` — Agent without system prompt; verify result
  equals the input messages unchanged.
- [x] `test_build_messages_preserves_original` — Agent with system prompt; call `build_messages()`
  on a slice; verify the original slice is unchanged.
- [x] `test_build_messages_with_history` — Agent with system prompt; input
  `[User("Q1"), Assistant("A1"), User("Q2")]`; verify result is
  `[System("..."), User("Q1"), Assistant("A1"), User("Q2")]`.
- [x] `test_agent_complete_with_system_prompt` — Use `MockProvider` to verify that `complete()`
  succeeds without errors when a system prompt is set.

**Acceptance criteria:**
- All five tests pass under `cargo test -p synapse-core`.
- `test_build_messages_preserves_original` explicitly confirms the original slice is not mutated.

---

### Task 8: Wire `config.system_prompt` into Agent construction in CLI and Telegram

- [x] In `synapse-cli/src/main.rs` (one-shot mode, approximately line 184): apply
  `.with_system_prompt(prompt)` conditionally when `config.system_prompt` is `Some`.
- [x] In `synapse-cli/src/repl.rs` (REPL mode, approximately line 498): apply
  `.with_system_prompt(prompt)` conditionally when `config.system_prompt` is `Some`.
- [x] In `synapse-telegram/src/main.rs` (approximately line 83): apply `.with_system_prompt(prompt)`
  conditionally when `config.system_prompt` is `Some`, before wrapping in `Arc`.

**Acceptance criteria:**
- When `system_prompt` is set in config, the CLI one-shot request includes the system prompt in
  the messages sent to the provider.
- When `system_prompt` is set in config, the REPL mode includes the system prompt on every
  provider call throughout the session.
- When `system_prompt` is set in config, the Telegram bot includes the system prompt on every
  `agent.complete()` call.

---

### Task 9: Update `config.example.toml` with `system_prompt` example

- [x] Add a commented `system_prompt` example entry after the `model` field and before the
  `[session]` section.
- [x] Include a comment explaining the field's purpose and advising conciseness to minimize
  token usage.

**Acceptance criteria:**
- `config.example.toml` contains a commented-out `system_prompt` example consistent with the
  `Config` struct field (`Option<String>`).
- The comment advises keeping the prompt concise to minimize token usage.

---

### Task 10: Pre-commit quality gate

- [x] Run `cargo fmt --check` — no formatting violations.
- [x] Run `cargo clippy -- -D warnings` — zero warnings across all crates.
- [x] Run `cargo test` — all tests pass, including all existing tests in all crates.

**Acceptance criteria:**
- All three commands exit with code 0.
- No regressions in existing `synapse-core`, `synapse-cli`, or `synapse-telegram` tests.
- Total new tests: 10 (3 config + 7 agent).
