# SY-20 Tasklist: Improve /history Command

**Ticket:** SY-20
**Status:** IMPLEMENT_STEP_OK
**Date:** 2026-02-26

## Context

Replace the full message dump in the Telegram `/history` command with a compact "last 10 messages"
view. All changes are confined to `synapse-telegram/src/commands.rs`. The implementation extracts
two pure helper functions (`truncate_content`, `format_history`) from the async handler so they can
be covered by unit tests.

---

## Tasks

### Task 1: Extract `truncate_content` helper function

- [x] Implement `fn truncate_content(content: &str, max_chars: usize) -> String` in
  `synapse-telegram/src/commands.rs`. If `content.chars().count() <= max_chars`, return
  `content.to_string()`. Otherwise return the first `max_chars` chars collected into a `String`
  followed by `"..."`.

**Acceptance criteria:**
- A call with content of exactly 150 chars and `max_chars = 150` returns the content unchanged
  with no `...` appended.
- A call with content of 151 chars and `max_chars = 150` returns a string of 153 chars (150 +
  three ASCII dots `...`).

---

### Task 2: Extract `format_history` helper function

- [x] Implement `fn format_history(messages: &[StoredMessage]) -> String` in
  `synapse-telegram/src/commands.rs`. The function must:
  1. Filter the slice to retain only `Role::User` and `Role::Assistant` messages.
  2. Compute `skip = filtered.len().saturating_sub(10)` and slice to `&filtered[skip..]`.
  3. For each remaining message: map role to `"You"` / `"Assistant"`, format timestamp as
     `%Y-%m-%d %H:%M`, call `truncate_content(&m.content, 150)`, append
     `"[role] timestamp\ncontent\n\n"` to the output string.
  4. Return the accumulated string (empty string if no messages pass the role filter).

**Acceptance criteria:**
- Passing messages with all four roles (`User`, `Assistant`, `System`, `Tool`) produces output
  containing only `"You"` and `"Assistant"` role labels — never `"System"` or `"Tool"`.
- Passing 15 `User`/`Assistant` messages returns output containing exactly the last 10 messages
  (the first 5 are absent).

---

### Task 3: Refactor `cmd_history` to delegate to `format_history`

- [x] In `synapse-telegram/src/commands.rs`, replace the `if messages.is_empty()` check and the
  inline `for m in &messages` formatting loop inside `cmd_history` with:
  ```rust
  let output = format_history(&messages);
  if output.is_empty() {
      bot.send_message(msg.chat.id, "No messages in current session.")
          .await?;
      return Ok(());
  }
  ```
  Keep the session-lookup logic and the `chunk_message(output.trim())` sending loop unchanged.

**Acceptance criteria:**
- `/history` on a session containing only `System` and `Tool` messages replies with
  `"No messages in current session."`.
- `/history` on a session with `User` and `Assistant` messages sends the formatted output
  (role labels `"You"` and `"Assistant"`, no `"System"` or `"Tool"`).

---

### Task 4: Update `Command::History` description

- [x] Change the `Command::History` variant description in `synapse-telegram/src/commands.rs`
  from `"Show conversation history"` to `"Show recent messages"`.

**Acceptance criteria:**
- The `Command::History` variant is annotated with
  `#[command(description = "Show recent messages")]`.
- The `/help` command output (derived from the description attribute) reads
  `"Show recent messages"` for the `/history` entry.

---

### Task 5: Add unit tests for `truncate_content`

- [x] Add a `make_stored_message(role: Role, content: &str) -> StoredMessage` test helper
  (analogous to the existing `make_session` helper) in the `#[cfg(test)]` module.
- [x] Add the following tests in `synapse-telegram/src/commands.rs`:
  - `test_truncate_content_short` — 10-char content returns unchanged, no `...`.
  - `test_truncate_content_exact_limit` — exactly 150-char content returns unchanged, no `...`.
  - `test_truncate_content_over_limit` — 151-char content returns first 150 chars + `...`.
  - `test_truncate_content_long` — 500-char content; output is 153 chars and ends with `...`.
  - `test_truncate_content_empty` — empty string returns empty string, no `...`.

**Acceptance criteria:**
- All five tests pass under `cargo test -p synapse-telegram`.
- The exact-150-char test asserts the result has no trailing `...`.

---

### Task 6: Add unit tests for `format_history`

- [x] Add the following tests in `synapse-telegram/src/commands.rs`:
  - `test_format_history_filters_system_and_tool` — all four roles input; output contains only
    `"You"` and `"Assistant"`, not `"System"` or `"Tool"`.
  - `test_format_history_keeps_user_and_assistant` — 3 User + 3 Assistant messages; all 6 appear
    in output.
  - `test_format_history_last_10_limit` — 15 User/Assistant messages; only the last 10 appear
    (first 5 are absent by content).
  - `test_format_history_fewer_than_10` — 3 User/Assistant messages; all 3 appear in output.
  - `test_format_history_empty` — only System and Tool messages; returns empty string `""`.
  - `test_format_history_truncates_long_content` — Assistant message with 200-char content;
    formatted output contains `...` and the content portion does not exceed 153 chars.

**Acceptance criteria:**
- All six tests pass under `cargo test -p synapse-telegram`.
- The last-10-limit test explicitly asserts the content of message 1 is absent and message 6 is
  present (i.e., the correct 10 are chosen).

---

### Task 7: Verify documentation (no file changes)

- [x] Read `CLAUDE.md` and confirm the Workspace Crates table describes `/history` as
  "(last 10 messages, truncated to 150 chars)".
- [x] Read `README.md` and confirm the commands table row for `/history` reads
  `"Show recent messages from the current session"`.
- [x] Read `CHANGELOG.md` and confirm the `[Unreleased]` section contains the entry:
  `- /history now shows the last 10 user/assistant messages (truncated to 150 chars) instead of
  dumping the full conversation.`

**Acceptance criteria:**
- All three documentation files already match the target state and require no edits.

---

### Task 8: Pre-commit gate

- [x] Run `cargo fmt --check && cargo clippy -- -D warnings && cargo test` and confirm all checks
  pass with zero warnings or errors.

**Acceptance criteria:**
- `cargo fmt --check` exits with code 0 (no formatting issues).
- `cargo clippy -- -D warnings` exits with code 0 (no warnings).
- `cargo test` passes all tests, including the 11 new unit tests added in Tasks 5 and 6.
