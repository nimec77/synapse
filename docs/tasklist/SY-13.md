# SY-13 Tasklist: Telegram Bot (Phase 12)

Status: IMPLEMENT_STEP_OK

## Context

Implement the Telegram bot interface for Synapse using `teloxide`, wired to `synapse-core` Agent,
SessionStore, and MCP subsystems. The `synapse-telegram` crate is currently an empty placeholder.
This ticket brings it to life, validating the hexagonal architecture by proving a second frontend
can share all core business logic without modification.

All deviations identified in the plan (D1-D7) must be resolved.

---

## Tasks

### Task 1: Add `TelegramConfig` to `synapse-core/src/config.rs`

- [x] Add `TelegramConfig` struct with `token: Option<String>` and `allowed_users: Vec<u64>`.
- [x] Add `Default` impl for `TelegramConfig` (token: None, allowed_users: vec![]).
- [x] Add `pub telegram: Option<TelegramConfig>` field with `#[serde(default)]` to `Config`.
- [x] Update `Config::default()` to set `telegram: None`.

**Acceptance criteria:**
- A config file without a `[telegram]` section deserializes successfully with `telegram: None`.
- `TelegramConfig::default()` produces `token: None` and an empty `allowed_users` vec.

---

### Task 2: Export `TelegramConfig` from `synapse-core/src/lib.rs`

- [x] Add `TelegramConfig` to the `pub use config::{...}` re-export line in `lib.rs`.

**Acceptance criteria:**
- `synapse_core::TelegramConfig` is accessible from downstream crates without importing the
  submodule directly.

---

### Task 3: Add unit tests for `TelegramConfig` in `synapse-core/src/config.rs`

- [x] `test_config_without_telegram_section` — Config without `[telegram]` section has `telegram: None`.
- [x] `test_config_with_telegram_section` — Config with `[telegram]` section parses token and allowed_users correctly.
- [x] `test_config_telegram_partial_defaults` — Config with only `token` set defaults `allowed_users` to empty vec.
- [x] `test_telegram_config_default` — `TelegramConfig::default()` has `token: None` and empty `allowed_users`.

**Acceptance criteria:**
- All four tests pass under `cargo test -p synapse-core`.
- No existing config tests regress.

---

### Task 4: Add dependencies to `synapse-telegram/Cargo.toml`

- [x] Add `synapse-core` (path dependency), `teloxide` (with `macros` feature), `tokio`
  (`rt-multi-thread`, `macros`), `anyhow`, `futures`, `uuid` (`v4`, `v7`), `tracing`,
  `tracing-subscriber` (`env-filter`).

**Acceptance criteria:**
- `cargo build -p synapse-telegram` succeeds after dependency addition.
- No `mod.rs` files introduced; dependencies follow conventions.md (anyhow for interface crates).

---

### Task 5: Rewrite `synapse-telegram/src/main.rs` — bot entry point

- [x] Initialize tracing with `tracing_subscriber::fmt()` and `RUST_LOG`/`synapse_telegram=info` filter.
- [x] Load config via `Config::load()`.
- [x] Resolve bot token via `resolve_bot_token()` (env var `TELEGRAM_BOT_TOKEN` > config file token).
- [x] Ensure bot token is never passed to any tracing macro.
- [x] Create `Bot::new(token)`.
- [x] Create storage via `create_storage()`, run auto-cleanup.
- [x] Create provider via `create_provider(&config)`.
- [x] Initialize MCP client.
- [x] Create `Agent` and wrap in `Arc`.
- [x] Rebuild chat-to-session map from existing sessions via `rebuild_chat_map()`.
- [x] Wrap shared state (`Config`, `Agent`, storage, chat map) in `Arc` / `Arc<RwLock<...>>`.
- [x] Set up `Dispatcher` with `Update::filter_message()` endpoint and `dptree` dependency injection.
- [x] Enable Ctrl+C handler via `enable_ctrlc_handler()`.
- [x] Attempt graceful `Agent::shutdown()` after dispatcher stops using `Arc::try_unwrap()`.

**Acceptance criteria:**
- Bot starts successfully when `TELEGRAM_BOT_TOKEN` is set; exits with clear error message when
  neither env var nor config token is present.
- Token is not visible in any log output at any log level.

---

### Task 6: Implement `resolve_bot_token()` in `main.rs`

- [x] Return env var value if `TELEGRAM_BOT_TOKEN` is set and non-empty.
- [x] Fall through to `config.telegram.as_ref().and_then(|t| t.token.clone())`.
- [x] Return `Err` with message `"Bot token required: set TELEGRAM_BOT_TOKEN env var or telegram.token in config"` when neither source is available.

**Acceptance criteria:**
- Env var takes priority over config token.
- An empty env var (`""`) falls through to the config token.
- Missing both sources produces a descriptive `anyhow::Error`.

---

### Task 7: Create `synapse-telegram/src/handlers.rs` — message handler

- [x] Define `handle_message()` with the correct teloxide endpoint signature (Bot, Message, Arc<Config>,
  Arc<Agent>, Arc<Box<dyn SessionStore>>, ChatSessionMap).
- [x] Implement user authorization as the first check: extract `msg.from().map(|u| u.id.0)`,
  check against `allowed_users`; silent drop (`return Ok(())`) if not authorized.
- [x] Implement session-per-chat lookup: check `chat_map` for existing session ID.
- [x] Create new session with name `"tg:<chat_id>"` when none exists; use write-lock double-check
  to prevent races.
- [x] Call `storage.touch_session(id)` for existing sessions.
- [x] Load conversation history from storage, build `Vec<Message>`, append new user message.
- [x] Store user message in database before calling agent.
- [x] Send `ChatAction::Typing` indicator before calling agent.
- [x] Call `agent.complete(&mut messages)` to get full response (including MCP tool loop).
- [x] Store assistant response in database.
- [x] Chunk response at paragraph/newline/space boundaries when exceeding 4096 characters.
- [x] Send each chunk as a separate `bot.send_message()` call.
- [x] On agent error: log via `tracing::error!` and send generic user-friendly message to chat.

**Acceptance criteria:**
- Authorized users receive LLM responses; unauthorized users receive no reply whatsoever.
- Responses longer than 4096 characters are split and sent as multiple Telegram messages.

---

### Task 8: Implement `rebuild_chat_map()` in `main.rs`

- [x] Call `storage.list_sessions().await.unwrap_or_default()`.
- [x] Filter sessions whose `name` starts with `"tg:"` and parse the suffix as `i64` chat ID.
- [x] Return `HashMap<i64, Uuid>` mapping chat IDs to session UUIDs.

**Acceptance criteria:**
- Sessions named `"tg:<chat_id>"` are correctly mapped after a bot restart.
- Sessions without the `"tg:"` prefix are ignored (no panic, no incorrect mapping).

---

### Task 9: Implement `chunk_message()` helper

- [x] Return a single slice when text length is <= 4096 characters.
- [x] Split at paragraph boundaries (`\n\n`), then newline (`\n`), then space when text exceeds 4096
  characters, ensuring no chunk exceeds the limit.

**Acceptance criteria:**
- A message of <= 4096 chars returns exactly one chunk.
- A message of > 4096 chars returns multiple chunks, each <= 4096 chars.

---

### Task 10: Declare `handlers` module in `main.rs`

- [x] Add `mod handlers;` in `main.rs` (no `mod.rs` file — new module system).

**Acceptance criteria:**
- `cargo build -p synapse-telegram` compiles without module errors.
- No `handlers/mod.rs` file exists.

---

### Task 11: Add unit tests in `synapse-telegram`

- [x] Authorization tests:
  - `test_is_authorized_user_in_list` — user in `allowed_users` returns authorized.
  - `test_is_authorized_user_not_in_list` — user absent from list is rejected.
  - `test_is_authorized_empty_list` — empty list rejects all users.
- [x] Token resolution tests:
  - `test_resolve_token_env_var` — env var takes priority over config value.
  - `test_resolve_token_config` — config value used when env var absent.
  - `test_resolve_token_none` — error returned when neither source is set.
  - `test_resolve_token_empty_env_var` — empty env var falls through to config.
- [x] Message chunking tests:
  - `test_chunk_short_message` — message under 4096 chars returns single chunk.
  - `test_chunk_long_message` — message over 4096 chars split into multiple chunks within limit.
  - `test_chunk_at_boundary` — split prefers paragraph/newline boundaries.
- [x] Chat map reconstruction tests:
  - `test_rebuild_chat_map_empty` — no sessions produces empty map.
  - `test_rebuild_chat_map_with_telegram_sessions` — `tg:`-prefixed sessions parsed correctly.
  - `test_rebuild_chat_map_ignores_non_telegram` — non-`tg:` sessions are ignored.

**Acceptance criteria:**
- All ~12 tests pass under `cargo test -p synapse-telegram`.
- Each test name follows the `test_<function>_<scenario>` convention.

---

### Task 12: Update `config.example.toml` with `[telegram]` section

- [x] Add commented-out `[telegram]` section with `token` and `allowed_users` examples.
- [x] Include warning comment: never commit bot token; use env var for production.
- [x] Include instructions for finding user ID via `@userinfobot`.

**Acceptance criteria:**
- `config.example.toml` contains a `[telegram]` block (commented out) after the change.
- The example is consistent with the `TelegramConfig` struct fields.

---

### Task 13: Pre-commit quality gate

- [x] Run `cargo fmt --check` — no formatting violations.
- [x] Run `cargo clippy -- -D warnings` — zero warnings.
- [x] Run `cargo test` — all tests pass, including existing tests in all crates.

**Acceptance criteria:**
- All three commands exit with code 0.
- No regressions in existing `synapse-core` or `synapse-cli` tests.

---

## Review Fixes

- [x] **RF1: Fix `is_authorized` dead code causing `cargo clippy -- -D warnings` failure**
  - The function `is_authorized()` in `synapse-telegram/src/handlers.rs` is defined and tested but
    never called in production code. The authorization check is inlined in `handle_message()`.
    Either call `is_authorized()` from `handle_message()` (replacing the inline logic), or remove
    the standalone function and restructure tests accordingly.
  - **Acceptance:** `cargo clippy -- -D warnings` exits with code 0 (zero warnings/errors).
