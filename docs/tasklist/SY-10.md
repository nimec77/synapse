# SY-10 Tasklist: CLI REPL (Phase 9)

Status: TASKLIST_READY

## Context

Implement an interactive REPL mode for the Synapse CLI using `ratatui` + `crossterm`. The REPL supports multi-turn conversations with streaming responses, session persistence, and session resume.

## Tasks

- [ ] **Task 1: Add `ratatui` and `crossterm` dependencies**
  Add `ratatui` and `crossterm` (with `event-stream` feature) to `synapse-cli/Cargo.toml`.
  - **AC1:** `ratatui` is listed as a dependency in `synapse-cli/Cargo.toml`.
  - **AC2:** `crossterm` is listed with the `event-stream` feature enabled.

- [ ] **Task 2: Add `--repl` flag to CLI args**
  Add a `--repl` / `-r` flag to the `Args` struct in `synapse-cli/src/main.rs` and route to `repl::run_repl()` when set. Add `mod repl;` declaration.
  - **AC1:** `synapse --repl` is accepted by the CLI argument parser (clap tests pass).
  - **AC2:** When `--repl` is set, `main()` calls `repl::run_repl()` with config, provider, storage, and optional session ID.

- [ ] **Task 3: Implement TerminalGuard for cleanup safety**
  Create `synapse-cli/src/repl.rs` with a `TerminalGuard` struct that enables raw mode and enters alternate screen on creation, and restores terminal state on `Drop`.
  - **AC1:** `TerminalGuard::new()` enables raw mode and enters alternate screen.
  - **AC2:** Dropping `TerminalGuard` disables raw mode and leaves alternate screen, ensuring terminal is restored on normal exit, error, or panic.

- [ ] **Task 4: Implement ReplApp state and UI rendering**
  Create the `ReplApp` struct holding conversation messages, input buffer, cursor position, scroll offset, streaming state, session ID, and status message. Implement `ratatui` rendering with three-area vertical layout: scrollable history, input area, status bar.
  - **AC1:** `ReplApp` struct holds all state fields as specified in the plan (messages, input, cursor_position, scroll_offset, is_streaming, session_id, status_message).
  - **AC2:** UI renders three areas: scrollable conversation history with role labels, input area with cursor, and status bar with session/provider info.

- [ ] **Task 5: Implement key handling and input editing**
  Handle keyboard events: Enter (submit), Backspace (delete), Left/Right (cursor movement), Home/End (jump), Ctrl+C (exit), Up/Down/PageUp/PageDown (scroll history). Parse `/quit` command.
  - **AC1:** All key bindings from the plan are handled (Enter, Backspace, Left/Right, Home/End, Ctrl+C, Up/Down, PageUp/PageDown).
  - **AC2:** Typing `/quit` and pressing Enter exits the REPL cleanly.

- [ ] **Task 6: Implement async event loop with streaming**
  Implement the `run_repl()` public entry point with a `tokio::select!` event loop that handles both terminal key events (via crossterm `EventStream`) and LLM stream events. Streaming tokens render to the history area as they arrive.
  - **AC1:** `run_repl()` enters an async event loop using `tokio::select!` with crossterm `EventStream` and provider stream.
  - **AC2:** LLM streaming responses display token-by-token in the conversation history area.

- [ ] **Task 7: Implement session persistence in REPL**
  On user message submit: store user message to session storage, build full message vec, call `provider.stream()`. On stream completion: store assistant message, touch session. On REPL exit: print session ID to stderr.
  - **AC1:** Each user and assistant message is persisted to `SessionStore` during the conversation.
  - **AC2:** On REPL exit, the session ID is printed to stderr so the user can resume later.

- [ ] **Task 8: Implement session resume (`--repl --session <id>`)**
  When `session_id` is `Some`, load the session and its message history from storage, populate `ReplApp.messages` for display, and provide conversation context to the LLM.
  - **AC1:** `synapse --repl --session <uuid>` loads the existing session and displays previous conversation history.
  - **AC2:** The LLM receives the full conversation history so it can continue the conversation contextually.

- [ ] **Task 9: Add unit tests**
  Write unit tests for `ReplApp` state management (input handling, cursor movement, message formatting), command parsing (`/quit` detection), and clap `--repl` flag parsing.
  - **AC1:** Tests cover input editing (insert char, backspace, cursor movement) and command parsing.
  - **AC2:** Tests cover `--repl` flag parsing including combination with `--session`.
