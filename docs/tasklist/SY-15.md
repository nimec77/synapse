# SY-15 Tasklist: Phase 14 — File Logging

Status: IMPLEMENT_STEP_OK

## Context

Add file-based logging with automatic rotation to `synapse-telegram`. A `LoggingConfig` struct is defined
in `synapse-core/src/config.rs` and deserialized from an optional `[logging]` TOML section. The Telegram
bot's tracing initialization is rewritten to use a layered subscriber (stdout + rolling file appender via
`tracing-appender`). Omitting `[logging]` preserves current stdout-only behavior. `synapse-cli` is
completely unaffected.

Implementation order: Task 14.1 and Task 14.2 are independent and can be done in parallel. Task 14.3
depends on both. Tasks 14.4 and 14.5 are verification/documentation and are done last.

---

## Tasks

- [x] **14.1 — Add `LoggingConfig` to `synapse-core/src/config.rs`**

  Add the `LoggingConfig` struct with three fields (`directory: String`, `max_files: usize`,
  `rotation: String`) and their serde default functions (`default_log_directory()`,
  `default_max_files()`, `default_rotation()`). Add a `Default` impl. Add `logging: Option<LoggingConfig>`
  (with `#[serde(default)]`) to the `Config` struct after the `telegram` field. Add `logging: None` to
  `Config::default()`. Update `synapse-core/src/lib.rs` to re-export `LoggingConfig` alongside the
  existing config types.

  **Acceptance criteria:**
  - `LoggingConfig::default()` returns `directory = "logs"`, `max_files = 7`, `rotation = "daily"`.
  - `Config` parsed from TOML without a `[logging]` section has `config.logging == None`; parsed with
    `[logging]` has `config.logging == Some(LoggingConfig { ... })` with field values matching the TOML.

- [x] **14.2 — Add `tracing-appender` and `registry` feature to `synapse-telegram/Cargo.toml`**

  Add `tracing-appender = "0.2"` as a dependency. Add `"registry"` to the feature list of
  `tracing-subscriber` so the `tracing_subscriber::registry()` layered-subscriber API is available.

  **Acceptance criteria:**
  - `cargo build -p synapse-telegram` succeeds with `tracing-appender` resolved and the `registry`
    feature enabled on `tracing-subscriber`.
  - No new dependencies are added to `synapse-core/Cargo.toml`.

- [x] **14.3 — Rewrite tracing initialization in `synapse-telegram/src/main.rs`**

  Reorder `main()` so config is loaded before tracing is initialized. Extract tracing setup into a private
  `init_tracing(config: &Config) -> anyhow::Result<Option<WorkerGuard>>` helper. When `config.logging` is
  `None`, use the current stdout-only `tracing_subscriber::fmt()` path and return `Ok(None)`. When
  `config.logging` is `Some(lc)`: call `std::fs::create_dir_all(&lc.directory)` (falling back to
  stdout-only on failure); map the rotation string to `Rotation::DAILY / HOURLY / NEVER` (unknown values
  fall back to `DAILY` with an `eprintln!` warning); build a `RollingFileAppender` with
  `.filename_prefix("synapse-telegram")` and `.max_log_files(lc.max_files)`; wrap it in
  `tracing_appender::non_blocking`; build a `tracing_subscriber::registry()` with an `EnvFilter` layer,
  a stdout `fmt` layer, and a file `fmt` layer (`.with_ansi(false)`); call `.init()`; return
  `Ok(Some(guard))`. Store the returned guard as `let _guard = init_tracing(&config)?;` in `main()` before
  the dispatcher loop.

  **Acceptance criteria:**
  - Starting the bot with `[logging]` in config creates the configured directory (if absent) and writes
    log output to `<directory>/synapse-telegram.YYYY-MM-DD.log` while also printing to stdout.
  - Starting the bot without `[logging]` produces exactly the same stdout-only behavior as before this
    change (no file I/O, no guard allocated).

- [x] **14.4 — Verify `config.example.toml` `[logging]` section**

  Confirm the `[logging]` section (lines 70–80) already documents `directory`, `max_files`, and
  `rotation` with their defaults and valid values. No code change is expected; this task is a
  verification gate.

  **Acceptance criteria:**
  - `config.example.toml` contains a commented `[logging]` section documenting all three fields with
    their defaults and valid `rotation` values (`"daily"`, `"hourly"`, `"never"`).

- [x] **14.5 — Add unit tests for `LoggingConfig` and update `docs/tasklist.md`**

  Add five unit tests inside `synapse-core/src/config.rs`:
  1. `test_logging_config_defaults` — `LoggingConfig::default()` fields match expected defaults.
  2. `test_config_without_logging_section` — TOML without `[logging]` gives `config.logging.is_none()`.
  3. `test_config_with_logging_section` — TOML with all three custom fields parses correctly.
  4. `test_config_with_logging_section_partial_defaults` — TOML with only `directory` gives default
     `max_files` and `rotation`.
  5. `test_config_with_empty_logging_section` — TOML with just `[logging]` gives all defaults.

  After implementation, update `docs/tasklist.md`: check off tasks 14.1–14.5 and set the Phase 14 row
  status to "Complete".

  **Acceptance criteria:**
  - `cargo test -p synapse-core` passes with all five new tests reporting success.
  - `docs/tasklist.md` shows Phase 14 as complete with all sub-tasks checked.
