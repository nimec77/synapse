# SY-21 Tasklist: Code Refactoring II

**Ticket:** SY-21
**Status:** IMPLEMENT_STEP_OK
**Date:** 2026-02-27

## Context

Internal refactoring pass eliminating duplication, dead code, magic values, and type safety gaps
accumulated since SY-16. Eight tasks cover truncation unification, provider consolidation, CLI
session helper deduplication, Telegram code deduplication, dead code removal, type safety
improvements, small polish items, and module splits. Zero external behaviour changes.

---

## Tasks

- [x] **Task 21.1: Unify truncation into `synapse-core/src/text.rs`**

  Create `synapse-core/src/text.rs` with `pub fn truncate(s: &str, max_chars: usize) -> String`
  using char-safe `.chars()` iteration and a `max_chars <= 3` guard. Declare `pub mod text;` in
  `synapse-core/src/lib.rs`. Delete the local `truncate` function from
  `synapse-cli/src/commands.rs`, delete `truncate_content` from
  `synapse-telegram/src/commands.rs`, replace inline char-truncation in
  `synapse-core/src/storage/sqlite.rs` with the shared call, and delete the duplicate
  `test_truncate` test from `synapse-cli/src/main.rs`. Move all truncation tests into `text.rs`.

  **Acceptance criteria:**
  - `synapse-core/src/text.rs` exists and exports `truncate`; no other truncation functions or
    inline truncation patterns exist in `commands.rs`, `sqlite.rs`, or `main.rs`.
  - `cargo clippy -- -D warnings && cargo test` pass with all tests green.

- [x] **Task 21.2: Consolidate OpenAI-compatible providers**

  Add `pub(super) struct OpenAiCompatProvider` to `synapse-core/src/provider/openai_compat.rs`
  with fields `client`, `base_url`, `api_key`, `model`, `max_tokens` and a `new()` constructor.
  Implement all `LlmProvider` methods (`complete`, `complete_with_tools`, `stream`) on
  `OpenAiCompatProvider` using the existing shared helpers. Rewrite `deepseek.rs` as
  `pub struct DeepSeekProvider(OpenAiCompatProvider)` and `openai.rs` as
  `pub struct OpenAiProvider(OpenAiCompatProvider)`, each delegating all trait methods to the
  inner type via `self.0`. Update `factory.rs` construction calls accordingly.

  **Acceptance criteria:**
  - `deepseek.rs` and `openai.rs` are newtypes with no duplicated `LlmProvider` method bodies;
    all trait methods delegate to the inner `OpenAiCompatProvider`.
  - All existing provider tests pass; `cargo clippy -- -D warnings && cargo test` pass.

- [x] **Task 21.3: Deduplicate CLI session helpers**

  Create `synapse-cli/src/session.rs` with two public async functions:
  `init_storage(session_config: &SessionConfig) -> Result<Box<dyn SessionStore>>` (creates
  storage and runs auto-cleanup if configured) and
  `load_or_create_session(storage: &dyn SessionStore, config: &Config, session_id: Option<Uuid>) -> Result<(Session, Vec<StoredMessage>)>`
  (loads an existing session by ID or creates a new one). Declare `mod session;` in
  `synapse-cli/src/main.rs`. Refactor the REPL path and one-shot path in `main.rs` and
  `synapse-cli/src/repl.rs` to use these shared helpers instead of duplicated inline logic.

  **Acceptance criteria:**
  - `synapse-cli/src/session.rs` exists and exports both helpers; storage init and
    session-load-or-create logic appears in exactly one place in the CLI crate.
  - `cargo build && cargo test` pass with no regressions in CLI behaviour.

- [x] **Task 21.4: Deduplicate Telegram code**

  In `synapse-telegram/src/handlers.rs`, add:
  - `pub const NO_SESSIONS_HINT: &str` constant replacing 6 duplicate "No sessions" strings in
    `commands.rs`.
  - `pub fn tg_session_name(chat_id: i64) -> String` replacing 3 `format!("tg:{}")` occurrences.
  - `pub async fn check_auth(msg, config) -> Option<ResponseResult<()>>` replacing 3 inline auth
    blocks in `handle_message`, `handle_command`, and `handle_callback`.

  In `synapse-telegram/src/format.rs`, keep the single `TELEGRAM_MSG_LIMIT` definition and make
  it `pub`. In `synapse-telegram/src/handlers.rs`, delete the duplicate `TELEGRAM_MSG_LIMIT` and
  import from `crate::format`. In `synapse-telegram/src/commands.rs`, merge
  `cmd_switch_keyboard` and `cmd_delete_keyboard` into a single `build_action_keyboard` function,
  and refactor `cmd_list` to call `fetch_chat_sessions` instead of duplicating session-fetch
  logic.

  **Acceptance criteria:**
  - `NO_SESSIONS_HINT` appears in exactly one definition; `tg_session_name` is called in all
    three former `format!("tg:{}")` sites; `TELEGRAM_MSG_LIMIT` has exactly one definition.
  - `cargo clippy -- -D warnings && cargo test` pass.

- [x] **Task 21.5: Remove dead code and extract named constants**

  Remove `stream_with_tools()` from the `LlmProvider` trait in `synapse-core/src/provider.rs`
  (delete the default implementation and any overrides in `anthropic.rs`, `mock.rs`, or
  `openai_compat.rs`). Extract named constants in `synapse-telegram/src/commands.rs`:
  `HISTORY_MESSAGE_LIMIT: usize = 10`, `HISTORY_TRUNCATE_CHARS: usize = 150`,
  `LIST_PREVIEW_MAX_CHARS: usize = 40`, `KEYBOARD_PREVIEW_MAX_CHARS: usize = 20`. Extract
  `SESSION_PREVIEW_MAX_CHARS: usize = 50` in `synapse-core/src/storage/sqlite.rs`. Update
  `CLAUDE.md` and `README.md` to remove all `stream_with_tools` references.

  **Acceptance criteria:**
  - `stream_with_tools` does not appear anywhere in the codebase (trait, implementations, or
    docs) after this task.
  - All magic number literals for preview/history limits are replaced by the named constants;
    `cargo clippy -- -D warnings && cargo test` pass.

- [x] **Task 21.6: Improve type safety**

  In `synapse-core/src/config.rs`, add a `Rotation` enum with variants `Daily`, `Hourly`,
  `Never`, deriving `Debug, Clone, PartialEq, Deserialize` with
  `#[serde(rename_all = "lowercase")]`. Change `LoggingConfig.rotation` from `String` to
  `Rotation`. Update `default_rotation()` to return `Rotation::Daily`. Add deserialization unit
  tests for all three variants. Update the rotation match site in
  `synapse-telegram/src/main.rs` to use enum variants instead of string arms, removing the
  catch-all arm. Replace all `Arc<Box<dyn SessionStore>>` occurrences (15 across
  `synapse-telegram/src/main.rs`, `handlers.rs`, `commands.rs`) with `Arc<dyn SessionStore>`,
  using `Arc::from(create_storage(...).await?)` for construction.

  **Acceptance criteria:**
  - `LoggingConfig.rotation` has type `Rotation` (not `String`); existing config files with
    `"daily"`, `"hourly"`, `"never"` strings still deserialize correctly (verified by tests).
  - Zero occurrences of `Arc<Box<dyn SessionStore>>` remain in the Telegram crate;
    `cargo clippy -- -D warnings && cargo test` pass.

- [x] **Task 21.7: Apply small polish**

  In `synapse-cli/src/repl/render.rs`, extract named constants `REPL_MIN_HISTORY_HEIGHT: u16`,
  `REPL_INPUT_HEIGHT: u16`, `REPL_STATUS_HEIGHT: u16` and use them in the `Layout::vertical`
  call and in `repl.rs` where the layout is computed. In
  `synapse-telegram/src/handlers.rs`, add `impl ChatSessions { pub fn new(session_id: Uuid) -> Self }` constructor and replace all single-session struct literal constructions (`ChatSessions { sessions: vec![id], active_idx: 0 }`) in `handlers.rs`, `commands.rs`, and `main.rs` with
  `ChatSessions::new(id)`. In `synapse-telegram/src/commands.rs`, replace the 4
  `Ok(r) | Err(r) => r` patterns with `.unwrap_or_else(|e| e)`.

  **Acceptance criteria:**
  - No inline numeric layout constants remain in `render.rs` for the three height values; all
    single-session `ChatSessions` struct literals are replaced by `ChatSessions::new(id)`.
  - `cargo clippy -- -D warnings && cargo test` pass.

- [x] **Task 21.8: Split large modules**

  Split `synapse-telegram/src/commands.rs` into `commands.rs` (slash command handlers and
  helpers) and `commands/keyboard.rs` (keyboard builders, callback logic: `build_action_keyboard`,
  `build_session_keyboard`, `parse_callback_data`, `do_switch`, `do_delete`, `handle_callback`,
  `fetch_chat_sessions`). Split `synapse-telegram/src/format.rs` into `format.rs`
  (`md_to_telegram_html`, `escape_html`) and `format/chunk.rs` (`TELEGRAM_MSG_LIMIT`, `OpenTag`,
  `chunk_html`, `floor_char_boundary`, `find_split_point`, `update_open_tags`). Split
  `synapse-core/src/provider/anthropic.rs` into `anthropic.rs` (provider impl) and
  `anthropic/types.rs` (serde request/response structs: `ApiRequest`, `AnthropicTool`,
  `ApiContent`, `ApiMessage`, `ApiResponse`, `ContentBlock`, `ApiError`, `ErrorDetail`). Use
  `mod keyboard;`, `mod chunk;`, `mod types;` declarations in parent files with appropriate
  re-exports. No `mod.rs` files.

  **Acceptance criteria:**
  - All three module splits are in place using the Rust 2018+ convention (no `mod.rs` files);
    all previously-public symbols remain accessible from their original paths via re-exports.
  - `cargo build && cargo test` pass after each individual split.

---

## Task Order and Dependencies

```
21.1 (Unify truncation)
  |
  +--> 21.2 (Consolidate providers)    [independent]
  |
  +--> 21.3 (CLI session helpers)      [independent]
  |
  v
21.4 (Telegram dedup)                  [uses truncate from 21.1]
  |
  v
21.5 (Dead code + constants)           [must complete before 21.8]
  |
  v
21.6 (Type safety)                     [must complete before 21.8]
  |
  v
21.7 (Small polish)                    [depends on 21.4, 21.6]
  |
  v
21.8 (Split large modules)             [depends on 21.5, 21.6]
```

Recommended sequential order: **21.1 -> 21.2 -> 21.3 -> 21.4 -> 21.5 -> 21.6 -> 21.7 -> 21.8**

Pre-commit gate after every task: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`
