# SY-19 Tasklist: Telegram Command Fixes & Interactive Keyboards

**Ticket:** SY-19
**Status:** IMPLEMENT_STEP_OK

## Context

SY-19 fixes the command fall-through bug where `/switch` and `/delete` without arguments silently
forward to the LLM (because `Switch(usize)` / `Delete(usize)` fail to parse empty strings). The
fix changes those enum variants to `String`, adds `parse_session_arg()` to triage arguments, adds
a `/start` welcome command, adds a defensive guard in `handle_message`, introduces inline keyboards
for argumentless `/switch` and `/delete`, and adds a `CallbackQuery` dispatcher branch to handle
button taps. All changes are confined to `synapse-telegram`.

---

## Tasks

### Task 1: Change Command enum types and add `parse_session_arg` (`commands.rs`)

- [x] Change `Switch(usize)` to `Switch(String)` and `Delete(usize)` to `Delete(String)` in the
  `Command` enum.
- [x] Add `parse_session_arg(arg: &str) -> Result<Option<usize>, String>`:
  - Empty/whitespace-only -> `Ok(None)`
  - Valid `usize` -> `Ok(Some(n))`
  - Non-numeric, non-empty -> `Err("Invalid argument '...'. Use a number or omit to see a list.")`
- [x] Update `handle_command` match arms to pass the `String` arg by reference:
  `Command::Switch(ref arg)` and `Command::Delete(ref arg)`.
- [x] Update `cmd_switch` and `cmd_delete` signatures to accept `arg: &str` instead of `n: usize`;
  call `parse_session_arg(arg)` and branch on the result.

**Acceptance criteria:**
- `/switch` (no argument) is parsed successfully as `Switch("")` — `filter_command` no longer
  rejects it, eliminating the fall-through bug.
- `parse_session_arg` returns `Ok(None)` for empty/whitespace input, `Ok(Some(n))` for numeric
  input, and `Err(hint)` for non-numeric non-empty input.

---

### Task 2: Add `Start` variant and `cmd_start` (`commands.rs`)

- [x] Add `Start` variant with description `"Start the bot"` to the `Command` enum (before `Help`).
- [x] Add `Command::Start => cmd_start(&bot, &msg).await` match arm in `handle_command`.
- [x] Implement `cmd_start(bot, msg)` that sends the welcome message:
  `"Welcome to Synapse! I'm an AI assistant.\n\nSend me a message to start chatting, or use /help to see available commands."`

**Acceptance criteria:**
- `/start` triggers a welcome message reply and never touches the LLM.
- The `Command` enum compiles cleanly with the `Start` variant included.

---

### Task 3: Add defensive guard in `handle_message` (`handlers.rs`)

- [x] After extracting `text` from the message in `handle_message`, add an early-return guard:
  if `text.starts_with('/')`, reply with
  `"I didn't understand that command. Use /help to see available commands."` and return `Ok(())`.
- [x] The guard must fire before any LLM call is made, preventing forwarding.

**Acceptance criteria:**
- Any message beginning with `/` that reaches `handle_message` (i.e. was not handled by
  `filter_command`) receives the hint reply and is not forwarded to the LLM.
- Regular (non-slash) messages continue to reach the LLM without change.

---

### Task 4: Add keyboard builder functions (`commands.rs`)

- [x] Add necessary teloxide imports: `CallbackQuery`, `InlineKeyboardButton`, `InlineKeyboardMarkup`,
  and `SendMessageSetters`.
- [x] Implement `build_session_keyboard(action, sessions, active_id) -> InlineKeyboardMarkup`:
  one button per session, callback data `"action:N"` (1-based), active session marked with `*`,
  preview text capped at ~20 chars to stay within Telegram limits.
- [x] Implement `cmd_switch_keyboard(bot, msg, storage, chat_map)`: fetches sessions, builds keyboard
  with `action = "switch"`, sends `"Select a session to switch to:"` with the keyboard attached.
  If no sessions exist, reply with a hint instead.
- [x] Implement `cmd_delete_keyboard(bot, msg, storage, chat_map)`: same pattern with
  `action = "delete"` and prompt `"Select a session to delete:"`.
- [x] Implement `fetch_chat_sessions(chat_id, storage, chat_map) -> Option<(Vec<SessionSummary>, Option<Uuid>)>`:
  shared helper that reads the `chat_map` for UUIDs and active ID, calls `storage.list_sessions()`,
  and filters + orders the results for a given chat. Used by keyboard and `do_switch`/`do_delete`.

**Acceptance criteria:**
- `/switch` without argument sends a message containing an `InlineKeyboardMarkup` with one row
  per session and correct callback data (`"switch:1"`, `"switch:2"`, ...).
- `/delete` without argument sends a keyboard with `"delete:N"` callback data.
- If the chat has no sessions, a plain-text hint is sent instead of an empty keyboard.

---

### Task 5: Extract `do_switch` / `do_delete` and add `handle_callback` (`commands.rs`)

- [x] Extract `do_switch(n, chat_id, storage, chat_map) -> Result<String, String>`: re-fetches session
  list, validates `n` against list length, updates `active_idx` in `chat_map`, calls
  `storage.touch_session()`, returns `Ok("Switched to session N.")` or `Err(error)`.
- [x] Extract `do_delete(n, chat_id, config, storage, chat_map) -> Result<String, String>`: re-fetches
  session list, validates `n`, deletes from storage and `chat_map`, handles active-session deletion
  (switch to remaining session or auto-create), returns reply string.
- [x] Refactor `cmd_switch` and `cmd_delete` to delegate to `do_switch`/`do_delete` after
  `parse_session_arg` returns `Ok(Some(n))`.
- [x] Add `parse_callback_data(data: &str) -> Option<(&str, usize)>` helper that splits `"action:N"`
  into `(action, n)`.
- [x] Implement `pub handle_callback(bot, q, config, storage, chat_map) -> ResponseResult<()>`:
  1. Authorization check — silent drop for unauthorized users.
  2. `bot.answer_callback_query(q.id.clone())` — dismiss spinner immediately.
  3. Parse `q.data` as `"action:N"`.
  4. Extract `chat_id` from `q.regular_message()`; log and skip edit if `None`.
  5. Execute `do_switch` or `do_delete` based on parsed action.
  6. `bot.edit_message_text(chat_id, message_id, reply)` — remove keyboard, show result.
     Log at `warn` if edit fails (message too old), but do not propagate.

**Acceptance criteria:**
- Tapping a keyboard button executes the correct switch or delete action and edits the original
  message to plain text (keyboard removed), preventing double-tap.
- Unauthorized users' callback queries are silently dropped.
- Stale index (session deleted between keyboard display and tap) returns an error message via
  the message edit rather than panicking or leaving the keyboard visible.

---

### Task 6: Restructure dispatcher (`main.rs`)

- [x] Wrap the existing `Update::filter_message()` branch in a top-level `dptree::entry()` with a
  second branch for `Update::filter_callback_query().endpoint(commands::handle_callback)`.
- [x] Verify that `dptree::deps![]` already provides `config`, `storage`, and `chat_map` (it does;
  no new deps needed since `Agent` is not required for callbacks).

**Acceptance criteria:**
- The dispatcher routes `CallbackQuery` updates to `handle_callback`; message updates continue to
  route through the existing `filter_command` / `handle_message` branches unchanged.
- `cargo build` succeeds with no new clippy warnings.

---

### Task 7: Unit tests (`commands.rs`)

- [x] `test_parse_session_arg_empty` — `parse_session_arg("")` returns `Ok(None)`.
- [x] `test_parse_session_arg_whitespace` — `parse_session_arg("  ")` returns `Ok(None)`.
- [x] `test_parse_session_arg_numeric` — `parse_session_arg("3")` returns `Ok(Some(3))`.
- [x] `test_parse_session_arg_zero` — `parse_session_arg("0")` returns `Ok(Some(0))` (index
  validation is deferred to `do_switch`/`do_delete`).
- [x] `test_parse_session_arg_non_numeric` — `parse_session_arg("abc")` returns `Err(hint)` where
  `hint` contains "Invalid argument".
- [x] `test_parse_session_arg_negative` — `parse_session_arg("-1")` returns `Err(hint)` (negative
  values fail `usize` parse).
- [x] `test_parse_callback_data_valid_switch` — `parse_callback_data("switch:2")` returns
  `Some(("switch", 2))`.
- [x] `test_parse_callback_data_valid_delete` — `parse_callback_data("delete:1")` returns
  `Some(("delete", 1))`.
- [x] `test_parse_callback_data_invalid_no_colon` — `parse_callback_data("switch2")` returns `None`.
- [x] `test_parse_callback_data_invalid_non_numeric` — `parse_callback_data("switch:abc")` returns
  `None`.
- [x] `test_build_session_keyboard_callback_data` — build a keyboard with 2 sessions using
  `action = "switch"`, verify buttons have callback data `"switch:1"` and `"switch:2"`.
- [x] `test_build_session_keyboard_active_marker` — build keyboard where second session is active,
  verify `*` appears in the second button label and not in the first.
- [x] `test_build_session_keyboard_empty_sessions` — build keyboard with empty session slice, verify
  the resulting markup has no button rows.
- [x] `test_defensive_guard_slash_detection` — assert that `"/"`, `"/foo"`, and `"/switch"` each
  satisfy `text.starts_with('/')`, and that `"hello"` does not.

**Acceptance criteria:**
- All 14 tests pass under `cargo test -p synapse-telegram`.
- Tests are pure unit tests (no `Bot` instance, no database, no async runtime) where possible.

---

## Implementation Order

```
Task 1 (enum type change + parse_session_arg)
  |
  +---> Task 2 (Start variant)       — can run in parallel with Task 1
  |
  +---> Task 3 (defensive guard)     — can run in parallel with Task 1
  |
  v
Task 4 (keyboard builders)           — requires Task 1's String-based enum
  |
  v
Task 5 (do_switch/do_delete + handle_callback) — requires Tasks 1 and 4
  |
  v
Task 6 (dispatcher restructure)      — requires Task 5 (needs handle_callback)
  |
  v
Task 7 (unit tests)                  — requires all previous tasks
```

Recommended sequential order: 1 -> 2 -> 3 -> 4 -> 5 -> 6 -> 7.
