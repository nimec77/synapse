# SY-18 Tasklist: Telegram Bot Commands

**Ticket:** SY-18
**Status:** IMPLEMENT_STEP_OK
**Date:** 2026-02-24

## Context

Adds slash command support (`/help`, `/new`, `/history`, `/list`, `/switch N`, `/delete N`) to the
Telegram bot with multi-session management per chat. Requires updating `TelegramConfig` with a
configurable `max_sessions_per_chat` field (default 10), replacing the single-UUID-per-chat
`ChatSessionMap` with a `ChatSessions` struct that tracks multiple session UUIDs and an active index,
and switching the teloxide dispatcher to a branched pattern that routes commands separately from
regular messages.

---

## Tasks

- [x] **Task 1: Add `max_sessions_per_chat` to `TelegramConfig`**

  Files: `synapse-core/src/config.rs`, `synapse-telegram/src/main.rs` (test updates)

  - Add `default_max_sessions_per_chat()` returning `10u32`, add the field with
    `#[serde(default = "default_max_sessions_per_chat")]`, and replace `#[derive(Default)]` with a
    manual `impl Default` that sets the field to `10`.
  - Update `test_telegram_config_default` to assert `max_sessions_per_chat == 10`; add
    `test_config_telegram_max_sessions_per_chat` parsing TOML with explicit value `5` and with
    `[telegram]` section but no field (expects `10`); update all `TelegramConfig { ... }` callsites
    in test code to include the new field or use `..TelegramConfig::default()`.

  **Acceptance criteria:**
  1. `TelegramConfig::default().max_sessions_per_chat == 10` and `cargo test` passes with the
     updated and new tests.
  2. Deserializing `[telegram]\nmax_sessions_per_chat = 5` yields `5`; omitting the field yields
     `10`.

- [x] **Task 2: Move `chrono` to runtime dependency**

  File: `synapse-telegram/Cargo.toml`

  - Move `chrono = "0.4"` from `[dev-dependencies]` to `[dependencies]`.
  - Remove the empty `[dev-dependencies]` section if no other dev-deps remain.

  **Acceptance criteria:**
  1. `chrono` appears under `[dependencies]` (not `[dev-dependencies]`) in `synapse-telegram/Cargo.toml`.
  2. `cargo build` succeeds and timestamp formatting in command handlers compiles without errors.

- [x] **Task 3: Introduce `ChatSessions` struct and update `ChatSessionMap` + `resolve_session`**

  File: `synapse-telegram/src/handlers.rs`

  - Add `ChatSessions { sessions: Vec<Uuid>, active_idx: usize }` with `active_session_id()` method.
  - Update `ChatSessionMap` type alias to `Arc<RwLock<HashMap<i64, ChatSessions>>>`.
  - Update `resolve_session` fast path to call `active_session_id()` and slow path to insert a
    `ChatSessions { sessions: vec![session.id], active_idx: 0 }` entry; preserve double-check pattern.
  - Verify `handle_message` compiles with the new type (no functional changes needed).

  **Acceptance criteria:**
  1. `ChatSessions::active_session_id()` returns `Some(uuid)` when `sessions` is non-empty and
     `None` when empty.
  2. `resolve_session` creates a single-element `ChatSessions` on first message and returns the same
     session UUID on subsequent calls without hitting the slow path.

- [x] **Task 4: Create `synapse-telegram/src/commands.rs` with all six command handlers**

  Files: `synapse-telegram/src/commands.rs`, `synapse-telegram/src/main.rs` (module declaration)

  - Define `Command` enum with `#[derive(BotCommands, Clone)]` and `rename_rule = "lowercase"` for
    `/help`, `/new`, `/history`, `/list`, `/switch(usize)`, `/delete(usize)`.
  - Implement `handle_command()` with authorization check (reusing `handlers::is_authorized()`),
    dispatching to private `cmd_*` functions.
  - Implement `cmd_help` (replies with `Command::descriptions().to_string()`).
  - Implement `cmd_new` enforcing `max_sessions_per_chat` cap: if at cap, evict oldest session
    (last in `list_sessions()` order for this chat), then create new session, insert at front, set
    `active_idx = 0`, and reply confirming creation (with eviction note if applicable).
  - Implement `cmd_history`: get active session, fetch messages via `storage.get_messages()`,
    format each with `chrono` timestamps and role labels, chunk with `chunk_message()`, send plain text.
  - Implement `cmd_list`: fetch `list_sessions()`, filter to this chat's UUIDs, format numbered list
    with `*` marking the active session, chunk and send plain text.
  - Implement `cmd_switch`: reconstruct display-order list via `list_sessions()`, validate 1-based
    index N, find UUID at position N-1, update `active_idx`, call `storage.touch_session()`, reply.
  - Implement `cmd_delete`: reconstruct display-order list, validate index, delete from storage and
    in-memory vec, adjust `active_idx` (switch to 0 if active deleted with sessions remaining,
    auto-create new session if no sessions remain, decrement if non-active index below active was
    removed), reply.
  - Add `mod commands;` in `synapse-telegram/src/main.rs`.

  **Acceptance criteria:**
  1. All six commands compile and match the `Command` enum variants; `/help` replies with the
     teloxide-generated description string.
  2. `/new` at cap evicts the oldest session and confirms eviction; `/switch N` and `/delete N`
     with invalid index reply with the specified error message referencing `/list`.

- [x] **Task 5: Update dispatcher and `rebuild_chat_map` in `main.rs`**

  File: `synapse-telegram/src/main.rs`

  - Add `mod commands;` and import `commands::Command`.
  - Call `bot.get_me().await?` at startup; call `bot.set_my_commands(Command::bot_commands()).await`
    with a `tracing::warn!` on failure (do not abort).
  - Replace single-endpoint handler with branched pattern:
    `Update::filter_message().branch(filter_command::<Command>().endpoint(handle_command)).branch(endpoint(handle_message))`.
  - Inject `me` into `dptree::deps![]`.
  - Rewrite `rebuild_chat_map` to return `HashMap<i64, ChatSessions>` grouping all `tg:<chat_id>`
    sessions by chat (DB returns `ORDER BY updated_at DESC`; first UUID per chat is the most recent
    and becomes active at index 0).
  - Update startup log to report total session count across all chats.

  **Acceptance criteria:**
  1. Bot correctly routes `/help` (and all other slash commands) to `commands::handle_command` and
     non-command messages to `handlers::handle_message`; both compile without errors.
  2. `rebuild_chat_map` groups multiple `tg:<same_chat_id>` sessions into a single `ChatSessions`
     entry with `active_idx = 0` pointing to the most recently updated session.

- [x] **Task 6: Update existing tests in `synapse-telegram/src/main.rs`**

  File: `synapse-telegram/src/main.rs`

  - Update `test_resolve_token_env_var`, `test_resolve_token_config`, and
    `test_resolve_token_empty_env_var` to use `..TelegramConfig::default()` for the new field.
  - Update `test_rebuild_chat_map_empty`, `test_rebuild_chat_map_with_telegram_sessions`, and
    `test_rebuild_chat_map_ignores_non_telegram` for the new `HashMap<i64, ChatSessions>` return type.
  - Add `test_rebuild_chat_map_multi_session_per_chat`: create multiple `SessionSummary` entries
    with the same `tg:<chat_id>` name but different UUIDs and `updated_at` values; assert they are
    grouped under one key, the most recent UUID is first in `sessions`, and `active_idx == 0`.

  **Acceptance criteria:**
  1. All previously-passing tests continue to pass with the updated `TelegramConfig` and
     `ChatSessions` types.
  2. `test_rebuild_chat_map_multi_session_per_chat` passes, asserting correct grouping,
     ordering, and `active_idx`.

- [x] **Task 7: Add unit tests for command logic in `commands.rs`**

  File: `synapse-telegram/src/commands.rs`

  - Add `#[cfg(test)] mod tests` with a `MockSessionStore` (or reuse pattern from `main.rs`).
  - Test `ChatSessions::active_session_id()` for both non-empty (returns `Some`) and empty (returns `None`).
  - Test session cap enforcement logic (sessions at cap triggers eviction of oldest).
  - Test index validation: valid index succeeds, index 0 is invalid (1-based), index > count is invalid.
  - Test `/delete` `active_idx` adjustment: deleting active session with others remaining sets
    `active_idx = 0`; deleting non-active session below active decrements `active_idx`.

  **Acceptance criteria:**
  1. All new tests in `commands.rs` pass under `cargo test`.
  2. Edge cases for index validation (0, N+1) and `active_idx` adjustment (both active and
     non-active deletion paths) are explicitly covered.

- [x] **Task 8: Update `config.example.toml`**

  File: `config.example.toml`

  - Add a commented-out `max_sessions_per_chat = 10` entry with a descriptive comment in the
    `[telegram]` section.

  **Acceptance criteria:**
  1. `config.example.toml` contains a `[telegram]` section with a commented `max_sessions_per_chat`
     entry that documents the default value and eviction behavior.

- [x] **Task 9: Run pre-commit checks**

  - Run `cargo fmt --check` — zero formatting violations.
  - Run `cargo clippy -- -D warnings` — zero new warnings.
  - Run `cargo test` — all tests pass.

  **Acceptance criteria:**
  1. `cargo fmt --check && cargo clippy -- -D warnings && cargo test` exits with code 0.
  2. No regressions in previously-passing tests.
