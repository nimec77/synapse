# SY-16 Tasklist: Phase 15 — Code Refactoring

Status: IMPLEMENT_STEP_OK

## Context

Improve internal code quality without changing external behaviour. Seven tasks in strict dependency order eliminate dead code, reduce ~400 lines of duplication, replace magic strings, add structured tracing, extract shared utilities, split large files, and tighten the public API surface.

**Zero external behaviour changes.** Pre-commit gate (`cargo fmt --check && cargo clippy -- -D warnings && cargo test`) must pass after every task.

**Task ordering (strict):** 15.1 -> 15.2 -> 15.3 -> 15.4 -> 15.5 -> 15.6 -> 15.7

---

## Tasks

### Task 15.1 — Dead Code Removal

- [x] Delete the `placeholder` module from `synapse-core/src/lib.rs` (lines 25-31).
- [x] Remove unused `StreamEvent` variants (`ToolCall`, `ToolResult`, `Error`) from `synapse-core/src/provider/streaming.rs` and their associated tests.
- [x] Remove the now-unused `use crate::provider::ProviderError` import from `streaming.rs`.
- [x] Remove the `StreamEvent::Error(e)` arm (line 213) and `Some(Ok(_))` wildcard arm (line 216) from `synapse-cli/src/main.rs`.
- [x] Remove the `StreamEvent::Error(e)` arm (line 646) from `synapse-cli/src/repl.rs`.
- [x] Add serde-justification comments on `#[allow(dead_code)]` annotations for `finish_reason` in `deepseek.rs` and `openai.rs`.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- `StreamEvent` enum contains only `TextDelta(String)` and `Done` variants; `cargo clippy -- -D warnings` reports zero warnings.
- `cargo test` passes with all tests green; no dead-code warnings from the compiler.

---

### Task 15.2 — OpenAI-Compatible Provider Extraction

- [x] Create `synapse-core/src/provider/openai_compat.rs` and declare `mod openai_compat;` in `synapse-core/src/provider.rs`.
- [x] Move all shared serde types into `openai_compat.rs` with `pub(super)` visibility: `ApiMessage`, `ApiRequest`, `StreamingApiRequest`, `OaiTool`, `OaiFunction`, `OaiToolCall`, `OaiToolCallFunction`, `ApiResponse`, `Choice`, `ChoiceMessage`, `ApiError`, `ErrorDetail`, `StreamChunk`, `StreamDelta`, `StreamChoice`.
- [x] Move shared functions into `openai_compat.rs` with `pub(super)` visibility: `build_api_messages()`, `complete_request()`, `to_oai_tools()`, `stream_sse()`.
- [x] Add constants `pub(super) const SSE_DONE_MARKER: &str = "[DONE]";` and `pub(super) const DEFAULT_MAX_TOKENS: u32 = 1024;` to `openai_compat.rs`.
- [x] Reduce `deepseek.rs` to a thin wrapper (~50-80 lines) delegating all logic to `openai_compat`.
- [x] Reduce `openai.rs` to a thin wrapper (~50-80 lines) delegating all logic to `openai_compat`.
- [x] Move serde tests to `openai_compat.rs`; keep only struct-wiring tests in `deepseek.rs` and `openai.rs`.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- `deepseek.rs` and `openai.rs` are each ~50-80 lines; all existing tests pass unchanged with identical JSON serialization output.
- `cargo clippy -- -D warnings` passes with zero warnings; no public API regressions.

---

### Task 15.3 — Constants and Methods

- [x] Add `Role::as_str(&self) -> &'static str` method to `synapse-core/src/message.rs` returning `"system"`, `"user"`, `"assistant"`, `"tool"`.
- [x] Add `impl std::str::FromStr for Role` to `synapse-core/src/message.rs` with `type Err = String`.
- [x] Replace manual role match in `openai_compat.rs` `build_api_messages()` with `m.role.as_str().to_string()`.
- [x] Replace `role_to_string()` in `sqlite.rs` to delegate to `role.as_str()`.
- [x] Replace `parse_role()` in `sqlite.rs` to delegate to `s.parse::<Role>().map_err(|e| StorageError::InvalidData(e))`.
- [x] Add `const ERROR_REPLY: &str = "Sorry, I encountered an error. Please try again.";` in `synapse-telegram/src/handlers.rs` and replace both literal occurrences (lines 69, 123).
- [x] Add `const DEFAULT_TRACING_DIRECTIVE: &str = "synapse_telegram=info";` in `synapse-telegram/src/main.rs` and replace all three hard-coded occurrences (lines 42, 75, 95).
- [x] Add `const DEEPSEEK_API_KEY_ENV`, `const ANTHROPIC_API_KEY_ENV`, `const OPENAI_API_KEY_ENV` in `synapse-core/src/provider/factory.rs` and replace the three hard-coded env-var strings in `get_api_key()`.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- No manual string-literal role conversions remain in providers or storage; `Role::as_str()` and `FromStr` are used throughout.
- All string constants (`SSE_DONE_MARKER` already in 15.2, `ERROR_REPLY`, `DEFAULT_TRACING_DIRECTIVE`, env-var names) are declared as named constants with no magic-string literals remaining at their usage sites.

---

### Task 15.4 — Structured Tracing

- [x] Add `tracing = "0.1"` to `synapse-core/Cargo.toml`.
- [x] Add `tracing = "0.1"` and `tracing-subscriber = { version = "0.3", features = ["env-filter"] }` to `synapse-cli/Cargo.toml`.
- [x] Add `tracing_subscriber::fmt().with_env_filter(EnvFilter::from_default_env()).init();` to `synapse-cli/src/main.rs` `main()` before any work.
- [x] Add `debug!` instrumentation in `agent.rs` `complete()` for tool call iteration count and tool names being called.
- [x] Add `debug!` instrumentation in `openai_compat.rs` `complete_request()` for HTTP POST endpoint (no auth header) and response status code.
- [x] Add `debug!` instrumentation in `openai_compat.rs` `stream_sse()` for stream started/ended.
- [x] Add `debug!` instrumentation in `anthropic.rs` `complete()` and `stream()` for HTTP POST endpoint and status code.
- [x] Add `info!` instrumentation in `factory.rs` `create_provider()` for provider and model selected.
- [x] Add `debug!` instrumentation in `sqlite.rs` CRUD methods for session created/retrieved/deleted and message added.
- [x] Add `debug!` instrumentation in `config.rs` `load()` for resolved config path.
- [x] Add `info!` instrumentation in `mcp/tools.rs` `McpClient::new()` for server connection success and tool count discovered.
- [x] Add `debug!` instrumentation in `mcp/tools.rs` `call_tool()` for tool name being called.
- [x] Replace `eprintln!("Warning: MCP server '{}' failed to start: {}", ...)` in `mcp/tools.rs` (line 57) with `tracing::warn!`.
- [x] Replace `eprintln!("Warning: MCP initialization failed: {}", e)` in `synapse-cli/src/main.rs` (line 74) with `tracing::warn!`.
- [x] Replace `eprintln!("Warning: MCP config error: {}", e)` in `synapse-cli/src/main.rs` (line 80) with `tracing::warn!`.
- [x] Replace `eprintln!("Session: {}", session.id)` in `synapse-cli/src/repl.rs` (line 675) with `tracing::info!`.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- Zero `eprintln!` calls remain in `synapse-core` and `synapse-cli` (pre-init `eprintln!` calls in `synapse-telegram/src/main.rs` are intentionally kept).
- `cargo clippy -- -D warnings` passes; no API keys or tokens appear in any tracing call sites; tracing is silent by default unless `RUST_LOG` is set.

---

### Task 15.5 — Shared Utility Extraction

- [x] Add `pub async fn init_mcp_client(config_path: Option<&str>) -> Option<McpClient>` to `synapse-core/src/mcp.rs` using `tracing::warn!` for failures.
- [x] Export `init_mcp_client` from `synapse-core/src/lib.rs` (via `pub use mcp::...` or accessible at `synapse_core::mcp::init_mcp_client`).
- [x] Remove the local `init_mcp_client()` function from `synapse-cli/src/main.rs` (lines 68-84) and replace call sites with `synapse_core::mcp::init_mcp_client(...)`.
- [x] Remove the local `init_mcp_client()` function from `synapse-telegram/src/main.rs` (lines 208-224) and replace call sites with `synapse_core::mcp::init_mcp_client(...)`.
- [x] Add `Agent::from_config(config: &Config, mcp_client: Option<McpClient>) -> Result<Self, ProviderError>` factory method to `synapse-core/src/agent.rs`.
- [x] Replace agent construction in `synapse-cli/src/main.rs` one-shot mode (lines 184-190) with `Agent::from_config(&config, mcp_client)`.
- [x] Replace agent construction in `synapse-telegram/src/main.rs` (lines 151-164) with `Agent::from_config(&config, mcp_client)`.
- [x] Evaluate and update the REPL call site in `synapse-cli/src/repl.rs` to use `from_config` if feasible.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- `init_mcp_client()` has a single definition in `synapse-core/src/mcp.rs`; no copy-pasted version exists in either interface crate.
- `Agent::from_config()` is the sole agent-construction pattern across all call sites; agent construction boilerplate is not repeated in interface crates.

---

### Task 15.6 — File Splitting

- [x] Create `synapse-cli/src/repl/` directory with `app.rs` (ReplApp struct, state fields, transitions, helpers), `render.rs` (draw/render functions, TUI layout), and `input.rs` (handle_key_event, key bindings).
- [x] Reduce `synapse-cli/src/repl.rs` to the orchestrator: `mod app; mod input; mod render;` declarations, `TerminalGuard` struct, and the public `run_repl()` function only.
- [x] Use `pub(super)` or `pub(crate)` for submodule items; only `run_repl()` is public to `main.rs`.
- [x] Create `synapse-cli/src/commands.rs` and move into it: `Commands` enum (lines 42-49), `SessionAction` enum (lines 51-65), `handle_command()` function (lines 250-349), and `truncate()` helper (lines 351-360).
- [x] Add `mod commands;` and `use commands::{Commands, handle_command};` to `synapse-cli/src/main.rs` and remove the moved items.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- `repl.rs` is the orchestrator only (~50-100 lines); logic is distributed across `repl/app.rs`, `repl/render.rs`, and `repl/input.rs`; no `mod.rs` files are created.
- `commands.rs` exists as a dedicated module; `main.rs` no longer contains `Commands`, `SessionAction`, `handle_command()`, or `truncate()`; `cargo build` and `cargo test` pass.

---

### Task 15.7 — API Surface Tightening and Async Fix

- [x] Replace `std::fs::create_dir_all(parent)` in `synapse-core/src/storage/sqlite.rs` (line 62) with `tokio::fs::create_dir_all(parent).await`.
- [x] Add `fs` to the tokio features list in `synapse-core/Cargo.toml`: `tokio = { version = "1", features = ["rt", "macros", "process", "fs"] }`.
- [x] Audit `synapse-core/src/lib.rs` re-exports against actual imports in `synapse-cli` and `synapse-telegram`.
- [x] Remove the following 17 items from `lib.rs` re-exports (keep accessible via module paths): `ConfigError`, `LoggingConfig`, `McpSettings`, `SessionConfig`, `McpConfig`, `McpError`, `McpServerConfig`, `ToolDefinition`, `ToolCallData`, `AnthropicProvider`, `DeepSeekProvider`, `MockProvider`, `OpenAiProvider`, `ProviderError`, `CleanupResult`, `SqliteStore`, `StorageError`.
- [x] Verify the narrowed `lib.rs` re-exports match exactly: `Agent`, `AgentError`, `Config`, `TelegramConfig`, `McpClient`, `load_mcp_config`, `init_mcp_client`, `Message`, `Role`, `LlmProvider`, `StreamEvent`, `create_provider`, `Session`, `SessionSummary`, `StoredMessage`, `SessionStore`, `create_storage`.
- [x] Run pre-commit gate: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Acceptance criteria:**
- Zero blocking `std::fs` calls remain in async functions in `synapse-core`; `tokio::fs::create_dir_all().await` is used in `sqlite.rs`.
- `lib.rs` re-exports only the items actually imported by consumer crates; all 17 removed items remain accessible via their full module paths; all crates compile and all tests pass.
