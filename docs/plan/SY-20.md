# SY-20 Plan: Improve /history Command

**Ticket:** SY-20
**Status:** PLAN_APPROVED
**Date:** 2026-02-26

---

## Summary

SY-20 replaces the full message dump in the Telegram `/history` command with a compact "last 10 messages" view. The changes are: (1) filter `StoredMessage` results to keep only `Role::User` and `Role::Assistant`, discarding `System` and `Tool` messages, (2) take the last 10 messages from the filtered list (chronologically most recent), (3) truncate each message's content to 150 Unicode characters with `...` appended when truncation occurs, (4) update the `Command::History` description to `"Show recent messages"`, and (5) extract the filtering/truncation logic into testable helper functions with comprehensive unit tests. All documentation (CLAUDE.md, README.md, CHANGELOG.md) is already up to date.

---

## 1. Components

| Component | File(s) | Change |
|-----------|---------|--------|
| `truncate_content` | `synapse-telegram/src/commands.rs` | **NEW** helper: `&str, usize -> String` for Unicode-safe character truncation with `...` suffix |
| `format_history` | `synapse-telegram/src/commands.rs` | **NEW** helper: `&[StoredMessage] -> String` filters roles, takes last 10, formats output |
| `cmd_history` | `synapse-telegram/src/commands.rs` | Refactored to delegate formatting to `format_history` |
| `Command::History` | `synapse-telegram/src/commands.rs` | Description changed from `"Show conversation history"` to `"Show recent messages"` |
| Unit tests | `synapse-telegram/src/commands.rs` | **NEW** tests for `truncate_content` and `format_history` |

No changes to `synapse-core`, `synapse-cli`, or any other files outside `synapse-telegram/src/commands.rs`.

---

## 2. API Contract

### truncate_content

```rust
/// Truncate content to `max_chars` Unicode characters.
///
/// If the content exceeds `max_chars`, the result is the first `max_chars`
/// characters followed by `...` (three ASCII dots). Content at or below
/// the limit is returned unchanged.
fn truncate_content(content: &str, max_chars: usize) -> String {
    let char_count = content.chars().count();
    if char_count <= max_chars {
        content.to_string()
    } else {
        let truncated: String = content.chars().take(max_chars).collect();
        format!("{}...", truncated)
    }
}
```

### format_history

```rust
/// Format stored messages into a compact history string.
///
/// Filters to `Role::User` and `Role::Assistant` only, takes the last 10
/// messages (chronologically most recent), and formats each as:
/// `[role_label] timestamp\ntruncated_content\n\n`
///
/// Returns an empty string if no User/Assistant messages exist.
fn format_history(messages: &[StoredMessage]) -> String {
    let filtered: Vec<&StoredMessage> = messages
        .iter()
        .filter(|m| matches!(m.role, Role::User | Role::Assistant))
        .collect();
    let skip = filtered.len().saturating_sub(10);
    let recent = &filtered[skip..];

    let mut output = String::new();
    for m in recent {
        let role_label = match m.role {
            Role::User => "You",
            Role::Assistant => "Assistant",
            _ => unreachable!(), // filtered above
        };
        let timestamp = chrono::Utc
            .from_utc_datetime(&m.timestamp.naive_utc())
            .format("%Y-%m-%d %H:%M")
            .to_string();
        let content = truncate_content(&m.content, 150);
        output.push_str(&format!("[{}] {}\n{}\n\n", role_label, timestamp, content));
    }
    output
}
```

### Updated cmd_history (simplified)

```rust
async fn cmd_history(
    bot: &Bot,
    msg: &TgMessage,
    storage: &Arc<Box<dyn SessionStore>>,
    chat_map: &ChatSessionMap,
) -> ResponseResult<()> {
    // ... session lookup (unchanged) ...

    let messages = storage.get_messages(session_id).await.unwrap_or_default();
    let output = format_history(&messages);

    if output.is_empty() {
        bot.send_message(msg.chat.id, "No messages in current session.")
            .await?;
        return Ok(());
    }

    for chunk in chunk_message(output.trim()) {
        bot.send_message(msg.chat.id, chunk).await?;
    }
    Ok(())
}
```

### Updated Command::History description

```rust
#[command(description = "Show recent messages")]
History,
```

---

## 3. Data Flows

### /history with mixed roles (normal case)

```
User sends "/history"
  |
  v
handle_command -> cmd_history(bot, msg, storage, chat_map)
  |
  v
Read active session from chat_map (unchanged)
  |
  v
storage.get_messages(session_id) -> Vec<StoredMessage>
  (returns ALL messages in chronological order: User, Assistant, System, Tool)
  |
  v
format_history(&messages):
  1. Filter: keep only Role::User and Role::Assistant
  2. Limit: skip first N-10 (saturating), take last 10
  3. Format each: truncate_content(content, 150), build "[role] timestamp\ncontent\n\n"
  4. Return concatenated string
  |
  v
If output is empty -> "No messages in current session."
If output is non-empty -> chunk_message(output.trim()) -> send each chunk
```

### /history with empty session

```
User sends "/history"
  |
  v
storage.get_messages(session_id) -> empty Vec
  |
  v
format_history(&[]) -> ""
  |
  v
Reply: "No messages in current session."
```

### /history with only System/Tool messages

```
User sends "/history"
  |
  v
storage.get_messages(session_id) -> Vec containing only System and Tool messages
  |
  v
format_history(&messages) -> "" (all messages filtered out)
  |
  v
Reply: "No messages in current session."
```

### /history truncation example

```
Message content: "Lorem ipsum dolor sit amet... (500 characters)"
  |
  v
truncate_content(content, 150):
  char_count = 500 > 150
  -> first 150 chars + "..."
  |
  v
Displayed: "[Assistant] 2026-02-26 14:30\nLorem ipsum dolor sit am...\n\n"
```

---

## 4. NFR (Non-Functional Requirements)

| Requirement | How satisfied |
|-------------|---------------|
| Pre-commit gate | `cargo fmt --check && cargo clippy -- -D warnings && cargo test` |
| No `unwrap()`/`expect()` in core | All changes are in `synapse-telegram` (interface crate); no core changes |
| No blocking I/O | No blocking calls introduced; `cmd_history` remains async |
| Hexagonal architecture | All changes confined to `synapse-telegram`; `synapse-core` untouched |
| No new crate dependencies | Uses existing `chrono`, `synapse_core::message::Role`, `StoredMessage` |
| No `mod.rs` files | No new modules created; all code in existing `commands.rs` |
| 100 char line limit | Enforced by `cargo fmt` |
| Unicode-safe truncation | Uses `.chars().take(150)` per PRD constraint, consistent with existing `cmd_list` pattern |
| Plain text output | `/history` replies use plain text (no `ParseMode::Html`), matching existing command convention |
| Testable helpers | `truncate_content` and `format_history` are pure synchronous functions, extracted from the async handler |

---

## 5. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Full message retrieval for large sessions | Low | Low | `storage.get_messages()` returns all messages before filtering. Acceptable for Telegram usage patterns where sessions rarely exceed hundreds of messages. Pagination can be added in a future ticket if needed. |
| Variable-width Unicode characters | Low | Low | `.chars().take(150)` counts Unicode scalar values, not display width. CJK/emoji characters may appear shorter visually. Acceptable and consistent with existing codebase patterns. |
| `unreachable!()` in `format_history` role match | Very Low | Low | The `_ => unreachable!()` arm in the role match inside `format_history` is safe because the `filter` step above guarantees only `User` and `Assistant` reach it. Could alternatively use an explicit `Role::System | Role::Tool` arm with `continue`, but `unreachable!()` is clearer about the invariant. |

---

## 6. Deviations to Fix

None identified. The current `cmd_history` implementation simply lacks the filtering, limiting, and truncation features described in the PRD. The existing code will be refactored to add these features without contradicting any requirements. All documentation targets (CLAUDE.md, README.md, CHANGELOG.md) are already up to date per the research document.

---

## 7. Implementation Tasks

### Task 1: Extract helper functions and refactor cmd_history (`commands.rs`)

**Goal:** Replace the inline formatting loop in `cmd_history` with two testable helper functions and update the command description.

1. Add `use synapse_core::session::StoredMessage;` to the imports (it is already transitively available via `synapse_core` but needs an explicit import for the helper function signature).
2. Implement `truncate_content(content: &str, max_chars: usize) -> String`:
   - If `content.chars().count() <= max_chars`, return `content.to_string()`.
   - Otherwise, return `content.chars().take(max_chars).collect::<String>()` + `"..."`.
3. Implement `format_history(messages: &[StoredMessage]) -> String`:
   - Filter to `Role::User | Role::Assistant` using `matches!` macro.
   - Compute `skip = filtered.len().saturating_sub(10)`.
   - Slice `&filtered[skip..]` to get the last 10 in chronological order.
   - For each message: match role to `"You"` / `"Assistant"`, format timestamp as `%Y-%m-%d %H:%M`, call `truncate_content(&m.content, 150)`, append `"[role] timestamp\ncontent\n\n"` to output.
   - Return the concatenated output string (empty if no messages pass the filter).
4. Refactor `cmd_history` body:
   - Keep session lookup logic (lines 190-207) unchanged.
   - Keep `storage.get_messages(session_id).await.unwrap_or_default()` unchanged.
   - Replace the `if messages.is_empty()` check and the `for m in &messages` formatting loop with:
     ```rust
     let output = format_history(&messages);
     if output.is_empty() {
         bot.send_message(msg.chat.id, "No messages in current session.")
             .await?;
         return Ok(());
     }
     ```
   - Keep the `chunk_message(output.trim())` sending loop unchanged.
5. Update `Command::History` description (line 37) from `"Show conversation history"` to `"Show recent messages"`.

**Files:** `synapse-telegram/src/commands.rs`

### Task 2: Add unit tests (`commands.rs`)

**Goal:** Cover all truncation, filtering, and edge-case scenarios specified in the PRD.

Add a `make_stored_message` test helper (analogous to the existing `make_session` helper):
```rust
fn make_stored_message(role: Role, content: &str) -> StoredMessage {
    StoredMessage::new(Uuid::new_v4(), role, content)
}
```

**Tests for `truncate_content`:**

1. **`test_truncate_content_short`** -- Content of 10 characters returns unchanged, no `...`.
2. **`test_truncate_content_exact_limit`** -- Content of exactly 150 characters returns unchanged, no `...`.
3. **`test_truncate_content_over_limit`** -- Content of 151 characters returns first 150 chars + `...`.
4. **`test_truncate_content_long`** -- Content of 500 characters, verify output is 153 chars (150 + 3 dots) and ends with `...`.
5. **`test_truncate_content_empty`** -- Empty string returns empty string, no `...`.

**Tests for `format_history`:**

6. **`test_format_history_filters_system_and_tool`** -- Pass messages with all four roles; output contains only `"You"` and `"Assistant"`, never `"System"` or `"Tool"`.
7. **`test_format_history_keeps_user_and_assistant`** -- Pass 3 User and 3 Assistant messages; all 6 appear in output.
8. **`test_format_history_last_10_limit`** -- Pass 15 User/Assistant messages; only the last 10 appear in output (verify first 5 are absent).
9. **`test_format_history_fewer_than_10`** -- Pass 3 User/Assistant messages; all 3 appear.
10. **`test_format_history_empty`** -- Pass only System and Tool messages; returns empty string.
11. **`test_format_history_truncates_long_content`** -- Pass an Assistant message with 200-char content; verify the formatted output contains `...` and the content portion is truncated.

**Files:** `synapse-telegram/src/commands.rs`

### Task 3: Verify documentation (no file changes)

**Goal:** Confirm all documentation is already up to date.

1. **CLAUDE.md** -- Already describes `/history` as "(last 10 messages, truncated to 150 chars)" in the Workspace Crates table. No change needed.
2. **README.md** -- Line 139 already reads `| /history | Show recent messages from the current session |`. No change needed.
3. **CHANGELOG.md** -- `[Unreleased]` section already contains the entry: `- /history now shows the last 10 user/assistant messages (truncated to 150 chars) instead of dumping the full conversation.` No change needed.
4. Verify by reading the three files during implementation to confirm no drift has occurred.

**Files:** None (verification only)

---

## 8. Implementation Order and Dependencies

```
Task 1 (helpers + refactor cmd_history + update description)
  |
  v
Task 2 (unit tests) -- depends on Task 1 (tests call the new helper functions)
  |
  v
Task 3 (documentation verification) -- independent, can run in parallel with Task 2
```

All three tasks touch a single file (`synapse-telegram/src/commands.rs`), with Task 3 being a verification-only step that requires no file changes. The recommended sequential order is: 1 -> 2 -> 3.

---

## 9. Open Questions

None. The PRD provides clear specifications for all tasks. The research document confirms all implementation details and identifies no open questions or deviations. All documentation is already up to date.
