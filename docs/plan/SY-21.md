# SY-21 Plan: Code Refactoring II

**Ticket:** SY-21
**Status:** PLAN_APPROVED
**Date:** 2026-02-27

---

## Summary

SY-21 is a comprehensive internal refactoring pass that eliminates duplication, dead code, magic values, and type safety gaps accumulated since SY-16. Eight scenarios cover: (1) unifying truncation into a single `synapse-core/src/text.rs` function, (2) consolidating DeepSeek/OpenAI providers into a generic `OpenAiCompatProvider`, (3) deduplicating CLI session helpers, (4) deduplicating Telegram code (auth, session naming, constants, keyboards), (5) removing `stream_with_tools()` dead code and extracting named constants, (6) replacing `LoggingConfig.rotation: String` with a typed `Rotation` enum and removing `Arc<Box<dyn SessionStore>>` double indirection, (7) small polish items (constructors, layout constants, idiomatic patterns), and (8) splitting three large modules into focused submodules. Zero external behaviour changes.

---

## 1. Components

| Component | File(s) | Change |
|-----------|---------|--------|
| `text::truncate` | `synapse-core/src/text.rs` | **NEW** module: single char-safe truncation function with `max_len <= 3` guard |
| CLI `truncate` | `synapse-cli/src/commands.rs` | **DELETE** local function; import from `synapse_core::text` |
| TG `truncate_content` | `synapse-telegram/src/commands.rs` | **DELETE** local function; import from `synapse_core::text` |
| SQLite inline truncation | `synapse-core/src/storage/sqlite.rs` | **REPLACE** inline `.chars().take(47)` with call to `text::truncate` |
| Duplicate test | `synapse-cli/src/main.rs` | **DELETE** `test_truncate` test (line 259); canonical tests move to `text.rs` |
| `OpenAiCompatProvider` | `synapse-core/src/provider/openai_compat.rs` | **NEW** generic struct with full `LlmProvider` impl |
| `DeepSeekProvider` | `synapse-core/src/provider/deepseek.rs` | **REWRITE** as newtype wrapping `OpenAiCompatProvider` |
| `OpenAiProvider` | `synapse-core/src/provider/openai.rs` | **REWRITE** as newtype wrapping `OpenAiCompatProvider` |
| `factory.rs` | `synapse-core/src/provider/factory.rs` | **UPDATE** construction to use newtypes |
| CLI session helpers | `synapse-cli/src/session.rs` | **NEW** module: `init_storage()`, `load_or_create_session()` |
| CLI main | `synapse-cli/src/main.rs` | **REFACTOR** to use shared session helpers |
| CLI REPL | `synapse-cli/src/repl.rs` | **REFACTOR** to use shared session helpers |
| TG auth helper | `synapse-telegram/src/handlers.rs` | **NEW** `check_auth()` helper replacing 3 inline blocks |
| TG session naming | `synapse-telegram/src/handlers.rs` | **NEW** `tg_session_name()` helper replacing 3 `format!("tg:{}")` calls |
| `NO_SESSIONS_HINT` | `synapse-telegram/src/handlers.rs` | **NEW** constant replacing 6 duplicate strings |
| `TELEGRAM_MSG_LIMIT` | `synapse-telegram/src/format.rs` | **MOVE** to single definition; `handlers.rs` imports it |
| `build_action_keyboard` | `synapse-telegram/src/commands.rs` | **NEW** unified builder replacing `cmd_switch_keyboard` + `cmd_delete_keyboard` |
| `cmd_list` | `synapse-telegram/src/commands.rs` | **REFACTOR** to use `fetch_chat_sessions` |
| `stream_with_tools()` | `synapse-core/src/provider.rs` | **DELETE** from `LlmProvider` trait and all overrides |
| Named constants | `synapse-telegram/src/commands.rs` | **NEW** `PREVIEW_MAX_CHARS`, `HISTORY_MESSAGE_LIMIT`, `LIST_PREVIEW_MAX_CHARS`, `KEYBOARD_PREVIEW_MAX_CHARS` |
| `Rotation` enum | `synapse-core/src/config.rs` | **NEW** enum replacing `rotation: String` in `LoggingConfig` |
| `Arc<dyn SessionStore>` | `synapse-telegram/src/*.rs` | **REPLACE** all 15 `Arc<Box<dyn SessionStore>>` occurrences |
| `ChatSessions::new` | `synapse-telegram/src/handlers.rs` | **NEW** constructor replacing 13+ struct literal constructions |
| REPL layout constants | `synapse-cli/src/repl/render.rs` | **NEW** named constants for layout dimensions |
| `unwrap_or_else` | `synapse-telegram/src/commands.rs` | **REPLACE** 4 `Ok(r) | Err(r) => r` patterns |
| Module split: commands | `synapse-telegram/src/commands/keyboard.rs` | **NEW** submodule for keyboard builders and callback logic |
| Module split: format | `synapse-telegram/src/format/chunk.rs` | **NEW** submodule for HTML chunking |
| Module split: anthropic | `synapse-core/src/provider/anthropic/types.rs` | **NEW** submodule for serde request/response structs |
| Documentation | `CLAUDE.md`, `README.md` | **UPDATE** to remove `stream_with_tools()` references and reflect new module structure |

---

## 2. API Contract

### 2.1 `synapse_core::text::truncate`

```rust
/// Truncate a string to a maximum number of Unicode characters.
///
/// If the string exceeds `max_chars`, the result is the first `max_chars - 3`
/// characters followed by `...`. If `max_chars <= 3`, returns `"."` repeated
/// `max_chars` times. Strings at or below the limit are returned unchanged.
///
/// Uses `.chars()` for multi-byte safety.
pub fn truncate(s: &str, max_chars: usize) -> String
```

Adopts the CLI version's behaviour (with the `max_len <= 3` guard) as the canonical implementation. All callers across CLI, Telegram, and core storage import this single function.

### 2.2 `OpenAiCompatProvider`

```rust
/// Generic provider for OpenAI-compatible Chat Completions APIs.
///
/// Holds the base URL, API key, model, and max tokens. Implements all
/// `LlmProvider` methods using the shared helpers in this module.
pub(super) struct OpenAiCompatProvider {
    client: reqwest::Client,
    base_url: String,
    api_key: String,
    model: String,
    max_tokens: u32,
}

impl OpenAiCompatProvider {
    pub(super) fn new(
        base_url: impl Into<String>,
        api_key: impl Into<String>,
        model: impl Into<String>,
        max_tokens: u32,
    ) -> Self
}

#[async_trait]
impl LlmProvider for OpenAiCompatProvider {
    async fn complete(&self, messages: &[Message]) -> Result<Message, ProviderError>;
    async fn complete_with_tools(&self, messages: &[Message], tools: &[ToolDefinition])
        -> Result<Message, ProviderError>;
    fn stream(&self, messages: &[Message])
        -> Pin<Box<dyn Stream<Item = Result<StreamEvent, ProviderError>> + Send + '_>>;
}
```

### 2.3 Newtype Providers

```rust
// deepseek.rs
pub struct DeepSeekProvider(OpenAiCompatProvider);

impl DeepSeekProvider {
    pub fn new(api_key: impl Into<String>, model: impl Into<String>, max_tokens: u32) -> Self {
        Self(OpenAiCompatProvider::new(
            "https://api.deepseek.com/chat/completions",
            api_key, model, max_tokens,
        ))
    }
}

// Delegate all LlmProvider methods to inner.
```

Same pattern for `OpenAiProvider` with `https://api.openai.com/v1/chat/completions`.

### 2.4 CLI Session Helpers

```rust
// synapse-cli/src/session.rs

/// Create storage and run auto-cleanup if configured.
pub async fn init_storage(session_config: &SessionConfig) -> Result<Box<dyn SessionStore>>

/// Load an existing session by ID, or create a new session.
/// Returns the session and its message history.
pub async fn load_or_create_session(
    storage: &dyn SessionStore,
    config: &Config,
    session_id: Option<Uuid>,
) -> Result<(Session, Vec<StoredMessage>)>
```

### 2.5 Telegram Helpers

```rust
// handlers.rs

/// Constant hint message for chats with no sessions.
pub const NO_SESSIONS_HINT: &str = "No sessions. Send a message or use /new to start one.";

/// Build the `"tg:<chat_id>"` session name string.
pub fn tg_session_name(chat_id: i64) -> String

/// Check authorization and return `Some(Ok(()))` to short-circuit if unauthorized.
pub async fn check_auth(msg: &TgMessage, config: &Config) -> Option<ResponseResult<()>>

impl ChatSessions {
    /// Create a new `ChatSessions` with a single session at active index 0.
    pub fn new(session_id: Uuid) -> Self
}
```

### 2.6 `Rotation` Enum

```rust
// config.rs

/// Log rotation strategy.
#[derive(Debug, Clone, PartialEq, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum Rotation {
    Daily,
    Hourly,
    Never,
}

pub struct LoggingConfig {
    // ...
    #[serde(default = "default_rotation")]
    pub rotation: Rotation,
}

fn default_rotation() -> Rotation { Rotation::Daily }
```

### 2.7 Updated `LlmProvider` Trait (after dead code removal)

```rust
#[async_trait]
pub trait LlmProvider: Send + Sync {
    async fn complete(&self, messages: &[Message]) -> Result<Message, ProviderError>;

    fn stream(&self, messages: &[Message])
        -> Pin<Box<dyn Stream<Item = Result<StreamEvent, ProviderError>> + Send + '_>>;

    async fn complete_with_tools(
        &self,
        messages: &[Message],
        _tools: &[ToolDefinition],
    ) -> Result<Message, ProviderError> {
        self.complete(messages).await
    }

    // stream_with_tools() REMOVED -- never called by Agent
}
```

---

## 3. Data Flows

### 3.1 Truncation Flow (after unification)

```
synapse-cli/src/commands.rs::handle_command
  -> synapse_core::text::truncate(&preview, 40)

synapse-telegram/src/commands.rs::format_history
  -> synapse_core::text::truncate(&m.content, 150)

synapse-core/src/storage/sqlite.rs::list_sessions
  -> synapse_core::text::truncate(&preview, 50)
```

### 3.2 Provider Construction (after consolidation)

```
factory::create_provider(config)
  |
  v
match config.provider:
  "deepseek" -> DeepSeekProvider::new(key, model, max_tokens)
                  -> DeepSeekProvider(OpenAiCompatProvider::new(DEEPSEEK_URL, key, model, max_tokens))
  "openai"   -> OpenAiProvider::new(key, model, max_tokens)
                  -> OpenAiProvider(OpenAiCompatProvider::new(OPENAI_URL, key, model, max_tokens))
  "anthropic" -> AnthropicProvider::new(key, model, max_tokens)  // unchanged
```

### 3.3 CLI Session Init (after deduplication)

```
main.rs (REPL path or one-shot path)
  |
  v
session::init_storage(&session_config)
  -> create_storage(db_url) + optional cleanup
  |
  v
session::load_or_create_session(storage, config, session_id)
  -> get_session(id) OR Session::new() + create_session()
  -> return (Session, Vec<StoredMessage>)
```

### 3.4 Telegram Auth (after deduplication)

```
handle_message / handle_command / handle_callback
  |
  v
check_auth(msg_or_user_id, config)
  -> if !is_authorized -> return Some(Ok(()))
  -> if authorized -> return None (continue handler)
```

### 3.5 `Arc<dyn SessionStore>` Type Change

```
Before: Arc<Box<dyn SessionStore>>
  main.rs: Arc::new(create_storage(db_url).await?)
  handlers: fn(storage: Arc<Box<dyn SessionStore>>)
  commands: fn(storage: Arc<Box<dyn SessionStore>>)
  dptree::deps![storage]  // type-matched as Arc<Box<dyn SessionStore>>

After: Arc<dyn SessionStore>
  main.rs: Arc::from(create_storage(db_url).await?)  // Box<dyn> -> Arc<dyn> via Arc::from
  handlers: fn(storage: Arc<dyn SessionStore>)
  commands: fn(storage: Arc<dyn SessionStore>)
  dptree::deps![storage]  // type-matched as Arc<dyn SessionStore>
```

---

## 4. NFR (Non-Functional Requirements)

| Requirement | How satisfied |
|-------------|---------------|
| Pre-commit gate | `cargo fmt --check && cargo clippy -- -D warnings && cargo test` after every task |
| No `unwrap()`/`expect()` in core | All `synapse-core` changes use `?` propagation |
| No blocking I/O | No blocking calls introduced; all changes are sync helpers or type refactors |
| Hexagonal architecture | Core exports shared `text::truncate`; dependencies flow inward only |
| No `mod.rs` files | All new submodules use Rust 2018+ pattern (`commands/keyboard.rs`, not `commands/mod.rs`) |
| No new crate dependencies | All changes use existing dependencies |
| 100 char line limit | Enforced by `cargo fmt` |
| Char-safe truncation | Unified function uses `.chars()` per commit `3a4e33a` |
| Serde backward compatibility | `Rotation` enum uses `#[serde(rename_all = "lowercase")]` matching existing `"daily"`, `"hourly"`, `"never"` strings |
| Zero external behaviour changes | No user-facing output, API interaction, or database schema changes |

---

## 5. Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Removing `stream_with_tools()` breaks external consumers | Low | Medium | Trait is only implemented within the workspace; no external crates depend on it. Grep confirms only `complete_with_tools()` is called by `Agent`. |
| `Arc<Box<dyn SessionStore>>` to `Arc<dyn SessionStore>` migration breaks dptree injection | Medium | Low | `dptree` uses type-based matching; changing the type in `deps![]` and all handler signatures simultaneously ensures consistency. Compile-time check catches mismatches. |
| `OpenAiCompatProvider` consolidation introduces subtle regressions | Medium | High | Keep all existing tests; shared helpers (`build_api_messages`, `complete_request`, `stream_sse`) are already used by both providers. Wrapping in a struct changes no logic. |
| Module splits break re-exports or test paths | Low | Low | Split one module at a time; verify `cargo build && cargo test` after each. Re-export all previously-public symbols from parent module. |
| `Rotation` enum deserialization rejects existing config files | Low | Medium | Use `#[serde(rename_all = "lowercase")]` to match current strings exactly. Add unit test with each valid value. |
| Unified `truncate` changes edge-case behaviour | Low | Low | CLI version (with `max_len <= 3` guard) is the most defensive. Telegram callers always pass `max_chars >= 10`, so the guard is protective but never triggered in practice. |

---

## 6. Deviations to Fix

None identified. The research document confirms all PRD claims about duplication counts, line numbers, and patterns are accurate against the current codebase. No existing code contradicts the requirements.

---

## 7. Implementation Tasks

### Task 21.1: Unify truncation into `synapse-core/src/text.rs`

**Goal:** Single char-safe truncation function used by all three crates.

**Steps:**

1. Create `synapse-core/src/text.rs` with:
   ```rust
   pub fn truncate(s: &str, max_chars: usize) -> String
   ```
   Adopts the CLI version's logic including the `max_len <= 3` guard.

2. Add `pub mod text;` to `synapse-core/src/lib.rs`.

3. Move truncation tests from `synapse-cli/src/commands.rs` (lines 162-176) to `synapse-core/src/text.rs`. Add the multi-byte test. Add edge case tests for `max_chars <= 3`, `max_chars = 0`, empty string.

4. In `synapse-cli/src/commands.rs`: delete the `truncate` function (lines 144-155) and its test module. Replace usages at lines 76-79 with `synapse_core::text::truncate(...)`.

5. In `synapse-cli/src/main.rs`: delete the `use commands::truncate;` import (line 229) and the duplicate `test_truncate` test (lines 259-264).

6. In `synapse-telegram/src/commands.rs`: delete `truncate_content` (lines 89-96) and its test block. Replace the usage in `format_history` (line 124) with `synapse_core::text::truncate(&m.content, 150)`. Replace usages in `cmd_list` (line 321) and `build_session_keyboard` (line 391) with the shared function (these get named constants in Task 21.5).

7. In `synapse-core/src/storage/sqlite.rs`: replace inline truncation (lines 206-213) with:
   ```rust
   let preview = preview.map(|p| crate::text::truncate(&p, 50));
   ```

8. Verify: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-core/src/text.rs` (new), `synapse-core/src/lib.rs`, `synapse-cli/src/commands.rs`, `synapse-cli/src/main.rs`, `synapse-telegram/src/commands.rs`, `synapse-core/src/storage/sqlite.rs`

---

### Task 21.2: Consolidate OpenAI-compatible providers

**Goal:** Generic `OpenAiCompatProvider` struct eliminating duplicated `LlmProvider` implementations.

**Steps:**

1. In `synapse-core/src/provider/openai_compat.rs`, add:
   ```rust
   pub(super) struct OpenAiCompatProvider {
       client: reqwest::Client,
       base_url: String,
       api_key: String,
       model: String,
       max_tokens: u32,
   }
   ```
   With `new()` constructor and full `LlmProvider` implementation using the existing `build_api_messages`, `complete_request`, `stream_sse` helpers.

2. Rewrite `synapse-core/src/provider/deepseek.rs` as a newtype:
   ```rust
   pub struct DeepSeekProvider(pub(super) OpenAiCompatProvider);
   ```
   With `new()` that constructs the inner with the DeepSeek endpoint. Implement `LlmProvider` by delegating all methods to `self.0`.

3. Apply the same pattern to `synapse-core/src/provider/openai.rs`.

4. Update `synapse-core/src/provider/factory.rs` -- construction calls are unchanged since `DeepSeekProvider::new(api_key, model, max_tokens)` still works.

5. Update existing tests in `deepseek.rs` and `openai.rs` to access fields through the inner type:
   ```rust
   assert_eq!(provider.0.api_key, "test-key");
   ```

6. Verify: `cargo fmt --check && cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-core/src/provider/openai_compat.rs`, `synapse-core/src/provider/deepseek.rs`, `synapse-core/src/provider/openai.rs`

---

### Task 21.3: Deduplicate CLI session helpers

**Goal:** Single set of storage init and session load/create helpers shared between REPL and one-shot paths.

**Steps:**

1. Create `synapse-cli/src/session.rs` with:
   - `pub async fn init_storage(session_config: &SessionConfig) -> Result<Box<dyn SessionStore>>` -- creates storage via `create_storage()` and runs cleanup if `auto_cleanup` is true.
   - `pub async fn load_or_create_session(storage: &dyn SessionStore, config: &Config, session_id: Option<Uuid>) -> Result<(Session, Vec<StoredMessage>)>` -- either loads an existing session by ID or creates a new one.

2. Add `mod session;` to `synapse-cli/src/main.rs`.

3. Refactor `main.rs` REPL path (lines 70-77) to use `session::init_storage()`.

4. Refactor `main.rs` one-shot path (lines 94-128) to use both `session::init_storage()` and `session::load_or_create_session()`.

5. Refactor `synapse-cli/src/repl.rs` (lines 82-105) to accept the session and history from the caller (already resolved by `main.rs`) rather than resolving internally. The `run_repl` signature changes from `session_id: Option<Uuid>` to receiving the resolved `(Session, Vec<StoredMessage>)`.

6. Verify: `cargo build && cargo test`.

**Files changed:** `synapse-cli/src/session.rs` (new), `synapse-cli/src/main.rs`, `synapse-cli/src/repl.rs`

---

### Task 21.4: Deduplicate Telegram code

**Goal:** Centralize auth checks, session naming, reply constants, message limits, and keyboard builders.

**Steps:**

1. **`check_auth` helper**: In `handlers.rs`, add a function that extracts user_id, gets allowed_users from config, calls `is_authorized()`, and returns `Option<ResponseResult<()>>` (Some(Ok(())) for unauthorized, None for authorized). Replace the 3 inline auth blocks in `handle_message` (lines 66-74), `handle_command` (lines 62-71), and `handle_callback` (lines 645-653). For `handle_callback`, which receives a `CallbackQuery` not a `TgMessage`, create a variant or extract user_id differently.

2. **`tg_session_name` helper**: In `handlers.rs`, add `pub fn tg_session_name(chat_id: i64) -> String { format!("tg:{}", chat_id) }`. Replace 3 occurrences: `commands.rs` line 206, `commands.rs` line 544, `handlers.rs` line 203.

3. **`NO_SESSIONS_HINT` constant**: In `handlers.rs`, add `pub const NO_SESSIONS_HINT: &str = "No sessions. Send a message or use /new to start one.";`. Replace all 6 "No sessions" strings in `commands.rs` (lines 287, 306, 417, 445, 472, 512). The two shorter variants ("No sessions available.") should also use this constant for consistency.

4. **Unify `TELEGRAM_MSG_LIMIT`**: Keep the definition in `format.rs` (line 242) as `pub const TELEGRAM_MSG_LIMIT: usize = 4096;`. Delete the duplicate in `handlers.rs` (line 19) and import from `crate::format::TELEGRAM_MSG_LIMIT`.

5. **Merge keyboard builders**: Replace `cmd_switch_keyboard` and `cmd_delete_keyboard` with a single `build_action_keyboard(action: &str, prompt: &str, bot, msg, storage, chat_map)` that calls `fetch_chat_sessions`, handles `None` with `NO_SESSIONS_HINT`, and on `Some` calls `build_session_keyboard(action, ...)` with the appropriate prompt. `cmd_switch` and `cmd_delete` call this with `("switch", "Select a session to switch to:")` and `("delete", "Select a session to delete:")` respectively.

6. **`cmd_list` uses `fetch_chat_sessions`**: Refactor `cmd_list` to call `fetch_chat_sessions(chat_id, storage, chat_map)` instead of duplicating the session-fetch logic. Handle `None` with `NO_SESSIONS_HINT`.

7. Verify: `cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-telegram/src/handlers.rs`, `synapse-telegram/src/commands.rs`, `synapse-telegram/src/format.rs`

---

### Task 21.5: Remove dead code and extract constants

**Goal:** Remove unused `stream_with_tools()` and replace magic numbers with named constants.

**Steps:**

1. Remove `stream_with_tools()` from the `LlmProvider` trait in `synapse-core/src/provider.rs` (lines 136-146). The default implementation and doc comment are deleted.

2. Check for any overrides of `stream_with_tools()` in `anthropic.rs`, `openai_compat.rs`, `deepseek.rs`, `openai.rs`, `mock.rs`. The Anthropic provider overrides `stream_with_tools` (verify and remove if present). The OpenAI-compat providers do not override it (confirmed in research). Mock provider may have an override (verify and remove).

3. Update `CLAUDE.md`: remove `stream_with_tools` from the `LlmProvider` trait listing and the streaming section.

4. Update `README.md`: remove `stream_with_tools` references.

5. Extract named constants in `synapse-telegram/src/commands.rs`:
   - `const HISTORY_MESSAGE_LIMIT: usize = 10;` -- replaces `10` in `format_history`
   - `const HISTORY_TRUNCATE_CHARS: usize = 150;` -- replaces `150` in `format_history`
   - `const LIST_PREVIEW_MAX_CHARS: usize = 40;` -- replaces `40` in `cmd_list`
   - `const KEYBOARD_PREVIEW_MAX_CHARS: usize = 20;` -- replaces `20` in `build_session_keyboard`

6. Extract constant in `synapse-core/src/storage/sqlite.rs`:
   - `const SESSION_PREVIEW_MAX_CHARS: usize = 50;` -- replaces `50` in `list_sessions`

7. Verify: `cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-core/src/provider.rs`, `synapse-core/src/provider/anthropic.rs` (if override exists), `synapse-core/src/provider/mock.rs` (if override exists), `synapse-core/src/storage/sqlite.rs`, `synapse-telegram/src/commands.rs`, `CLAUDE.md`, `README.md`

---

### Task 21.6: Improve type safety

**Goal:** Typed `Rotation` enum and `Arc<dyn SessionStore>` throughout Telegram.

**Steps:**

1. In `synapse-core/src/config.rs`:
   - Add a `Rotation` enum with `Daily`, `Hourly`, `Never` variants.
   - Derive `Debug, Clone, PartialEq, Deserialize` with `#[serde(rename_all = "lowercase")]`.
   - Change `LoggingConfig.rotation` from `String` to `Rotation`.
   - Update `default_rotation()` to return `Rotation::Daily`.
   - Update `Default for LoggingConfig` accordingly.
   - Export `Rotation` from the module.

2. In `synapse-telegram/src/main.rs`, update the rotation match site (lines 68-78):
   ```rust
   let rotation = match lc.rotation {
       synapse_core::config::Rotation::Daily => tracing_appender::rolling::Rotation::DAILY,
       synapse_core::config::Rotation::Hourly => tracing_appender::rolling::Rotation::HOURLY,
       synapse_core::config::Rotation::Never => tracing_appender::rolling::Rotation::NEVER,
   };
   ```
   The `other =>` fallback arm is no longer needed since the enum is exhaustive.

3. Add deserialization tests in `config.rs` for each `Rotation` variant (`"daily"`, `"hourly"`, `"never"`).

4. Update existing config tests that assert `lc.rotation == "daily"` to assert `lc.rotation == Rotation::Daily`.

5. Replace `Arc<Box<dyn SessionStore>>` with `Arc<dyn SessionStore>` across all Telegram files:
   - `main.rs` line 141: change construction from `Arc::new(create_storage(...).await?)` to `Arc::from(create_storage(...).await?)` (since `Arc::from(Box<dyn T>)` gives `Arc<dyn T>`).
   - `main.rs` line 173: `rebuild_chat_map` call -- since `storage` is now `Arc<dyn SessionStore>`, change `storage.as_ref().as_ref()` to `storage.as_ref()`.
   - `commands.rs`: update all 13 function signatures that take `Arc<Box<dyn SessionStore>>` to `Arc<dyn SessionStore>`.
   - `handlers.rs`: update both function signatures (`handle_message`, `resolve_session`) similarly.
   - `dptree::deps![]`: the type changes automatically since the variable type changed.

6. Update mock store construction in tests if needed.

7. Verify: `cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-core/src/config.rs`, `synapse-telegram/src/main.rs`, `synapse-telegram/src/commands.rs`, `synapse-telegram/src/handlers.rs`

---

### Task 21.7: Apply small polish

**Goal:** Named layout constants, `ChatSessions::new()`, idiomatic patterns.

**Steps:**

1. In `synapse-cli/src/repl/render.rs`, extract named constants:
   ```rust
   const REPL_MIN_HISTORY_HEIGHT: u16 = 3;
   const REPL_INPUT_HEIGHT: u16 = 3;
   const REPL_STATUS_HEIGHT: u16 = 1;
   ```
   Use in the `Layout::vertical` call. Also use in `repl.rs` where the same layout is computed (if still present after Task 21.3 refactoring). The `saturating_sub(5)` magic number in `repl.rs` line 138 should use `REPL_INPUT_HEIGHT + REPL_STATUS_HEIGHT + border overhead`.

2. Add `ChatSessions::new(session_id: Uuid)` constructor in `handlers.rs`:
   ```rust
   impl ChatSessions {
       pub fn new(session_id: Uuid) -> Self {
           Self {
               sessions: vec![session_id],
               active_idx: 0,
           }
       }
   }
   ```
   Replace all struct literal constructions in source code where a single session is created: `handlers.rs` line 219, `commands.rs` lines 190, 526, `main.rs` line 285. Leave test constructions that need specific multi-session or custom `active_idx` values as struct literals.

3. Replace 4 `Ok(r) | Err(r) => r` patterns in `commands.rs` (lines 585, 620, 688, 691) with `.unwrap_or_else(|e| e)`:
   ```rust
   // Before
   let reply = match do_switch(n, chat_id, storage, chat_map).await {
       Ok(r) | Err(r) => r,
   };

   // After
   let reply = do_switch(n, chat_id, storage, chat_map).await.unwrap_or_else(|e| e);
   ```

4. Verify: `cargo clippy -- -D warnings && cargo test`.

**Files changed:** `synapse-cli/src/repl/render.rs`, `synapse-cli/src/repl.rs`, `synapse-telegram/src/handlers.rs`, `synapse-telegram/src/commands.rs`, `synapse-telegram/src/main.rs`

---

### Task 21.8: Split large modules

**Goal:** Break three 600+ line modules into focused submodules.

**Prerequisite:** Tasks 21.5 and 21.6 must be complete (dead code removed and `Arc<Box<dyn SessionStore>>` eliminated before splitting).

**Steps:**

1. **Split `synapse-telegram/src/commands.rs`** into:
   - `commands.rs` retains: `Command` enum, `handle_command` dispatcher, `cmd_start`, `cmd_help`, `cmd_new`, `cmd_history`, `cmd_list`, `cmd_switch`, `cmd_delete`, `parse_session_arg`, helper functions, and their tests.
   - `commands/keyboard.rs` receives: `build_action_keyboard` (from Task 21.4), `build_session_keyboard`, `parse_callback_data`, `do_switch`, `do_delete`, `handle_callback`, `fetch_chat_sessions`, and their tests.
   - In `commands.rs`, add `mod keyboard;` and `pub use keyboard::handle_callback;` (needed by the dispatcher in `main.rs`).
   - Re-export any other public symbols needed by `main.rs` or other modules.

2. **Split `synapse-telegram/src/format.rs`** into:
   - `format.rs` retains: `escape_html`, `md_to_telegram_html`, and their tests.
   - `format/chunk.rs` receives: `TELEGRAM_MSG_LIMIT`, `OpenTag`, `chunk_html`, `floor_char_boundary`, `find_split_point`, `update_open_tags`, and their tests.
   - In `format.rs`, add `mod chunk;` and `pub use chunk::{chunk_html, floor_char_boundary, TELEGRAM_MSG_LIMIT};` (needed by `handlers.rs`).

3. **Split `synapse-core/src/provider/anthropic.rs`** into:
   - `anthropic.rs` retains: `AnthropicProvider` struct, `new()`, helper methods, `LlmProvider` impl, streaming, and tests.
   - `anthropic/types.rs` receives: `ApiRequest`, `AnthropicTool`, `ApiContent`, `ApiMessage`, `ApiResponse`, `ContentBlock`, `ApiError`, `ErrorDetail` serde structs.
   - In `anthropic.rs`, add `mod types;` and `use types::*;` (or selective imports). Types are `pub(super)` or `pub(crate)` since they are internal.

4. Verify after each split: `cargo build && cargo test`.

5. No `mod.rs` files. Directory structure:
   ```
   synapse-telegram/src/
   +-- commands.rs           # declares mod keyboard;
   +-- commands/
   |   +-- keyboard.rs
   +-- format.rs             # declares mod chunk;
   +-- format/
   |   +-- chunk.rs

   synapse-core/src/provider/
   +-- anthropic.rs           # declares mod types;
   +-- anthropic/
   |   +-- types.rs
   ```

**Files changed:** `synapse-telegram/src/commands.rs`, `synapse-telegram/src/commands/keyboard.rs` (new), `synapse-telegram/src/format.rs`, `synapse-telegram/src/format/chunk.rs` (new), `synapse-core/src/provider/anthropic.rs`, `synapse-core/src/provider/anthropic/types.rs` (new)

---

## 8. Implementation Order and Dependencies

```
Task 21.1 (Unify truncation)
  |
  +--> Task 21.2 (Consolidate providers)    [independent of 21.1]
  |
  +--> Task 21.3 (CLI session helpers)      [independent of 21.1, 21.2]
  |
  v
Task 21.4 (Telegram dedup)                  [can use truncate from 21.1]
  |
  v
Task 21.5 (Dead code + constants)           [must complete before 21.8]
  |
  v
Task 21.6 (Type safety)                     [must complete before 21.8]
  |
  v
Task 21.7 (Small polish)                    [depends on 21.4 for ChatSessions::new context, 21.6 for type changes]
  |
  v
Task 21.8 (Split large modules)             [depends on 21.5, 21.6 being complete]
```

Recommended sequential order: **21.1 -> 21.2 -> 21.3 -> 21.4 -> 21.5 -> 21.6 -> 21.7 -> 21.8**

This order matches the PRD's specified constraints:
- 21.1 completes first (later tasks use the shared function)
- 21.5 completes before 21.8 (no dead code carried into new submodule)
- 21.6 completes before 21.8 (no old `Arc<Box<...>>` type propagated into new files)

---

## 9. Open Questions

### Question 1: `ChatSessions::new()` vs empty construction

Some call sites create `ChatSessions` with an empty `sessions` vec (e.g., `or_insert_with(|| ChatSessions { sessions: vec![], active_idx: 0 })`). The PRD specifies `ChatSessions::new(session_id: Uuid)` for single-session construction. Should we also add `ChatSessions::default()` or `ChatSessions::empty()` for zero-session constructions?

**Recommendation:** Leave empty constructions as `ChatSessions { sessions: vec![], active_idx: 0 }` struct literals since they are rare (2 occurrences in `or_insert_with` patterns) and express a different semantic. The `new(session_id)` constructor covers the common case (13+ sites constructing with one session). Alternatively, derive `Default` on `ChatSessions` to cover the empty case idiomatically.

### Question 2: CLI helper module naming

The PRD says "Extract `load_or_create_session()` shared between `main.rs` and `repl.rs`" but does not specify the filename. This plan uses `synapse-cli/src/session.rs` as it clearly describes the module's purpose. Alternative: `helpers.rs` (too generic).

**Recommendation:** Use `session.rs` for clarity.
