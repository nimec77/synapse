# SY-15 Plan: File Logging (Phase 14)

Status: PLAN_APPROVED

## Overview

Add file-based logging with automatic rotation to the Telegram bot (`synapse-telegram`). Define `LoggingConfig` in `synapse-core/src/config.rs`, add `tracing-appender` to `synapse-telegram`, and rewrite the tracing initialization to use a layered subscriber that outputs to both stdout and a rolling file appender. Only `synapse-telegram` gets file logging; `synapse-cli` remains stdout-only. Omitting the `[logging]` section preserves the current stdout-only behavior (backward compatible).

## Components

### 1. LoggingConfig Struct (`synapse-core/src/config.rs`)

Add a `LoggingConfig` struct with three fields and serde defaults, following the exact same pattern as `SessionConfig`.

#### 1.1 Struct Definition

```rust
/// File-based logging configuration with rotation.
///
/// Deserialized from the `[logging]` section in `config.toml`.
/// Omit the section entirely to disable file logging (stdout only).
#[derive(Debug, Clone, PartialEq, Deserialize)]
pub struct LoggingConfig {
    /// Directory to write log files to (relative or absolute path).
    #[serde(default = "default_log_directory")]
    pub directory: String,

    /// Maximum number of rotated log files to keep.
    /// Oldest files are deleted when this limit is exceeded.
    #[serde(default = "default_max_files")]
    pub max_files: usize,

    /// Rotation strategy: "daily", "hourly", or "never".
    #[serde(default = "default_rotation")]
    pub rotation: String,
}
```

**Field types and defaults** (from phase-14.md requirements):
- `directory: String` -- default `"logs"`
- `max_files: usize` -- default `7`
- `rotation: String` -- default `"daily"`

**Requirement source:** Phase-14 task 14.1, PRD Constraint 1, PRD Constraint 6.

#### 1.2 Default Value Functions

```rust
fn default_log_directory() -> String {
    "logs".to_string()
}

fn default_max_files() -> usize {
    7
}

fn default_rotation() -> String {
    "daily".to_string()
}
```

**Pattern followed:** Identical to `default_max_sessions()`, `default_retention_days()`, `default_auto_cleanup()` in the same file.

#### 1.3 Default Impl

```rust
impl Default for LoggingConfig {
    fn default() -> Self {
        Self {
            directory: default_log_directory(),
            max_files: default_max_files(),
            rotation: default_rotation(),
        }
    }
}
```

**Pattern followed:** Identical to `SessionConfig::default()` implementation.

#### 1.4 Config Struct Change

Add `logging: Option<LoggingConfig>` to the `Config` struct, after `telegram`:

```rust
/// File logging configuration (rotation, directory, max files).
#[serde(default)]
pub logging: Option<LoggingConfig>,
```

Following the existing `Option<T>` + `#[serde(default)]` pattern used by `session`, `mcp`, and `telegram`.

#### 1.5 Config::default() Update

Add `logging: None` to the `Default` implementation for `Config` (after `telegram: None`).

#### 1.6 lib.rs Re-export Update

Update `synapse-core/src/lib.rs` line 15 to include `LoggingConfig`:

```rust
pub use config::{Config, ConfigError, LoggingConfig, McpSettings, SessionConfig, TelegramConfig};
```

#### 1.7 Tests

Five new unit tests in `synapse-core/src/config.rs`:

| Test | Purpose |
|------|---------|
| `test_logging_config_defaults` | `LoggingConfig::default()` returns `directory = "logs"`, `max_files = 7`, `rotation = "daily"` |
| `test_config_without_logging_section` | Parse TOML without `[logging]`, verify `config.logging.is_none()` |
| `test_config_with_logging_section` | Parse TOML with all custom `[logging]` fields, verify all fields match |
| `test_config_with_logging_section_partial_defaults` | Parse TOML with only `[logging]\ndirectory = "/tmp/logs"`, verify `max_files` and `rotation` get defaults |
| `test_config_with_empty_logging_section` | Parse TOML with just `[logging]`, verify all fields get their defaults |

### 2. Dependencies (`synapse-telegram/Cargo.toml`)

#### 2.1 Add `tracing-appender`

```toml
tracing-appender = "0.2"
```

Version 0.2.4 (latest) is compatible with `tracing-subscriber 0.3.x`. Both are part of the `tokio-rs/tracing` ecosystem.

#### 2.2 Add `registry` Feature to `tracing-subscriber`

```toml
tracing-subscriber = { version = "0.3", features = ["env-filter", "registry"] }
```

The `registry` feature enables `tracing_subscriber::registry()` and the layered subscriber pattern (`.with()` combinator).

**No new dependencies for `synapse-core`.** `LoggingConfig` is a plain data struct using only `serde::Deserialize`, which is already a dependency.

**Requirement source:** Phase-14 task 14.2, PRD Constraint 2, PRD Constraint 3.

### 3. Layered Tracing Initialization (`synapse-telegram/src/main.rs`)

Rewrite the tracing initialization to conditionally set up either stdout-only or stdout+file based on `config.logging`.

#### 3.1 Reorder: Config Before Tracing

The current `main()` initializes tracing at line 25 and loads config at line 35. Since file logging depends on config, the order must be reversed:

**Current flow:**
1. Initialize tracing (line 25)
2. Log startup (line 32)
3. Load config (line 35)

**New flow:**
1. Load config (moved up)
2. Initialize tracing (conditional based on `config.logging`)
3. Log startup

Config loading errors that would have been logged via `tracing::warn!` are silently dropped since tracing is not yet initialized. This is acceptable because the fallback to `Config::default()` means file logging will be disabled anyway (logging is `None`).

**Requirement source:** Research document "Reordering in main()" section.

#### 3.2 Case 1: No `[logging]` Section (stdout-only)

When `config.logging` is `None`, preserve the current stdout-only behavior exactly:

```rust
tracing_subscriber::fmt()
    .with_env_filter(
        tracing_subscriber::EnvFilter::from_default_env()
            .add_directive("synapse_telegram=info".parse()?),
    )
    .init();
```

No file I/O, no guard needed. Identical to the current implementation.

**Requirement source:** PRD Scenario 3, PRD User Story 5.

#### 3.3 Case 2: `[logging]` Section Present (stdout + file)

When `config.logging` is `Some(logging_config)`:

**Step 1: Create log directory**

```rust
if let Err(e) = std::fs::create_dir_all(&logging_config.directory) {
    eprintln!(
        "Warning: Failed to create log directory '{}': {}. Falling back to stdout-only.",
        logging_config.directory, e
    );
    // Fall back to stdout-only initialization
    // ...
}
```

If directory creation fails, fall back to stdout-only with a warning to stderr (not tracing, since it is not initialized yet).

**Step 2: Map rotation string**

```rust
let rotation = match logging_config.rotation.as_str() {
    "daily" => tracing_appender::rolling::Rotation::DAILY,
    "hourly" => tracing_appender::rolling::Rotation::HOURLY,
    "never" => tracing_appender::rolling::Rotation::NEVER,
    other => {
        eprintln!(
            "Warning: Unknown rotation '{}', falling back to daily",
            other
        );
        tracing_appender::rolling::Rotation::DAILY
    }
};
```

Valid values: `"daily"`, `"hourly"`, `"never"`. Unknown values fall back to `DAILY` with a warning.

**Requirement source:** PRD Constraint 7.

**Step 3: Build rolling file appender**

```rust
let file_appender = tracing_appender::rolling::RollingFileAppender::builder()
    .rotation(rotation)
    .filename_prefix("synapse-telegram")
    .max_log_files(logging_config.max_files)
    .build(&logging_config.directory)
    .context("Failed to create rolling file appender")?;
```

The builder pattern is the recommended API for `tracing-appender 0.2.4`. The `filename_prefix("synapse-telegram")` with `filename_suffix("log")` and `Rotation::DAILY` produces files named `synapse-telegram.YYYY-MM-DD.log`.

**Requirement source:** PRD Constraint 5.

**Step 4: Wrap in non-blocking writer**

```rust
let (non_blocking, _guard) = tracing_appender::non_blocking(file_appender);
```

The `_guard` (type `WorkerGuard`) flushes buffered logs when dropped. It **must** be stored as `let _guard = ...` in `main()` before the dispatcher loop so it outlives the entire dispatch cycle.

**Requirement source:** PRD Constraint 4, PRD Risk "Non-blocking writer guard dropped too early".

**Step 5: Build layered subscriber**

```rust
use tracing_subscriber::prelude::*;

let env_filter = tracing_subscriber::EnvFilter::from_default_env()
    .add_directive("synapse_telegram=info".parse()?);

let stdout_layer = tracing_subscriber::fmt::layer();

let file_layer = tracing_subscriber::fmt::layer()
    .with_writer(non_blocking)
    .with_ansi(false);  // No ANSI color codes in file output

tracing_subscriber::registry()
    .with(env_filter)
    .with(stdout_layer)
    .with(file_layer)
    .init();
```

The `env_filter` is applied globally on the registry so both stdout and file layers inherit the same log level filtering. The file layer disables ANSI escape codes since they are unreadable in log files.

**Requirement source:** Phase-14 task 14.3, PRD Scenario 1, PRD Scenario 2.

#### 3.4 Guard Lifetime

The `_guard` variable must be declared before the dispatcher loop (currently lines 108-118) so Rust's drop ordering ensures it outlives the dispatcher. The variable is declared in `main()` and lives until `main()` returns.

The guard must be declared as an `Option<WorkerGuard>` to handle both the file-logging case (`Some(guard)`) and the stdout-only case (`None`). This allows a single `let _guard: Option<...>` binding regardless of which branch is taken.

```rust
let _guard: Option<tracing_appender::non_blocking::WorkerGuard>;
```

In the stdout-only branch, `_guard = None`. In the file-logging branch, `_guard = Some(guard)`.

#### 3.5 Complete main() Structure

```rust
#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // 1. Load config FIRST (before tracing, because tracing depends on config).
    let config = Config::load().unwrap_or_else(|e| {
        eprintln!("Warning: Failed to load config, using defaults: {}", e);
        Config::default()
    });

    // 2. Initialize tracing (stdout-only or stdout+file based on config).
    let _guard = init_tracing(&config)?;

    tracing::info!("Starting Synapse Telegram Bot");

    // 3. Resolve bot token ... (rest of main unchanged)
}
```

The tracing initialization logic is extracted into a helper function `init_tracing()` for clarity, returning `Option<WorkerGuard>`.

### 4. `init_tracing()` Helper Function

A new private function in `synapse-telegram/src/main.rs`:

```rust
/// Initialize the tracing subscriber.
///
/// When `config.logging` is `Some`, creates a layered subscriber with both
/// stdout and rolling file output. When `None`, uses stdout-only (current behavior).
///
/// Returns the non-blocking writer guard that must be held for the process lifetime.
fn init_tracing(
    config: &Config,
) -> anyhow::Result<Option<tracing_appender::non_blocking::WorkerGuard>> {
    // ... implementation as described in 3.2 and 3.3
}
```

This function returns `Ok(None)` for stdout-only and `Ok(Some(guard))` for file logging.

### 5. config.example.toml (NO CHANGE)

The `[logging]` section already exists at lines 70-80 as commented-out documentation with all three fields documented. Research confirmed this is already complete. **No changes needed.**

**Requirement source:** Phase-14 task 14.4. Research confirmed: "already complete and matches the PRD."

### 6. Documentation Updates (NO CHANGE for idea.md and vision.md)

**`docs/idea.md`:** Already mentions file-based logging at line 19. No change needed.

**`docs/vision.md`:** Already has the "File Logging (Telegram Bot)" section (lines 569-575) and `tracing-appender` in the dependency table (line 32). No change needed.

**`docs/tasklist.md`:** Task checkboxes need to be checked off and the Phase 14 row updated to "Complete" after implementation. This is done during the commit phase.

**Requirement source:** Phase-14 task 14.5. Research confirmed all docs already reference file logging.

## API Contract

### Internal: Config TOML

```toml
# New optional section:
[logging]
directory = "logs"       # Default: "logs"
max_files = 7            # Default: 7
rotation = "daily"       # Default: "daily". Options: "daily", "hourly", "never"
```

All fields have defaults. An empty `[logging]` section enables file logging with all defaults. Omitting the section entirely preserves stdout-only behavior.

### Internal: LoggingConfig API

```rust
/// New struct in synapse-core/src/config.rs:
pub struct LoggingConfig {
    pub directory: String,    // Default: "logs"
    pub max_files: usize,     // Default: 7
    pub rotation: String,     // Default: "daily"
}

/// New field on Config:
pub logging: Option<LoggingConfig>,
```

No new traits, errors, or other module-level types needed. `LoggingConfig` is a pure data struct.

### External: No Public API Changes

No changes to `LlmProvider`, `SessionStore`, `Agent`, or any other public API. The file logging feature is entirely internal to `synapse-telegram` initialization.

## Data Flows

### Flow 1: File Logging Enabled with Defaults

```
1. User adds `[logging]` (empty section) to config.toml
2. Config::load() parses [logging] -> Some(LoggingConfig::default())
3. main() loads config BEFORE tracing init
4. init_tracing() sees config.logging = Some(...)
5. std::fs::create_dir_all("logs") creates directory
6. RollingFileAppender built with rotation=DAILY, prefix="synapse-telegram", max_files=7
7. non_blocking() wraps appender, returns (writer, guard)
8. registry() + stdout_layer + file_layer + env_filter -> init()
9. _guard stored in main() scope
10. All tracing::info!/warn!/etc. output to BOTH stdout AND logs/synapse-telegram.YYYY-MM-DD.log
11. After 7 days of daily rotation, oldest file deleted by tracing-appender
12. When main() returns, _guard dropped -> flushes remaining buffered logs
```

### Flow 2: File Logging with Custom Config

```
1. User sets [logging] with directory="/var/log/synapse", max_files=30, rotation="hourly"
2. Config parses to LoggingConfig { directory: "/var/log/synapse", max_files: 30, rotation: "hourly" }
3. init_tracing() maps "hourly" -> Rotation::HOURLY
4. create_dir_all("/var/log/synapse") creates directory
5. RollingFileAppender with HOURLY rotation, max 30 files
6. Files named: /var/log/synapse/synapse-telegram.YYYY-MM-DD-HH.log
7. After 30 rotated files, oldest deleted
```

### Flow 3: File Logging Disabled (Backward Compatible)

```
1. No [logging] section in config.toml
2. Config parses to config.logging = None
3. init_tracing() takes stdout-only branch
4. tracing_subscriber::fmt().with_env_filter(...).init() -- identical to current behavior
5. Returns None (no guard needed)
6. No file I/O for logging
```

### Flow 4: CLI Unaffected

```
1. synapse-cli does not read or act on [logging] config
2. synapse-cli does not use tracing at all (uses eprintln!/println!)
3. Zero changes to synapse-cli
```

### Flow 5: Directory Creation Failure Fallback

```
1. User sets [logging] with directory = "/read-only-path/logs"
2. init_tracing() calls std::fs::create_dir_all("/read-only-path/logs")
3. create_dir_all fails (permission denied)
4. Warning printed to stderr (tracing not yet initialized)
5. Falls back to stdout-only initialization
6. Bot starts normally, just without file logging
```

## Non-Functional Requirements

1. **Backward compatibility:** Omitting `[logging]` produces `config.logging = None`, which initializes the same stdout-only subscriber as the current implementation. Zero behavior change for existing deployments.

2. **No core dependency changes:** `synapse-core` gains no new Cargo dependencies. `LoggingConfig` uses only `serde::Deserialize` (already present). `tracing-appender` is added only to `synapse-telegram`.

3. **No CLI changes:** `synapse-cli` is completely unaffected. It does not use tracing and does not read the `[logging]` section.

4. **Non-blocking I/O:** `tracing-appender` uses a non-blocking writer with a dedicated background thread. File writes do not block the Tokio async runtime. This satisfies the convention "No blocking I/O in async functions."

5. **Guard lifetime:** The `WorkerGuard` is held for the entire process lifetime in `main()`, ensuring all buffered log data is flushed on shutdown.

6. **100 character line limit:** All new code respects the project's line limit.

7. **No `unwrap()`/`expect()` in `synapse-core`:** The `LoggingConfig` struct uses only serde defaults and `Default` impl -- no error-prone unwrapping.

8. **Doc comments on all `pub` items:** `LoggingConfig` struct and all three fields get `///` doc comments.

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `RollingFileAppender::builder().build()` returns `Err` on invalid directory | Low | Medium | Create directory with `std::fs::create_dir_all()` before building. If directory creation fails, fall back to stdout-only with a warning to stderr. |
| Non-blocking writer guard dropped early (moved into spawned task) | Low | High | Declare `_guard` as a local binding in `main()` before the dispatcher loop. Rust's drop order guarantees it outlives the dispatcher. |
| Config loaded before tracing is initialized (silent log drops) | Low | Low | Config loading errors fall back to `Config::default()`, which has `logging: None`. Stdout-only tracing is initialized afterward, so subsequent logging works. Early config error messages go to stderr instead. |
| `max_log_files` behavior differs across `tracing-appender` versions | Low | Low | v0.2.4 builder docs confirm: "Keeps the last n log files on disk. When a new file is created, if the total number exceeds the max, the oldest is deleted." |
| `rotation` field accepts invalid strings silently | Low | Low | Map unknown values to `Rotation::DAILY` with an `eprintln!` warning. Document valid values in config.example.toml (already done). |
| File appender failure blocks bot startup | Low | High | If `build()` fails after successful directory creation, the error propagates via `?` and the bot fails to start. This is acceptable -- a misconfigured logging section should be a startup error, not silently ignored. |
| `tracing-appender 0.2` incompatible with `tracing-subscriber 0.3` | None | High | Both are from `tokio-rs/tracing` ecosystem. `tracing-subscriber 0.3.22` is already in the lockfile. `tracing-appender 0.2.4` is confirmed compatible. |

## Deviations to Fix

**None.** The research document confirms zero deviations between the existing codebase and the requirements:

- `config.example.toml` already has the `[logging]` section documented (lines 70-80).
- `docs/vision.md` already mentions `tracing-appender` and file logging (line 32, lines 569-575).
- `docs/idea.md` already mentions file-based logging (line 19).
- The `Config` struct follows a consistent `Option<T>` pattern for optional sections.
- `tracing-subscriber 0.3.22` is already in use and compatible with `tracing-appender 0.2.4`.
- The layered subscriber approach (`registry()` + `.with()`) is the standard `tracing-subscriber` pattern.

## Testing Strategy

### Unit Tests: synapse-core/src/config.rs (5 tests)

| Test | Purpose |
|------|---------|
| `test_logging_config_defaults` | `LoggingConfig::default()` returns `directory = "logs"`, `max_files = 7`, `rotation = "daily"` |
| `test_config_without_logging_section` | TOML without `[logging]` parses to `config.logging.is_none()` |
| `test_config_with_logging_section` | TOML with `[logging]\ndirectory = "/var/log/synapse"\nmax_files = 30\nrotation = "hourly"` parses correctly |
| `test_config_with_logging_section_partial_defaults` | TOML with `[logging]\ndirectory = "/tmp/logs"` gives `max_files = 7`, `rotation = "daily"` (defaults) |
| `test_config_with_empty_logging_section` | TOML with just `[logging]` gives all defaults |

### Integration / Manual Tests for synapse-telegram

The tracing initialization logic involves filesystem I/O plus the tracing global subscriber singleton. These are best tested manually:

1. Start bot with `[logging]` section -- verify log directory created and file appears.
2. Start bot without `[logging]` section -- verify stdout-only behavior.
3. Start bot with custom rotation/directory -- verify correct file naming.
4. Start bot with invalid rotation value -- verify fallback to daily with warning.

### Regression

All existing `cargo test` must pass. The changes are additive:
- New optional field on `Config` (serde-defaulted to `None`)
- New struct `LoggingConfig` (plain data struct)
- `synapse-telegram` tracing init rewrite (no test impact -- tracing init is in `main()`)

### Pre-commit Gate

```bash
cargo fmt --check && cargo clippy -- -D warnings && cargo test
```

**Total: 5 new unit tests (all in config.rs).**

## File Changes Summary

| File | Change Type | Description |
|------|-------------|-------------|
| `synapse-core/src/config.rs` | Modify | Add `LoggingConfig` struct, default functions, `Default` impl, `logging` field on `Config`, update `Config::default()`, add 5 tests |
| `synapse-core/src/lib.rs` | Modify | Add `LoggingConfig` to re-export list (line 15) |
| `synapse-telegram/Cargo.toml` | Modify | Add `tracing-appender = "0.2"`, add `"registry"` feature to `tracing-subscriber` |
| `synapse-telegram/src/main.rs` | Modify | Reorder config/tracing init, add `init_tracing()` helper, use layered subscriber when `config.logging` is `Some` |
| `docs/tasklist.md` | Modify | Check off task 14.1-14.5 checkboxes, update Phase 14 status to "Complete" |

### Files NOT Modified

- `synapse-core/Cargo.toml` -- No new dependencies needed in core.
- `synapse-cli/src/main.rs` -- CLI is unaffected; no file logging.
- `synapse-cli/src/repl.rs` -- CLI is unaffected.
- `config.example.toml` -- Already has the `[logging]` section documented.
- `docs/idea.md` -- Already mentions file-based logging.
- `docs/vision.md` -- Already mentions `tracing-appender` and file logging section.

## Implementation Order

1. **Task 14.1** -- Add `LoggingConfig` struct + field on `Config` + `Default` impl + `lib.rs` re-export + 5 unit tests (no external dependencies)
2. **Task 14.2** -- Add `tracing-appender` dependency and `registry` feature to `synapse-telegram/Cargo.toml` (independent of 14.1)
3. **Task 14.3** -- Rewrite tracing init in `synapse-telegram/src/main.rs`: reorder config/tracing, add `init_tracing()` helper, implement layered subscriber (depends on 14.1 + 14.2)
4. **Task 14.4** -- Verify `config.example.toml` (already complete -- no code changes needed)
5. **Task 14.5** -- Update `docs/tasklist.md` progress checkboxes and status (done after implementation)

Tasks 14.1 and 14.2 can be executed in parallel. Task 14.3 depends on both. Tasks 14.4 and 14.5 are verification/documentation-only and are done last.

## Open Questions

None. The requirements are well-defined, the research document confirmed zero deviations, the `tracing-appender` API is documented and version-compatible, and the `config.example.toml` already contains the `[logging]` section. All five tasks have concrete scope with clear file locations.
