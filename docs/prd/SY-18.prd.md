# SY-18: Phase 18 — Telegram Bot Commands

Status: PRD_READY

## Context / Idea

**Short Title:** Phase 18: Telegram Bot Commands

**Description File:** `docs/phase/phase-18.md`

The Synapse Telegram bot currently handles all incoming text messages as LLM conversation input — there is no way for users to manage sessions, start new conversations, review history, or get help via bot commands. This phase adds slash command support to the Telegram bot with multi-session management per chat and a configurable session cap.

Currently, the `rebuild_chat_map` function in `synapse-telegram/src/main.rs` maps each chat ID to a single session UUID (`HashMap<i64, Uuid>`). This must change to support multiple sessions per chat. The `ChatSessionMap` type alias in `handlers.rs` (`Arc<RwLock<HashMap<i64, Uuid>>>`) and all related logic must be updated accordingly.

The `chrono` crate is currently a dev-dependency in `synapse-telegram/Cargo.toml` but will be needed at runtime for timestamp formatting in `/history` and `/list` output.

## Goals

1. **Slash command interface** — Implement six Telegram bot commands (`/help`, `/new`, `/history`, `/list`, `/switch N`, `/delete N`) to give users control over their chat sessions.
2. **Multi-session support** — Allow each Telegram chat to have multiple concurrent sessions, with the ability to switch between them.
3. **Session cap enforcement** — Add a configurable `max_sessions_per_chat` setting to `TelegramConfig` that auto-deletes the oldest session when the cap is exceeded during `/new`.
4. **Improved onboarding** — The `/help` command gives users a discoverable overview of available commands.
5. **Backward compatibility** — Existing single-session chats continue to work; the active session concept is preserved and non-command messages still route to the current active session.

## User Stories

1. **As a Telegram user**, I want to type `/help` so I can see all available bot commands and their descriptions.
2. **As a Telegram user**, I want to type `/new` so I can start a fresh conversation session without losing my previous one.
3. **As a Telegram user**, I want to type `/history` so I can review the conversation in my current session.
4. **As a Telegram user**, I want to type `/list` so I can see all my sessions for this chat with their timestamps and previews.
5. **As a Telegram user**, I want to type `/switch 2` so I can resume a previous conversation session by its index number.
6. **As a Telegram user**, I want to type `/delete 3` so I can remove a session I no longer need.
7. **As an administrator**, I want to set `max_sessions_per_chat` in my config so I can control resource usage per chat.

## Main Scenarios

### Scenario 1: `/help` Command
- **Given** an authorized user in a Telegram chat
- **When** they send `/help`
- **Then** the bot replies with a formatted list of all available commands and their descriptions

### Scenario 2: `/new` Command (Under Cap)
- **Given** an authorized user with fewer sessions than `max_sessions_per_chat`
- **When** they send `/new`
- **Then** a new session is created for this chat, becomes the active session, and the bot confirms with a message

### Scenario 3: `/new` Command (At Cap)
- **Given** an authorized user who already has `max_sessions_per_chat` sessions
- **When** they send `/new`
- **Then** the oldest session (by `last_active` / `updated_at`) is automatically deleted, a new session is created, and the bot confirms (optionally noting the eviction)

### Scenario 4: `/history` Command
- **Given** an authorized user with an active session containing messages
- **When** they send `/history`
- **Then** the bot replies with the conversation history from the current session, with role labels and timestamps formatted using `chrono`

### Scenario 5: `/list` Command
- **Given** an authorized user with multiple sessions in this chat
- **When** they send `/list`
- **Then** the bot replies with a numbered list of sessions showing 1-based index, creation/last-active timestamps, message count, and preview text

### Scenario 6: `/switch N` Command (Valid Index)
- **Given** an authorized user with multiple sessions and valid index N
- **When** they send `/switch N` (1-based index)
- **Then** the active session for this chat changes to the Nth session, and the bot confirms the switch

### Scenario 7: `/switch N` Command (Invalid Index)
- **Given** an authorized user who sends `/switch 99` where index 99 does not exist
- **When** the bot processes the command
- **Then** the bot replies with an error message indicating the index is invalid and suggesting `/list`

### Scenario 8: `/delete N` Command (Valid Index, Not Active)
- **Given** an authorized user who sends `/delete N` where N is a valid but non-active session
- **When** the bot processes the command
- **Then** the session is deleted from storage and the chat map, and the bot confirms deletion

### Scenario 9: `/delete N` Command (Active Session)
- **Given** an authorized user who sends `/delete N` where N is the currently active session
- **When** the bot processes the command
- **Then** the session is deleted and a new session is automatically created (or the next most recent session becomes active), and the bot confirms

### Scenario 10: Regular Text Message
- **Given** an authorized user who sends a non-command text message
- **When** the bot processes it
- **Then** it routes to the current active session as before (no behavioral change for non-command messages)

## Success / Metrics

- All six commands (`/help`, `/new`, `/history`, `/list`, `/switch N`, `/delete N`) respond correctly when tested manually via Telegram.
- Session cap eviction works: creating session N+1 when `max_sessions_per_chat = N` auto-deletes the oldest session.
- `rebuild_chat_map` correctly restores multiple sessions per chat on bot restart.
- `set_my_commands` registers the command list with Telegram so users see autocomplete suggestions.
- Existing single-session behavior is preserved for non-command messages.
- All existing tests pass; new unit tests cover command logic, multi-session `rebuild_chat_map`, and `max_sessions_per_chat` config deserialization.
- `cargo fmt --check && cargo clippy -- -D warnings && cargo test` passes cleanly.

## Constraints and Assumptions

### Constraints
- `Command` enum must derive `teloxide::utils::command::BotCommands` for integration with the teloxide dispatcher and `set_my_commands`.
- `/switch N` and `/delete N` take a **1-based index** into the session list for the current chat.
- `max_sessions_per_chat` defaults to `10` via serde default and is enforced only in the `/new` handler.
- The oldest session is determined by `updated_at` (last active time) when evicting for cap enforcement.
- `chrono` must move from `[dev-dependencies]` to `[dependencies]` in `synapse-telegram/Cargo.toml` for runtime timestamp formatting.
- `synapse-core` must not import from interface crates (hexagonal architecture rule).
- The `Me` type from teloxide must be injected into the dispatcher for `BotCommands::parse` support.

### Assumptions
- The `ChatSessionMap` type will change from `Arc<RwLock<HashMap<i64, Uuid>>>` to a structure supporting multiple sessions per chat (e.g., `Arc<RwLock<HashMap<i64, Vec<Uuid>>>>` or similar with an "active session" concept).
- The `rebuild_chat_map` function must be updated to collect multiple `tg:<chat_id>` sessions per chat ID instead of just one.
- Session naming convention remains `"tg:<chat_id>"` for all Telegram sessions (used by `rebuild_chat_map` for discovery).
- Authorization checks apply to all commands (same `allowed_users` mechanism as regular messages).
- The branched dispatcher pattern (`dptree::case!` or `Update::filter_message().branch(...)`) is used to route commands vs. regular messages.

## Risks

1. **Chat map migration complexity** — Changing `ChatSessionMap` from single-UUID to multi-UUID-with-active affects `resolve_session` in `handlers.rs` and `rebuild_chat_map` in `main.rs`. Both must be updated atomically to avoid data inconsistency.
2. **Session ordering consistency** — The 1-based index in `/switch` and `/delete` depends on a consistent ordering of sessions (by `updated_at`). If `list_sessions` returns a different order than what the user sees in `/list`, wrong sessions could be switched/deleted. The ordering must be deterministic and match.
3. **Race conditions** — Multiple commands from the same chat could race (e.g., `/new` + `/delete` simultaneously). The existing `RwLock` pattern mitigates this but careful lock scoping is required.
4. **Telegram API command registration** — `set_my_commands` must be called at startup. If it fails, commands still work but users won't see autocomplete suggestions.

## Open Questions

None — the description file provides sufficient detail for implementation.
