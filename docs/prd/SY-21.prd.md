# SY-21: Phase 21 â€” Code Refactoring II

Status: PRD_READY

## Context / Idea

**Arguments:** SY-21 docs/phase/phase-21.md

**Goal:** Eliminate accumulated duplication, magic values, dead code, and oversized modules without changing external behaviour.

Since the first refactoring pass (SY-16), several phases of feature work (SY-17 through SY-20) have introduced new duplications and grown existing modules. Key issues identified in the codebase:

- **Duplicated truncation logic**: `truncate` in `synapse-cli/src/commands.rs` (line 145), `truncate_content` in `synapse-telegram/src/commands.rs` (line 89), and inline char-safe truncation in `synapse-core/src/storage/sqlite.rs` (line 208) all perform the same operation. A duplicate `test_truncate` unit test lives in `synapse-cli/src/main.rs` (line 259).
- **DeepSeek/OpenAI near-identical providers**: `deepseek.rs` (129 lines) and `openai.rs` (112 lines) are thin wrappers over `openai_compat.rs` (775 lines) but each still has its own struct with identical fields and duplicated `LlmProvider` trait method implementations. These can be consolidated into a single generic `OpenAiCompatProvider`.
- **CLI session init duplication**: `synapse-cli/src/main.rs` creates storage and runs cleanup in two places (REPL path at lines 71-77, one-shot path at lines 96-103). Session load-or-create logic (lines 106-128) is also duplicated between `main.rs` and `repl.rs`.
- **Telegram duplication**: Auth checks are inline in both `handlers.rs` (line 73) and `commands.rs` (lines 69, 651). The `format!("tg:{}", chat_id)` session naming pattern appears in three places. "No sessions" reply strings are duplicated 6 times. `TELEGRAM_MSG_LIMIT` is defined separately in `handlers.rs` (line 19) and `format.rs` (line 242). `cmd_switch_keyboard` and `cmd_delete_keyboard` (lines 405, 433) are structurally identical. `cmd_list` duplicates session-fetch logic that `fetch_chat_sessions` already provides.
- **Dead code**: `stream_with_tools()` on the `LlmProvider` trait is never called by `Agent` -- only `complete_with_tools()` is used in the tool call loop. Magic numbers for preview lengths, history limits, and keyboard preview limits are scattered as raw literals.
- **Type safety gaps**: `LoggingConfig.rotation` is a `String` (line 190 of `config.rs`) instead of a typed enum. `Arc<Box<dyn SessionStore>>` double indirection appears throughout the Telegram crate (14+ occurrences).
- **Large modules**: `commands.rs` in Telegram is 1214 lines (mixing slash command handlers, keyboard builders, and callback logic). `format.rs` is 702 lines (mixing Markdown conversion with HTML chunking). `anthropic.rs` is 674 lines (mixing provider implementation with serde types).
- **Small polish items**: `ChatSessions` struct literals are constructed in 10+ places without a constructor. REPL layout constraints are inline magic numbers. `Ok(r) | Err(r) => r` patterns appear 4 times instead of idiomatic `.unwrap_or_else(|e| e)`.

## Goals

1. **Unify truncation** -- Create `synapse-core/src/text.rs` with a single char-safe `truncate(s, max_chars)` function. Delete all duplicate truncation logic and tests from CLI, Telegram, and core storage.
2. **Consolidate OpenAI-compatible providers** -- Add a generic `OpenAiCompatProvider` struct to `openai_compat.rs` that holds base URL, API key, model, and max tokens. Implement all `LlmProvider` methods on it. Rewrite `deepseek.rs` and `openai.rs` as newtypes delegating all trait methods.
3. **Deduplicate CLI session helpers** -- Extract `load_or_create_session()` shared between `main.rs` and `repl.rs`. Extract `init_storage()` consolidating storage initialisation + cleanup.
4. **Deduplicate Telegram code** -- Extract `check_auth`, `tg_session_name`, `NO_SESSIONS_HINT` constant, unified `TELEGRAM_MSG_LIMIT`, `build_action_keyboard` replacing separate switch/delete keyboard builders, and have `cmd_list` use `fetch_chat_sessions`.
5. **Remove dead code and extract constants** -- Remove `stream_with_tools()` from the `LlmProvider` trait. Extract named constants: `PREVIEW_MAX_CHARS`, `HISTORY_MESSAGE_LIMIT`, `LIST_PREVIEW_MAX_CHARS`, `KEYBOARD_PREVIEW_MAX_CHARS`.
6. **Improve type safety** -- Replace `rotation: String` in `LoggingConfig` with a `Rotation` enum (`Daily`, `Hourly`, `Never`) and derive `Deserialize`. Remove `Arc<Box<dyn SessionStore>>` double indirection; use `Arc<dyn SessionStore>` directly.
7. **Apply small polish** -- Extract REPL layout split ratio into a named constant. Add `ChatSessions::new(session_id)` constructor. Replace `Ok(r) | Err(r) => r` with `.unwrap_or_else(|e| e)`.
8. **Split large modules** -- Split `commands.rs` into `commands.rs` + `commands/keyboard.rs`. Split `format.rs` into `format.rs` + `format/chunk.rs`. Split `anthropic.rs` into `anthropic.rs` + `anthropic/types.rs`.

## User Stories

1. **As a contributor**, I want a single `truncate` function so that truncation behaviour is consistent across all crates and changes only need to be made in one place.
2. **As a contributor**, I want OpenAI-compatible providers consolidated into a generic struct so that adding a new OpenAI-compatible provider requires only a newtype with zero duplicated logic.
3. **As a contributor**, I want CLI storage init and session load/create extracted into shared helpers so that the two code paths (REPL and one-shot) cannot diverge.
4. **As a contributor**, I want Telegram auth checks, session naming, reply strings, keyboard builders, and message limits centralized so that each concept lives in exactly one place.
5. **As a contributor**, I want unused trait methods removed and magic numbers replaced by named constants so that the code communicates intent and unused API surface does not mislead.
6. **As a contributor**, I want `LoggingConfig.rotation` to be a typed enum so that invalid rotation values are caught at deserialization time, not at runtime.
7. **As a contributor**, I want `Arc<dyn SessionStore>` instead of `Arc<Box<dyn SessionStore>>` so that there is no unnecessary double indirection and the types are idiomatic.
8. **As a contributor**, I want large modules (1000+ lines) split into focused submodules so that code reviews are smaller and file navigation is easier.

## Main Scenarios

### Scenario 1: Unified truncation (21.1)

1. Create `synapse-core/src/text.rs` with `pub fn truncate(s: &str, max_chars: usize) -> String` using char-safe truncation.
2. Declare `mod text;` in `synapse-core/src/lib.rs` and re-export `truncate` (or the module).
3. Delete `truncate` from `synapse-cli/src/commands.rs` and replace usages with the core import.
4. Delete `truncate_content` from `synapse-telegram/src/commands.rs` and replace usages with the core import.
5. Delete inline truncation logic from `synapse-core/src/storage/sqlite.rs` (line 208) and replace with a call to the shared function.
6. Remove the duplicate `test_truncate` test from `synapse-cli/src/main.rs`.
7. Verify: `cargo clippy -- -D warnings && cargo test` pass.

### Scenario 2: OpenAiCompatProvider consolidation (21.2)

1. Add a generic `OpenAiCompatProvider` struct to `openai_compat.rs` holding `base_url`, `api_key`, `model`, and `max_tokens`.
2. Implement all `LlmProvider` methods on `OpenAiCompatProvider` using the existing shared helpers (`build_api_messages`, `complete_request`, `stream_sse`).
3. Rewrite `DeepSeekProvider` and `OpenAIProvider` as newtypes wrapping `OpenAiCompatProvider`, delegating all trait methods.
4. Update `factory.rs` to construct via the newtypes.
5. Verify: all existing tests pass unchanged.

### Scenario 3: CLI session helper deduplication (21.3)

1. Extract `init_storage(session_config) -> Box<dyn SessionStore>` that creates storage and runs cleanup if configured.
2. Extract `load_or_create_session(storage, config, session_id) -> (Session, Vec<StoredMessage>)` shared between one-shot and REPL paths.
3. Update `main.rs` and `repl.rs` to use the shared helpers.
4. Verify: `cargo build && cargo test` pass.

### Scenario 4: Telegram deduplication (21.4)

1. Extract `check_auth(msg, allowed_users) -> Option<ResponseResult<()>>` helper replacing inline auth checks in `handlers.rs` and `commands.rs`.
2. Extract `tg_session_name(chat_id) -> String` helper replacing ad-hoc `format!("tg:{chat_id}")` strings in three locations.
3. Add `const NO_SESSIONS_HINT: &str = "No sessions. Send a message or use /new to start one."` and replace the 6 duplicate strings.
4. Unify `TELEGRAM_MSG_LIMIT` so `format.rs` and `handlers.rs` share a single constant (define in one place, import in the other).
5. Merge `cmd_switch_keyboard` and `cmd_delete_keyboard` into `build_action_keyboard(action, sessions)`.
6. Have `cmd_list` call `fetch_chat_sessions` instead of duplicating session-fetch logic.
7. Verify: `cargo clippy -- -D warnings && cargo test` pass.

### Scenario 5: Dead code removal and constant extraction (21.5)

1. Remove `stream_with_tools()` from the `LlmProvider` trait (and any overrides in `anthropic.rs`, `openai_compat.rs`).
2. Update `CLAUDE.md` and `README.md` to remove references to `stream_with_tools()`.
3. Extract named constants: `PREVIEW_MAX_CHARS` (for the 40-char preview in `cmd_list`), `HISTORY_MESSAGE_LIMIT` (10), `LIST_PREVIEW_MAX_CHARS`, `KEYBOARD_PREVIEW_MAX_CHARS`.
4. Verify: `cargo clippy -- -D warnings && cargo test` pass.

### Scenario 6: Type safety improvements (21.6)

1. Replace `pub rotation: String` in `LoggingConfig` with a `pub rotation: Rotation` enum having variants `Daily`, `Hourly`, `Never`.
2. Derive `Deserialize` (with serde rename to lowercase) on the `Rotation` enum.
3. Update the serde default function and all match sites that currently match on the string.
4. Remove `Arc<Box<dyn SessionStore>>` double indirection in all Telegram crate files; change to `Arc<dyn SessionStore>`.
5. Update `dptree::deps![]` and all function signatures accordingly.
6. Verify: `cargo clippy -- -D warnings && cargo test` pass.

### Scenario 7: Small polish (21.7)

1. Extract the REPL layout constraint values into named constants (e.g., `REPL_MIN_HISTORY_HEIGHT`, `REPL_INPUT_HEIGHT`, `REPL_STATUS_HEIGHT`).
2. Add `ChatSessions::new(session_id: Uuid) -> Self` constructor and replace the 10+ struct literal constructions.
3. Replace `Ok(r) | Err(r) => r` patterns (4 occurrences in `commands.rs`) with `.unwrap_or_else(|e| e)` or equivalent idiomatic form.
4. Verify: `cargo clippy -- -D warnings && cargo test` pass.

### Scenario 8: Split large modules (21.8)

1. Split `synapse-telegram/src/commands.rs` (1214 lines) into `commands.rs` (slash command handlers) + `commands/keyboard.rs` (keyboard builders and callback logic: `build_action_keyboard`, `handle_callback`, `do_switch`, `do_delete`).
2. Split `synapse-telegram/src/format.rs` (702 lines) into `format.rs` (`md_to_telegram_html`, `escape_html`) + `format/chunk.rs` (`chunk_html`, tag-balancing internals).
3. Split `synapse-core/src/provider/anthropic.rs` (674 lines) into `anthropic.rs` (provider impl) + `anthropic/types.rs` (serde request/response structs).
4. Use the new Rust module system (no `mod.rs` files). Declare submodules in the parent file with `mod keyboard;`, `mod chunk;`, `mod types;` and re-export public symbols.
5. Verify: `cargo build && cargo test` pass.

## Success / Metrics

| Metric | Target |
|--------|--------|
| `cargo clippy -- -D warnings` | Zero warnings throughout |
| `cargo test` | All tests green after every task |
| Truncation implementations | 1 (in `synapse-core/src/text.rs`) |
| `deepseek.rs` + `openai.rs` combined lines | ~60-80 (newtypes only) |
| Storage init + cleanup duplication in CLI | 1 shared helper |
| `format!("tg:{}")` occurrences | 1 (in `tg_session_name` helper) |
| "No sessions" literal strings | 1 (the `NO_SESSIONS_HINT` constant) |
| `TELEGRAM_MSG_LIMIT` definitions | 1 (shared across `format.rs` and `handlers.rs`) |
| Keyboard builder functions | 1 (`build_action_keyboard`) instead of 2 |
| `stream_with_tools()` on `LlmProvider` trait | Removed |
| Magic number literals for preview/history limits | Replaced by named constants |
| `LoggingConfig.rotation` type | `Rotation` enum (not `String`) |
| `Arc<Box<dyn SessionStore>>` occurrences | 0 (replaced by `Arc<dyn SessionStore>`) |
| `ChatSessions { ... }` struct literals | 0 (replaced by `ChatSessions::new()`) |
| `commands.rs` (Telegram) lines | Split into ~600 + ~600 across two files |
| `format.rs` lines | Split into ~400 + ~300 across two files |
| `anthropic.rs` lines | Split into ~350 + ~320 across two files |
| External behaviour changes | Zero |

## Constraints and Assumptions

1. **No external behaviour changes** -- all refactoring is purely internal. CLI output, Telegram bot responses, API interactions, and database schema must remain identical.
2. **Task ordering** -- Task 21.1 (unified truncate) should complete early since later tasks may depend on the shared function. Task 21.5 (remove `stream_with_tools`) should complete before 21.8 (split `anthropic.rs`) to avoid carrying dead code into the new submodule. Task 21.6 (`Arc<Box<dyn SessionStore>>` removal) should complete before 21.8 (split `commands.rs`) to avoid propagating the old type into new files.
3. **Pre-commit gate after every task** -- `cargo fmt --check && cargo clippy -- -D warnings && cargo test` must pass after each completed task.
4. **No new `mod.rs` files** -- follow Rust 2018+ module convention as per `docs/conventions.md`.
5. **No `unwrap()`/`expect()` in `synapse-core`** -- all error handling via `?` propagation.
6. **Phase 20 (SY-20) is complete** -- this work builds on a stable baseline.
7. **Char-safe truncation** -- the unified `truncate` function must use `.chars()` (not byte slicing) to prevent panics on multi-byte text, matching the fix from commit `3a4e33a`.
8. **`Rotation` enum serde compatibility** -- the new enum must deserialize from the same lowercase strings (`"daily"`, `"hourly"`, `"never"`) that the current `String` field accepts, so existing config files remain valid.

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Removing `stream_with_tools()` breaks external consumers | Low | Medium | The trait is only implemented within the workspace; no external crates depend on it. Search for all call sites confirms only `complete_with_tools()` is used by `Agent`. |
| `Arc<Box<dyn SessionStore>>` to `Arc<dyn SessionStore>` migration requires changes in dptree injection | Medium | Low | `dptree` dependency injection uses type-based matching; changing the type in `deps![]` and all handler signatures simultaneously ensures consistency. Compile-time check catches mismatches. |
| `OpenAiCompatProvider` consolidation introduces subtle provider-specific regressions | Medium | High | Keep all existing tests; run full test suite after extraction. The shared helpers (`build_api_messages`, `complete_request`, `stream_sse`) are already used by both providers -- wrapping them in a struct changes no logic. |
| Module splits break re-exports or test module paths | Low | Low | Split one module at a time; verify `cargo build && cargo test` after each. Re-export all previously-public symbols from the parent module. |
| `Rotation` enum deserialization rejects existing config files | Low | Medium | Use `#[serde(rename_all = "lowercase")]` on the enum to match the current string values exactly. Add a unit test with each valid rotation value. |
| `cmd_list` refactor to use `fetch_chat_sessions` changes edge-case behaviour | Low | Low | `fetch_chat_sessions` already performs the same DB query and filtering. Review both code paths side-by-side to confirm identical logic before replacing. |

## Open Questions

None -- the phase document is comprehensive and all specifications are clear. The PRD is ready for tasklist creation.
