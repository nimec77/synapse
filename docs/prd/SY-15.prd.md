# SY-15: Phase 14 — File Logging

Status: PRD_READY

## Context / Idea

**Ticket:** SY-15 "Phase 14: File Logging"
**Description file:** `docs/phase/phase-14.md`

The Telegram bot (`synapse-telegram`) runs as a long-lived process on a VPS where stdout logs are lost on restart. Production deployments need file-based logging with automatic rotation so operators can debug issues, monitor health, and review past activity without relying on ephemeral stdout output.

This phase adds a `LoggingConfig` struct to `synapse-core`, integrates `tracing-appender` into `synapse-telegram`, and rewrites the tracing initialization to use a layered subscriber that outputs to both stdout and a rolling file appender. Only `synapse-telegram` gets file logging; `synapse-cli` continues with stdout only.

### Source Requirements (from `docs/phase/phase-14.md`)

**Tasks:**
- 14.1 Add `LoggingConfig` struct to `synapse-core/src/config.rs` with defaults
- 14.2 Add `tracing-appender` dependency and `registry` feature to `synapse-telegram`
- 14.3 Rewrite tracing init with layered subscriber (stdout + file appender)
- 14.4 Update `config.example.toml` with `[logging]` section documentation
- 14.5 Update `docs/idea.md`, `docs/vision.md`, and `docs/tasklist.md`

**Key design points (verbatim from description):**
- `LoggingConfig` is defined in `synapse-core/src/config.rs` and deserialized from the `[logging]` TOML section.
- Fields with defaults: `directory: String` ("logs"), `max_files: usize` (7), `rotation: String` ("daily").
- `synapse-telegram` uses `tracing-appender::rolling::daily()` (or hourly/never based on config) to create a file writer.
- A `tracing_subscriber::registry()` layered subscriber combines a stdout `fmt` layer and the file appender layer.
- The non-blocking writer handle must be kept alive for the process lifetime (`let _guard = ...`).
- File naming pattern: `synapse-telegram.YYYY-MM-DD.log` (tracing-appender appends the date suffix automatically).
- Only `synapse-telegram` gets file logging; `synapse-cli` continues with stdout only.

**Acceptance Criteria (verbatim from description):**
Add `[logging]` to config, start the bot, verify log files appear in the configured directory with correct rotation and file count limits.

**Dependencies:** Phase 13 complete (System Prompt) -- already done (SY-14).

## Goals

1. **Production observability**: Persist structured logs to disk so that Telegram bot operators on VPS deployments can review historical logs after restarts, crashes, or disconnects.
2. **Automatic rotation**: Prevent unbounded log file growth with configurable rotation (daily/hourly/never) and a maximum file count limit.
3. **Minimal disruption**: Add file logging only to `synapse-telegram` without changing `synapse-cli` behavior; the `[logging]` section is optional and omitting it preserves current stdout-only behavior.
4. **Shared configuration**: Define `LoggingConfig` in `synapse-core` so any future interface crate can reuse the same config structure.

## User Stories

1. **As a VPS operator**, I want the Telegram bot to write logs to disk so that I can review them after a process restart without losing diagnostic information.
2. **As a VPS operator**, I want log files to rotate automatically (daily by default) so that disk usage is bounded and I do not need to set up external log rotation (e.g., `logrotate`).
3. **As a VPS operator**, I want to configure the maximum number of retained log files so that old logs are automatically cleaned up.
4. **As a VPS operator**, I want to configure the log directory so that I can place logs on a dedicated volume or follow my server's directory conventions.
5. **As a developer**, I want to omit the `[logging]` section entirely and have the bot continue with stdout-only logging (backward compatibility).
6. **As a CLI user**, I want `synapse-cli` to remain unchanged — stdout logging only, no file output.

## Main Scenarios

### Scenario 1: File logging enabled with defaults

1. User adds `[logging]` (with no fields) to `config.toml`.
2. Bot starts and creates directory `logs/` (relative to CWD) if it does not exist.
3. Bot initializes a layered tracing subscriber: stdout `fmt` layer + file appender layer.
4. Log file `logs/synapse-telegram.YYYY-MM-DD.log` is created and receives all log output.
5. A non-blocking guard is held for the process lifetime to flush writes.
6. After 7 days of daily rotation, the oldest log file is deleted automatically.

### Scenario 2: File logging with custom configuration

1. User sets `[logging]` with `directory = "/var/log/synapse"`, `max_files = 30`, `rotation = "hourly"`.
2. Bot creates `/var/log/synapse/` if needed and writes logs with hourly rotation.
3. After 30 rotated files accumulate, the oldest is deleted.

### Scenario 3: File logging disabled (default / backward compatible)

1. User has no `[logging]` section in `config.toml`.
2. Bot starts with the current stdout-only `tracing_subscriber::fmt()` behavior.
3. No file I/O occurs for logging.

### Scenario 4: CLI unaffected

1. `synapse-cli` does not read or act on `[logging]` config.
2. CLI continues using stdout for all output.

## Success / Metrics

| Metric | Target |
|--------|--------|
| Log file appears in configured directory on bot start | Required |
| Daily rotation produces new file at midnight boundary | Required |
| Old files deleted when count exceeds `max_files` | Required |
| Omitting `[logging]` preserves stdout-only behavior | Required |
| `synapse-cli` behavior unchanged | Required |
| Non-blocking writer does not drop log messages under normal load | Required |
| All existing tests pass (`cargo test`) | Required |
| `cargo clippy -- -D warnings` clean | Required |
| New unit tests for `LoggingConfig` parsing and defaults | Required |

## Constraints and Assumptions

### Constraints

1. **`LoggingConfig` lives in `synapse-core/src/config.rs`** — follows hexagonal architecture; config types belong in core.
2. **`tracing-appender` dependency goes in `synapse-telegram` only** — core does not need the appender runtime; it only defines the config struct.
3. **`tracing-subscriber` needs the `registry` feature** in `synapse-telegram` to support layered subscribers.
4. **Non-blocking guard must be held for process lifetime** — dropping it early causes log loss. The guard must be stored in a `let _guard = ...` binding in `main()`.
5. **File naming pattern**: `synapse-telegram.YYYY-MM-DD.log` — `tracing-appender` appends the date suffix automatically when given the prefix `"synapse-telegram"` and suffix `"log"`.
6. **Field types**: `directory: String` (default `"logs"`), `max_files: usize` (default `7`), `rotation: String` (default `"daily"`).
7. **Rotation values**: `"daily"`, `"hourly"`, `"never"` — map to `tracing_appender::rolling::daily()`, `hourly()`, and `never()` respectively.

### Assumptions

1. The bot process has write permissions to the configured log directory.
2. `tracing-appender`'s built-in file count management (via `RollingFileAppender::builder().max_log_files()`) handles deletion of old files.
3. The existing `tracing_subscriber::fmt()` call in `synapse-telegram/src/main.rs` (lines 25-30) will be replaced by the new layered subscriber setup.
4. The `config.example.toml` already has a commented `[logging]` section (confirmed in current codebase) that documents the fields.

## Risks

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `tracing-appender` `max_log_files` API may differ across versions | Low | Medium | Pin to a specific `tracing-appender` version compatible with existing `tracing-subscriber 0.3` |
| Non-blocking writer guard dropped too early (e.g., moved into a spawned task) | Low | High | Keep `_guard` as a local binding in `main()` before the dispatcher loop |
| Log directory creation fails (permissions, read-only filesystem) | Low | Medium | Log a warning to stderr and fall back to stdout-only if directory creation fails |
| File I/O on the logging path could block the async runtime | Low | Low | `tracing-appender` uses a non-blocking writer with a dedicated background thread; no async runtime blocking |

## Open Questions

None. The description file provides complete specifications, and all referenced crates (`tracing-appender`, `tracing-subscriber` with `registry`) are well-established in the Rust ecosystem. The `config.example.toml` already contains the commented `[logging]` section, confirming the design is aligned with the existing codebase.
