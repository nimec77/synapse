# SY-20: Improve /history Command

Status: PRD_READY

## Context / Idea

The `/history` command in the Telegram bot currently dumps the entire conversation history for the active session, including System and Tool role messages, with no limit on the number of messages and no truncation of long content. This produces noisy, hard-to-read output -- especially for sessions with MCP tool calls, where multiple System and Tool messages clutter the view, and for sessions with long assistant responses that flood the chat.

This ticket replaces the full message dump with a compact "last 10 messages" view that filters out System/Tool roles and truncates content to 150 characters.

**Source:** `docs/phase/phase-20.md`

### Current Code State (Gaps)

- `cmd_history` in `synapse-telegram/src/commands.rs` (lines 184-239) iterates over ALL messages from storage, including `Role::System` and `Role::Tool`, with no limit and no truncation.
- `Command::History` description (line 37) reads `"Show conversation history"` -- should be `"Show recent messages"`.
- No unit tests exist for the history formatting, truncation, or filtering logic.
- CLAUDE.md already describes `/history` as "(last 10 messages, truncated to 150 chars)" -- this is the target state documented ahead of the implementation.
- CHANGELOG `[Unreleased]` section already contains the entry for this change.

## Goals

1. **Filter roles**: Only display `User` and `Assistant` messages in `/history` output. `System` and `Tool` messages are internal implementation details and should not be shown to the user.
2. **Limit to last 10 messages**: Show at most the 10 most recent User/Assistant messages, keeping the output compact and readable.
3. **Truncate long content**: Truncate each message's content to 150 characters, appending an ellipsis (`...`) when truncation occurs, so that long responses do not flood the chat.
4. **Update command description**: Change `Command::History` description from `"Show conversation history"` to `"Show recent messages"` so the `/help` output accurately reflects the new behavior.
5. **Add unit tests**: Cover the truncation and filtering logic with unit tests to prevent regressions.
6. **Update documentation**: Ensure CLAUDE.md, README.md, and CHANGELOG.md reflect the new behavior.

## User Stories

1. **As a Telegram user**, I want `/history` to show only my messages and the assistant's replies, so I can review the conversation without seeing system prompts or tool call internals.
2. **As a Telegram user**, I want `/history` to show only the most recent messages (last 10), so I get a quick overview rather than a wall of text in long sessions.
3. **As a Telegram user**, I want long messages to be truncated with an ellipsis, so each history entry fits on a few lines and the output is scannable.
4. **As a Telegram user**, I want `/help` to describe `/history` as "Show recent messages" so I know it gives a summary, not a full dump.

## Main Scenarios

### Scenario 1: Normal history with mixed roles

1. Session has 20 messages: 5 User, 5 Assistant, 5 System, 5 Tool.
2. User sends `/history`.
3. System and Tool messages are filtered out, leaving 10 User/Assistant messages.
4. All 10 fit within the "last 10" limit.
5. Bot replies with a formatted list of the 10 messages, each with role label, timestamp, and content (truncated if over 150 chars).

### Scenario 2: Long session exceeding 10 User/Assistant messages

1. Session has 30 User/Assistant messages (System/Tool excluded after filter).
2. User sends `/history`.
3. The 30 filtered messages are trimmed to the last 10.
4. Bot replies with only the 10 most recent messages.

### Scenario 3: Message content truncation

1. A session contains an Assistant message with 500 characters of content.
2. User sends `/history`.
3. That message's content is displayed as the first 150 characters followed by `...`.
4. Messages with 150 characters or fewer are displayed in full (no ellipsis).

### Scenario 4: Empty session

1. Session has no messages (or only System/Tool messages that get filtered out).
2. User sends `/history`.
3. Bot replies "No messages in current session." (same as current behavior).

### Scenario 5: No active session

1. User has no active session.
2. User sends `/history`.
3. Bot replies "No active session. Send a message or use /new to start one." (same as current behavior).

## Success / Metrics

- `/history` output contains only `You` and `Assistant` role labels -- never `System` or `Tool`.
- `/history` output contains at most 10 messages.
- Messages longer than 150 characters are truncated with a trailing `...`.
- Messages of exactly 150 characters or fewer are displayed in full without `...`.
- `/help` output shows `History` described as "Show recent messages".
- All existing tests pass; new unit tests cover:
  - Role filtering (only User/Assistant pass through)
  - Last-10 limit (correct messages selected from a longer list)
  - Truncation at 150 chars with ellipsis
  - No truncation for short messages
  - Edge case: exactly 150 chars (no ellipsis)
  - Edge case: 151 chars (truncated to 150 + ellipsis)

## Constraints and Assumptions

- **Filter is display-only**: The underlying stored messages are not modified. The filter and truncation apply only to the `/history` output formatting.
- **Character-based truncation**: Truncation is by Unicode character count (`.chars().take(150)`), not byte count, consistent with the existing `preview` truncation pattern in `cmd_list`.
- **Ellipsis is `...` (three dots)**: Not the Unicode ellipsis character `\u{2026}`, to keep it simple and consistent with typical bot output.
- **"Last 10" means chronologically last**: Messages are already returned from storage in chronological order. After filtering, take the last 10 (i.e., the 10 most recent).
- **Existing module conventions**: All changes go in `synapse-telegram/src/commands.rs`. The filtering/truncation logic should be extracted into testable helper functions (not embedded inline in the async handler).
- **No `mod.rs` files**: Per project conventions (Rust 2018+ module system).
- **Plain text output**: `/history` replies use plain text (no `ParseMode::Html`), matching the existing command reply convention.

## Risks

1. **Character boundary edge cases**: Truncating at character boundaries could split a multi-byte character awkwardly in display, but since we use `.chars().take(N)` this is safe -- it operates on Unicode scalar values, not bytes.
2. **Large message volumes from storage**: `storage.get_messages()` returns all messages for the session before filtering. For very large sessions this could be slow. **Mitigation**: This is acceptable for Telegram bot usage patterns where sessions rarely exceed hundreds of messages. Pagination can be added later if needed.

## Open Questions

None -- the phase document provides clear specifications for all tasks.
