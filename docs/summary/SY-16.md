# SY-16 Summary: Phase 15 — Code Refactoring

**Status:** COMPLETE
**Branch:** feature/sy-16-phase15
**Date:** 2026-02-22

---

## Overview

SY-16 was a pure internal refactoring pass across the entire Synapse workspace. After 15 phases of
feature development the codebase had accumulated technical debt: a dead module, ~400 lines of
duplicated provider logic, scattered magic strings, zero structured tracing in core, copy-pasted
initialisation helpers, two oversized source files, an overly broad public API, and one blocking
filesystem call inside an async function. Seven tasks, executed in strict dependency order, resolved
all of these issues. No external behaviour changed.

---

## What Was Done

### Task 15.1 — Dead Code Removal

- Deleted the vestigial `placeholder` module from `synapse-core/src/lib.rs`.
- Removed three unused `StreamEvent` variants (`ToolCall`, `ToolResult`, `Error`) and their tests
  from `synapse-core/src/provider/streaming.rs`.
- Removed the now-unused `use crate::provider::ProviderError` import from `streaming.rs`.
- Removed stale `StreamEvent::Error(e)` match arms and the `Some(Ok(_))` wildcard arm from
  `synapse-cli/src/main.rs` and `synapse-cli/src/repl.rs`.
- Added serde-justification comments on `#[allow(dead_code)]` annotations for `finish_reason` in
  `deepseek.rs` and `openai.rs`.

`StreamEvent` now contains only `TextDelta(String)` and `Done`.

### Task 15.2 — OpenAI-Compatible Provider Extraction

- Created `synapse-core/src/provider/openai_compat.rs` (754 lines) containing all shared serde
  types and logic previously duplicated between `deepseek.rs` and `openai.rs`.
- Shared types moved (all `pub(super)`): `ApiMessage`, `ApiRequest`, `StreamingApiRequest`,
  `OaiTool`, `OaiFunction`, `OaiToolCall`, `OaiToolCallFunction`, `ApiResponse`, `Choice`,
  `ChoiceMessage`, `ApiError`, `ErrorDetail`, `StreamChunk`, `StreamDelta`, `StreamChoice`.
- Shared functions moved: `build_api_messages()`, `complete_request()`, `to_oai_tools()`,
  `stream_sse()`.
- Added `SSE_DONE_MARKER` and `DEFAULT_MAX_TOKENS` constants.
- `deepseek.rs` reduced from 840 lines to 118 lines (thin wrapper, `API_ENDPOINT` + delegation).
- `openai.rs` reduced from 678 lines to 96 lines (same pattern, different endpoint).
- Serde / JSON tests migrated to `openai_compat.rs`; both wrappers keep only struct-construction
  tests.

### Task 15.3 — Constants and Methods

- Added `Role::as_str(&self) -> &'static str` and `impl std::str::FromStr for Role` to
  `synapse-core/src/message.rs`.
- Replaced manual role-to-string match expressions in `openai_compat.rs` and `sqlite.rs` with
  `role.as_str()` and `s.parse::<Role>()`.
- Added `const ERROR_REPLY` in `synapse-telegram/src/handlers.rs`; replaced both raw-string
  occurrences.
- Added `const DEFAULT_TRACING_DIRECTIVE` in `synapse-telegram/src/main.rs`; replaced all three
  hard-coded occurrences.
- Added `DEEPSEEK_API_KEY_ENV`, `ANTHROPIC_API_KEY_ENV`, `OPENAI_API_KEY_ENV` constants in
  `synapse-core/src/provider/factory.rs`; replaced the three hard-coded env-var strings in
  `get_api_key()`.

### Task 15.4 — Structured Tracing

- Added `tracing = "0.1"` to `synapse-core/Cargo.toml` and `synapse-cli/Cargo.toml`.
- Added `tracing-subscriber = { version = "0.3", features = ["env-filter"] }` to
  `synapse-cli/Cargo.toml`.
- Initialised `tracing_subscriber::fmt().with_env_filter(EnvFilter::from_default_env())` in
  `synapse-cli/src/main.rs` before any other work.
- Instrumented with `tracing::debug!` / `tracing::info!`: agent tool call loop, HTTP requests in
  `openai_compat.rs` and `anthropic.rs`, provider factory, SQLite CRUD operations, config path
  resolution, MCP server connection and tool discovery/execution.
- Replaced all `eprintln!` warning calls in `synapse-core/src/mcp/tools.rs`,
  `synapse-cli/src/main.rs`, and `synapse-cli/src/repl.rs` with `tracing::warn!` /
  `tracing::info!`. Pre-initialisation `eprintln!` calls in `synapse-telegram/src/main.rs`
  were intentionally preserved.

### Task 15.5 — Shared Utility Extraction

- Moved `init_mcp_client()` into `synapse-core/src/mcp.rs` as a `pub async fn`; the single
  canonical definition uses `tracing::warn!` for connection and config failures.
- Exported `init_mcp_client` from `synapse-core/src/lib.rs`.
- Removed the copy-pasted `init_mcp_client()` function from both `synapse-cli/src/main.rs` and
  `synapse-telegram/src/main.rs`; both now call `synapse_core::init_mcp_client`.
- Added `Agent::from_config(config: &Config, mcp_client: Option<McpClient>) -> Result<Self, ProviderError>`
  factory method to `synapse-core/src/agent.rs`, encapsulating provider creation and system prompt
  wiring in a single call.
- Updated all three call sites — CLI one-shot (`main.rs`), CLI REPL (`repl.rs`), and Telegram
  (`main.rs`) — to use `Agent::from_config`.

### Task 15.6 — File Splitting

- Split `synapse-cli/src/repl.rs` (1168 lines) into four files using the Rust 2018+ module
  convention (no `mod.rs`):
  - `repl/app.rs` (548 lines) — `ReplApp` struct, state fields, transitions, helper methods.
  - `repl/render.rs` (165 lines) — `render_ui` and TUI layout functions.
  - `repl/input.rs` (220 lines) — `handle_key_event`, `KeyAction`, key bindings.
  - `repl.rs` (274 lines) — module declarations, `TerminalGuard`, `run_repl()` orchestrator.
- Extracted `synapse-cli/src/commands.rs` (164 lines) from `main.rs`, containing `Commands` enum,
  `SessionAction` enum, `handle_command()`, and `truncate()`.
- `main.rs` declares `mod commands;` and imports from it; no duplicate definitions remain.

### Task 15.7 — API Surface Tightening and Async Fix

- Replaced `std::fs::create_dir_all(parent)` in `synapse-core/src/storage/sqlite.rs` with
  `tokio::fs::create_dir_all(parent).await`; added `fs` to the tokio features list in
  `synapse-core/Cargo.toml`.
- Audited `synapse-core/src/lib.rs` re-exports against actual imports across `synapse-cli` and
  `synapse-telegram`.
- Removed 17 re-exports that no consumer crate imports directly: `ConfigError`, `LoggingConfig`,
  `McpSettings`, `SessionConfig`, `McpConfig`, `McpError`, `McpServerConfig`, `ToolDefinition`,
  `ToolCallData`, `AnthropicProvider`, `DeepSeekProvider`, `MockProvider`, `OpenAiProvider`,
  `ProviderError`, `CleanupResult`, `SqliteStore`, `StorageError`. All remain accessible via their
  full module paths.
- `lib.rs` now re-exports exactly 17 items: `Agent`, `AgentError`, `Config`, `TelegramConfig`,
  `McpClient`, `load_mcp_config`, `init_mcp_client`, `Message`, `Role`, `LlmProvider`,
  `StreamEvent`, `create_provider`, `Session`, `SessionSummary`, `StoredMessage`, `SessionStore`,
  `create_storage`.

---

## Key Decisions

**`pub(super)` visibility in `openai_compat.rs`** — All shared types and functions are `pub(super)`
so they are accessible to `deepseek.rs` and `openai.rs` (sibling modules under `provider`) but not
to the public API surface. This keeps the extraction internal without requiring a new public type.

**`Agent::from_config` return type** — `Result<Self, ProviderError>` was chosen (not `anyhow::Error`)
because `create_provider()` already returns `Result<_, ProviderError>` and `Agent` lives in
`synapse-core`, which uses `thiserror` not `anyhow`. Interface crates wrap with `.context()`.

**Pre-init `eprintln!` preserved in Telegram** — Three `eprintln!` calls in
`synapse-telegram/src/main.rs` that fire before the tracing subscriber is set up were intentionally
kept. Replacing them with `tracing::warn!` before subscriber initialization would silently swallow
the messages.

**`repl.rs` orchestrator at 274 lines** — The PRD metric of ~50-100 lines was aspirational. The
274-line orchestrator contains genuine event-loop logic (the `tokio::select!` loop, storage writes,
session management) that belongs in the top-level file. All rendering, input handling, and app state
are correctly distributed to submodules. The deviation was documented in the QA report as acceptable.

**Provider wrapper line counts slightly above target** — `deepseek.rs` at 118 lines and `openai.rs`
at 96 lines exceed the 50-80 line target; the excess is accounted for by doc comments and test
blocks. Effective delegation code is complete and correct.

---

## Metrics

| Metric | Target | Achieved |
|--------|--------|----------|
| `cargo clippy -- -D warnings` | Zero warnings | Zero warnings |
| `cargo test` | All green | All green (13 unit + 14 doc) |
| DeepSeek provider lines | ~50-80 | 118 (incl. docs + tests) |
| OpenAI provider lines | ~50-80 | 96 (incl. docs + tests) |
| `repl.rs` orchestrator lines | ~50-100 | 274 (genuine orchestration) |
| `lib.rs` public re-exports | Only consumer-imported items | 17 items |
| Blocking `std::fs` in async | Zero | Zero |
| `eprintln!` in core / CLI function bodies | Zero | Zero |
| Duplicated `init_mcp_client` | Single definition | `synapse-core/src/mcp.rs` |
| Duplicated agent construction pattern | Single `from_config` | Used at all 3 call sites |
| External behaviour changes | Zero | Zero |

---

## New Public API Additions

```rust
// synapse-core/src/message.rs
impl Role {
    pub fn as_str(&self) -> &'static str { ... }
}
impl std::str::FromStr for Role {
    type Err = String;
    fn from_str(s: &str) -> Result<Self, Self::Err> { ... }
}

// synapse-core/src/agent.rs
impl Agent {
    pub fn from_config(
        config: &Config,
        mcp_client: Option<McpClient>,
    ) -> Result<Self, ProviderError> { ... }
}

// synapse-core/src/mcp.rs
pub async fn init_mcp_client(config_path: Option<&str>) -> Option<McpClient> { ... }
```

---

## Files Added

| File | Contents |
|------|----------|
| `synapse-core/src/provider/openai_compat.rs` | Shared OpenAI-compatible types, functions, constants |
| `synapse-cli/src/commands.rs` | `Commands`, `SessionAction`, `handle_command`, `truncate` |
| `synapse-cli/src/repl/app.rs` | `ReplApp` struct and state logic |
| `synapse-cli/src/repl/render.rs` | TUI rendering functions |
| `synapse-cli/src/repl/input.rs` | Key event handling |

## Files Significantly Modified

| File | Change |
|------|--------|
| `synapse-core/src/provider/deepseek.rs` | 840 → 118 lines; thin wrapper over `openai_compat` |
| `synapse-core/src/provider/openai.rs` | 678 → 96 lines; thin wrapper over `openai_compat` |
| `synapse-core/src/provider/streaming.rs` | `StreamEvent` reduced to `TextDelta` + `Done` |
| `synapse-core/src/message.rs` | `Role::as_str()` and `FromStr` impl added |
| `synapse-core/src/agent.rs` | `Agent::from_config()` factory method added |
| `synapse-core/src/mcp.rs` | `init_mcp_client()` shared helper added |
| `synapse-core/src/lib.rs` | 17 re-exports removed; `placeholder` module removed |
| `synapse-core/src/storage/sqlite.rs` | `tokio::fs::create_dir_all().await` async fix |
| `synapse-cli/src/repl.rs` | 1168 → 274 lines; submodules extracted |
| `synapse-cli/src/main.rs` | Local helpers removed; shared utilities used |
| `synapse-telegram/src/main.rs` | Local helpers removed; constants extracted |
