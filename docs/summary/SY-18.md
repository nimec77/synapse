# SY-18 Summary: Telegram Bot Commands

**Ticket:** SY-18
**Status:** COMPLETE
**Branch:** feature/sy-18-phase18
**Date:** 2026-02-25

---

## Overview

SY-18 adds slash command support to the Synapse Telegram bot with six commands (`/help`, `/new`,
`/history`, `/list`, `/switch N`, `/delete N`) and multi-session management per Telegram chat. The
core structural change replaces the previous single-UUID-per-chat `ChatSessionMap` with a
`ChatSessions` struct that tracks a `Vec<Uuid>` of session UUIDs and an `active_idx: usize`
pointer. The teloxide dispatcher switches from a single-endpoint handler to a branched pattern that
separates command messages from regular text messages. A configurable `max_sessions_per_chat`
setting (default 10) is added to `TelegramConfig`, with automatic eviction of the oldest session
when the cap is exceeded during `/new`.

Nine tasks were completed across six files in `synapse-core` and `synapse-telegram`, with
265 unit tests and 13 doc tests passing.

---

## What Was Done

### Task 1 — `max_sessions_per_chat` in `TelegramConfig`

Added `max_sessions_per_chat: u32` to `TelegramConfig` in `synapse-core/src/config.rs`:

```rust
#[serde(default = "default_max_sessions_per_chat")]
pub max_sessions_per_chat: u32,
```

A companion `default_max_sessions_per_chat() -> u32` returns `10`. The `#[derive(Default)]`
macro was replaced with a manual `impl Default` that calls the serde default function, ensuring
the in-code default and the serde default are always in sync.

Two new config tests were added:
- `test_telegram_config_default`: asserts `max_sessions_per_chat == 10` on `TelegramConfig::default()`
- `test_config_telegram_max_sessions_per_chat`: asserts explicit `5` and omitted-field default `10`

All existing `TelegramConfig { ... }` callsites in test code were updated to use
`..TelegramConfig::default()` for forward compatibility.

### Task 2 — Move `chrono` to runtime dependency

`chrono = "0.4"` was moved from `[dev-dependencies]` to `[dependencies]` in
`synapse-telegram/Cargo.toml`. The empty `[dev-dependencies]` section was removed. This allows
`cmd_history` to format message timestamps at runtime using `chrono::DateTime`.

### Task 3 — `ChatSessions` struct and updated `ChatSessionMap`

A new `ChatSessions` struct was added to `synapse-telegram/src/handlers.rs`:

```rust
pub struct ChatSessions {
    pub sessions: Vec<Uuid>,
    pub active_idx: usize,
}

impl ChatSessions {
    pub fn active_session_id(&self) -> Option<Uuid> {
        self.sessions.get(self.active_idx).copied()
    }
}

pub type ChatSessionMap = Arc<RwLock<HashMap<i64, ChatSessions>>>;
```

`resolve_session` was updated to use the new type. The fast path (read lock) calls
`chat_sessions.active_session_id()`. The slow path (write lock) inserts a
`ChatSessions { sessions: vec![session.id], active_idx: 0 }`. The double-check pattern is
preserved.

### Task 4 — New `commands.rs` with all six command handlers

A new file `synapse-telegram/src/commands.rs` was created with:

**`Command` enum:**

```rust
#[derive(BotCommands, Clone)]
#[command(rename_rule = "lowercase", description = "Available commands:")]
pub enum Command {
    #[command(description = "Show available commands")]
    Help,
    #[command(description = "Start a new session")]
    New,
    #[command(description = "Show conversation history")]
    History,
    #[command(description = "List all sessions")]
    List,
    #[command(description = "Switch to session N")]
    Switch(usize),
    #[command(description = "Delete session N")]
    Delete(usize),
}
```

**`handle_command` dispatcher:** Performs an authorization check via `handlers::is_authorized()`
then dispatches to private `cmd_*` functions. The `Agent` is not needed in command handlers — none
of the six commands invoke LLM inference.

**Command implementations:**
- `cmd_help`: Replies with `Command::descriptions().to_string()`.
- `cmd_new`: Enforces `max_sessions_per_chat` cap. If at cap, evicts the oldest session (last in
  `sessions` vec, which holds the least recently updated), creates a new session, inserts it at
  the front of the vec, and sets `active_idx = 0`. Replies confirming creation with an eviction
  note when applicable. Storage failure replies with an error message.
- `cmd_history`: Gets the active session ID, fetches all messages via `storage.get_messages()`,
  formats each with `chrono` timestamp (`YYYY-MM-DD HH:MM`) and role label, chunks the output
  with `chunk_message()`, and sends as plain text.
- `cmd_list`: Fetches `list_sessions()` (ordered by `updated_at DESC`), filters to UUIDs
  belonging to this chat, formats a numbered list with `*` marking the active session and a
  40-character preview, and sends as plain text.
- `cmd_switch`: Reconstructs the same display-order list from `list_sessions()`, validates the
  1-based index N, finds the UUID at position N-1, updates `active_idx`, calls
  `storage.touch_session()`, and replies confirming the switch.
- `cmd_delete`: Reconstructs the display-order list, validates the index, deletes from storage
  and the in-memory `sessions` vec, then adjusts `active_idx`:
  - Deleted active session, other sessions remain → `active_idx = 0`.
  - Deleted active session, no sessions remain → auto-creates a new session.
  - Deleted non-active session below active → `active_idx.saturating_sub(1)`.
  - Deleted non-active session above active → no `active_idx` change.

**11 unit tests** added in `#[cfg(test)] mod tests`:
- `test_chat_sessions_active_session_id_non_empty`, `_empty`, `_multiple`
- `test_session_cap_evicts_last_when_at_cap`, `test_session_cap_no_eviction_when_below_cap`
- `test_index_validation_zero_is_invalid`, `_valid_index`, `_exceeds_count`
- `test_delete_active_session_switches_to_index_0`
- `test_delete_non_active_below_active_decrements_active_idx`
- `test_delete_non_active_above_active_no_change`

### Task 5 — Dispatcher and `rebuild_chat_map` update

In `synapse-telegram/src/main.rs`:

- `mod commands;` declared alongside `mod format;` and `mod handlers;`.
- `bot.get_me().await?` called at startup to obtain the `Me` type required by
  `filter_command::<Command>()` for bot command parsing.
- `bot.set_my_commands(Command::bot_commands()).await` called at startup with `tracing::warn!`
  on failure (non-fatal; commands still work without Telegram autocomplete).
- Single-endpoint dispatcher replaced with branched pattern:

```rust
let handler = Update::filter_message()
    .branch(dptree::entry().filter_command::<Command>().endpoint(commands::handle_command))
    .branch(dptree::entry().endpoint(handlers::handle_message));
```

- `me` injected first in `dptree::deps![...]`.
- `rebuild_chat_map` rewritten to return `HashMap<i64, ChatSessions>`. It iterates
  `list_sessions()` (which returns `ORDER BY updated_at DESC`) and groups all `tg:<chat_id>`
  sessions per chat. The first UUID encountered per chat is the most recently updated and becomes
  active at `active_idx = 0`.
- Startup log updated to report total session count across all chats.

### Task 6 — Updated existing tests

- `test_resolve_token_env_var`, `test_resolve_token_config`, `test_resolve_token_empty_env_var`
  updated to use `..TelegramConfig::default()` for the new `max_sessions_per_chat` field.
- `test_rebuild_chat_map_empty`, `test_rebuild_chat_map_with_telegram_sessions`, and
  `test_rebuild_chat_map_ignores_non_telegram` updated for the `HashMap<i64, ChatSessions>`
  return type.
- New test `test_rebuild_chat_map_multi_session_per_chat` added: creates multiple
  `SessionSummary` entries with the same `tg:<chat_id>` name but different UUIDs and
  `updated_at` timestamps; asserts correct grouping, ordering (newest UUID first), and
  `active_idx == 0`.

### Task 7 — Unit tests for command logic

11 new unit tests added to `commands.rs` (see Task 4 above). A `MockSessionStore` pattern was
established locally within the `#[cfg(test)] mod tests` block.

### Task 8 — `config.example.toml` documentation

Added a commented-out `max_sessions_per_chat` entry with a two-line explanatory comment in the
`[telegram]` section:

```toml
# Maximum sessions per Telegram chat (default: 10).
# When exceeded, the oldest session is auto-deleted on /new.
# max_sessions_per_chat = 10
```

### Task 9 — Pre-commit gate

`cargo fmt --check`, `cargo clippy -- -D warnings`, and `cargo test` all passed.
Total: 265 unit tests + 13 doc tests green.

---

## Key Design Decisions

**`ChatSessions` struct with `active_idx: usize`** — Rather than storing an active UUID
directly, an integer index into the `sessions` vec is used. This avoids UUID lookup on every
message and handles the common case (sending messages) with a single `sessions.get(active_idx)`
call from the in-memory map.

**DB ordering as source of truth for display** — The `sessions` vec in `ChatSessions` is
optimized for the hot path (sending messages). Commands that display or index sessions (`/list`,
`/switch N`, `/delete N`) always reconstruct ordering fresh from `list_sessions()` (which returns
`ORDER BY updated_at DESC`). This ensures the 1-based index visible in `/list` is always
consistent with the index accepted by `/switch` and `/delete`, even if messages have arrived
between commands.

**Manual `Default` for `TelegramConfig`** — `#[derive(Default)]` would produce
`max_sessions_per_chat: 0`, disabling all session creation via `/new`. The manual `impl Default`
calls `default_max_sessions_per_chat()` to return `10`, keeping the serde default and the
in-code default identical.

**`Me` injection for command parsing** — `teloxide`'s `filter_command::<Command>()` requires
a `Me` type in the dependency map to strip the bot's own username prefix from commands (e.g.,
`/new@botname` → `/new`). `bot.get_me().await?` is called at startup and `me` is injected first
in `dptree::deps![...]`.

**Authorization reused from `handlers`** — `handle_command` calls `handlers::is_authorized()`
with the same `allowed_users` config slice used by `handle_message`. Unauthorized command
messages are silently dropped, consistent with the existing regular message behavior.

**Plain text output for informational commands** — `/help`, `/history`, and `/list` all send
plain text (no `ParseMode::Html`). These responses do not contain LLM-generated Markdown, so the
`md_to_telegram_html` pipeline introduced in SY-17 is not needed here.

**Cap enforcement only in `/new`** — Session cap is not enforced at startup or during other
commands. Users may accumulate sessions across restarts if the cap was lower previously; the cap
acts as a rate limit on new session creation only.

---

## Session Index Ordering Strategy

The `/list`, `/switch N`, and `/delete N` commands depend on a deterministic ordering:

1. `list_sessions()` returns sessions `ORDER BY updated_at DESC` — most recent first.
2. Both `/switch` and `/delete` reconstruct this same filtered+ordered list on every call via
   a fresh `list_sessions()` invocation — no stale in-memory index is used for display.
3. `resolve_session` (regular messages) uses `ChatSessions.active_idx` directly from the
   in-memory map — no DB call on the hot path.

This separation keeps the hot path fast while ensuring command indexes always match what
`/list` shows at the time of the command.

---

## Risk Notes

Two low-severity edge cases noted in the QA report:

- **R-5**: If `storage.create_session` fails during the auto-create branch in `cmd_delete`
  (last-session deletion), the user receives a success message but the session is not actually
  created. The `ChatSessions.sessions` vec will be empty, so the next regular message goes
  through `resolve_session`'s slow path and creates a session correctly. Self-recovering.

- **R-6**: If `storage.delete_session` fails during eviction in `cmd_new`, the orphaned session
  remains in DB but is removed from the in-memory vec. It reappears at the next `rebuild_chat_map`
  (bot restart). Bounded to a single stale session per eviction failure.

Both are bounded in scope and self-correcting. No blocking issues were identified.

---

## Data Flow

```
Telegram Update (message)
  |
  v
Update::filter_message()
  |
  +--> branch 1: filter_command::<Command>() (parses /help, /new, /history, /list, /switch N, /delete N)
  |      |
  |      v
  |    commands::handle_command(bot, msg, cmd, config, storage, chat_map)
  |      |  is_authorized() check → match cmd { ... } → cmd_* function
  |      v
  |    Bot reply (plain text, no LLM invocation)
  |
  +--> branch 2: fallback (non-command text)
         |
         v
       handlers::handle_message(bot, msg, config, agent, storage, chat_map)
         |  resolve_session → agent.complete() → send HTML-formatted response
```

---

## Files Changed

| File | Change |
|------|--------|
| `synapse-core/src/config.rs` | `max_sessions_per_chat: u32` field + `default_max_sessions_per_chat()` + manual `impl Default` + two new tests + updated `test_telegram_config_default` |
| `synapse-telegram/Cargo.toml` | `chrono` moved from `[dev-dependencies]` to `[dependencies]`; empty dev-deps section removed |
| `synapse-telegram/src/handlers.rs` | `ChatSessions` struct + `active_session_id()` method + updated `ChatSessionMap` type alias + updated `resolve_session` |
| `synapse-telegram/src/commands.rs` | NEW file: `Command` enum with `BotCommands`; `handle_command` dispatcher; six `cmd_*` private functions; 11 unit tests |
| `synapse-telegram/src/main.rs` | `mod commands`; `bot.get_me()`; `set_my_commands`; branched dispatcher; `me` in `dptree::deps!`; rewritten `rebuild_chat_map`; updated startup log; updated and new tests |
| `config.example.toml` | `max_sessions_per_chat = 10` entry with two-line comment in `[telegram]` section |

## Files NOT Changed

- `synapse-core/src/agent.rs` — Agent layer is not involved in command handling
- `synapse-cli/` — CLI is entirely unaffected
- `synapse-core/src/provider/` — No provider changes

---

## Metrics

| Metric | Target | Achieved |
|--------|--------|----------|
| `cargo fmt --check` | Passes | Passes |
| `cargo clippy -- -D warnings` | Zero warnings | Zero warnings |
| `cargo test` | All green | 265 unit + 13 doc tests |
| All six commands compile and route correctly | Required | Confirmed |
| Session cap enforced in `/new` | Required | Confirmed with eviction message |
| `rebuild_chat_map` groups multiple sessions per chat | Required | Confirmed by `test_rebuild_chat_map_multi_session_per_chat` |
| `set_my_commands` at startup | Required | Non-fatal; logs warning on failure |
| Backward compatibility: non-command messages unchanged | Required | Branched dispatcher routes to `handle_message` unchanged |
| `max_sessions_per_chat` defaults to `10` | Required | Via `default_max_sessions_per_chat()` and manual `Default` |
| `config.example.toml` documents field | Required | Present with two-line comment |
| New unit tests | 11 in `commands.rs` + 1 in `main.rs` | 12 new tests; all pass |
