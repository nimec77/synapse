# SY-21 Summary: Code Refactoring II

**Ticket:** SY-21
**Status:** COMPLETE
**Date:** 2026-02-27
**Version:** 0.21.0

---

## Overview

SY-21 is a comprehensive internal refactoring pass across all three crates (`synapse-core`,
`synapse-cli`, `synapse-telegram`). It eliminates duplication, dead code, magic values, and
type-safety gaps accumulated since SY-16. Eight tasks were completed with zero external behaviour
changes. All 317 tests pass after every task.

---

## What Was Done

### Task 21.1: Unified truncation (`synapse-core/src/text.rs`)

A new `synapse-core/src/text.rs` module provides a single canonical `pub fn truncate(s: &str,
max_chars: usize) -> String` function. It uses `.chars()` iteration (not byte indexing) for
multi-byte safety, and includes a `max_chars <= 3` guard to prevent subtraction underflow.

Duplicate implementations were removed from three locations:
- `synapse-cli/src/commands.rs` — local `truncate` function deleted
- `synapse-telegram/src/commands.rs` — local `truncate_content` function deleted
- `synapse-core/src/storage/sqlite.rs` — inline `.chars().take(47)` replaced by `crate::text::truncate`
- Duplicate `test_truncate` test deleted from `synapse-cli/src/main.rs`

All truncation tests (including multi-byte and edge cases) consolidated into `text.rs`.

### Task 21.2: OpenAI-compatible provider consolidation

`OpenAiCompatProvider` struct added to `synapse-core/src/provider/openai_compat.rs` holding
`client`, `base_url`, `api_key`, `model`, and `max_tokens`. Full `LlmProvider` implementation
uses the pre-existing `build_api_messages`, `complete_request`, and `stream_sse` helpers.

`DeepSeekProvider` and `OpenAiProvider` rewritten as newtypes:
```rust
pub struct DeepSeekProvider(pub(super) OpenAiCompatProvider);
pub struct OpenAiProvider(pub(super) OpenAiCompatProvider);
```
All `LlmProvider` methods delegate to `self.0`. Combined provider files are now ~70 lines of
delegation only — no duplicated method bodies.

### Task 21.3: CLI session helper deduplication

New `synapse-cli/src/session.rs` module provides two shared async helpers:
- `init_storage(session_config: &SessionConfig) -> Result<Box<dyn SessionStore>>` — creates
  storage and runs auto-cleanup if configured
- `load_or_create_session(storage, config, session_id) -> Result<(Session, Vec<StoredMessage>)>`
  — loads an existing session by ID or creates a new one

Both the REPL path and one-shot path in `main.rs` now use these helpers. `repl.rs` accepts a
resolved session and history from the caller rather than duplicating init logic.

### Task 21.4: Telegram code deduplication

Five categories of duplication eliminated in `synapse-telegram`:

1. **Auth checks**: `check_auth(msg, config) -> Option<ResponseResult<()>>` helper in
   `handlers.rs` replaces three inline auth blocks. Returns `Some(Ok(()))` for unauthorized
   (short-circuits the handler) and `None` for authorized (continue). The `handle_callback`
   path uses `is_authorized()` directly because `CallbackQuery` is not a `TgMessage` — same
   security outcome.

2. **Session naming**: `tg_session_name(chat_id: i64) -> String` in `handlers.rs` replaces
   three `format!("tg:{}", chat_id)` ad-hoc strings.

3. **No-sessions reply**: `pub const NO_SESSIONS_HINT: &str` in `handlers.rs` replaces six
   duplicate "No sessions" strings scattered across `commands.rs`.

4. **Message limit constant**: `TELEGRAM_MSG_LIMIT` kept in `format/chunk.rs` as the single
   definition; `handlers.rs` imports it from `crate::format`.

5. **Keyboard builders**: `build_action_keyboard` (in `commands/keyboard.rs`) replaces
   `cmd_switch_keyboard` and `cmd_delete_keyboard`. `cmd_switch` and `cmd_delete` call it with
   `("switch", ...)` and `("delete", ...)` respectively.

`cmd_list` refactored to call `fetch_chat_sessions` instead of duplicating session-fetch logic.

### Task 21.5: Dead code removal and named constants

`stream_with_tools()` removed from the `LlmProvider` trait and all overrides. The method was
never called by `Agent` — only `complete_with_tools()` is used in the tool call loop.
`CLAUDE.md` and `README.md` updated to remove all references.

Named constants extracted to replace magic number literals:
- `HISTORY_MESSAGE_LIMIT: usize = 10` — in `commands.rs`
- `HISTORY_TRUNCATE_CHARS: usize = 150` — in `commands.rs`
- `LIST_PREVIEW_MAX_CHARS: usize = 40` — in `commands.rs`
- `KEYBOARD_PREVIEW_MAX_CHARS: usize = 20` — in `commands.rs`, imported in `keyboard.rs`
- `SESSION_PREVIEW_MAX_CHARS: usize = 50` — in `sqlite.rs`

### Task 21.6: Type safety improvements

**`Rotation` enum**: `LoggingConfig.rotation` changed from `String` to a typed enum:
```rust
#[derive(Debug, Clone, PartialEq, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum Rotation { Daily, Hourly, Never }
```
Invalid rotation values now produce a deserialization error at startup rather than a runtime
fallback. Existing config files using `"daily"`, `"hourly"`, `"never"` continue to work unchanged.

**`Arc<dyn SessionStore>`**: All 15 occurrences of `Arc<Box<dyn SessionStore>>` eliminated
throughout the Telegram crate. Construction uses `Arc::from(create_storage(...).await?)` (the
idiomatic `Box<dyn T>` to `Arc<dyn T>` conversion). Handler function signatures, `dptree::deps!`
injection, and all dependent code updated consistently.

### Task 21.7: Small polish

- **REPL layout constants**: `REPL_MIN_HISTORY_HEIGHT: u16 = 3`, `REPL_INPUT_HEIGHT: u16 = 3`,
  `REPL_STATUS_HEIGHT: u16 = 1` extracted in `repl/render.rs` to replace inline magic numbers.

- **`ChatSessions::new` constructor**: `impl ChatSessions { pub fn new(session_id: Uuid) -> Self }`
  added in `handlers.rs`. Replaces all single-session struct literal constructions in production
  code. Multi-session constructions (e.g., in `rebuild_chat_map`) and test fixtures with custom
  `active_idx` retain explicit struct literals.

- **Idiomatic `unwrap_or_else`**: Four `Ok(r) | Err(r) => r` patterns replaced with
  `.unwrap_or_else(|e| e)` — two in `commands.rs` and two in `commands/keyboard.rs`.

### Task 21.8: Module splits

Three large modules split into focused submodules using the Rust 2018+ convention (no `mod.rs`
files). Parent files declare submodules and re-export public symbols.

**`synapse-telegram/src/commands.rs` (1214 lines) split into:**
- `commands.rs` (785 lines) — `Command` enum, `handle_command`, all `cmd_*` handlers, helpers
- `commands/keyboard.rs` (408 lines) — `build_action_keyboard`, `build_session_keyboard`,
  `parse_callback_data`, `do_switch`, `do_delete`, `handle_callback`, `fetch_chat_sessions`

**`synapse-telegram/src/format.rs` (702 lines) split into:**
- `format.rs` (401 lines) — `md_to_telegram_html`, `escape_html`
- `format/chunk.rs` (314 lines) — `TELEGRAM_MSG_LIMIT`, `OpenTag`, `chunk_html`,
  `floor_char_boundary`, `find_split_point`, `update_open_tags`

**`synapse-core/src/provider/anthropic.rs` (674 lines) split into:**
- `anthropic.rs` (582 lines) — `AnthropicProvider` struct, `new()`, `LlmProvider` impl,
  streaming logic, tests
- `anthropic/types.rs` (108 lines) — `ApiRequest`, `AnthropicTool`, `ApiContent`, `ApiMessage`,
  `ApiResponse`, `ContentBlock`, `ApiError`, `ErrorDetail` serde structs

---

## Key Decisions

### `max_chars <= 3` guard in `truncate`
The CLI version's implementation was adopted as canonical because it is the most defensive: it
handles the edge case where `max_chars - 3` would underflow. All callers in practice pass
`max_chars >= 10`, so the guard is never triggered at runtime but protects against future misuse.

### `check_auth` for messages vs. `is_authorized` for callbacks
`check_auth(msg: &TgMessage, config)` cannot be reused in `handle_callback` because `CallbackQuery`
is a different type with no `TgMessage` field. The callback path calls `is_authorized(user_id,
allowed_users)` directly with equivalent security semantics. This was anticipated in the plan.

### `ChatSessions::new` scope
`ChatSessions::new(session_id)` is a single-session factory. Sites constructing multi-session
structs (e.g., `rebuild_chat_map`) or empty structs (e.g., `or_insert_with(|| ChatSessions {
sessions: vec![], active_idx: 0 })`) retain explicit struct literals because they express different
semantics.

### `anthropic/types.rs` size discrepancy
The PRD estimated ~320 lines for `types.rs`; the actual split produced 108 lines. The Anthropic
serde types are more concise than estimated. The structural goal (types separated from impl) was
fully achieved.

### `commands.rs` at 785 lines vs. 600 target
The remaining 785 lines consist largely of unit tests. The substantive handler code is well within
the intended scope. The functional split (keyboard logic extracted to `keyboard.rs`) is correct.

---

## Files Added

| File | Purpose |
|------|---------|
| `synapse-core/src/text.rs` | Canonical `truncate` function |
| `synapse-cli/src/session.rs` | `init_storage` + `load_or_create_session` helpers |
| `synapse-telegram/src/commands/keyboard.rs` | Keyboard builders + callback logic |
| `synapse-telegram/src/format/chunk.rs` | HTML chunking internals |
| `synapse-core/src/provider/anthropic/types.rs` | Anthropic serde request/response types |

---

## Metrics

| Metric | Before | After |
|--------|--------|-------|
| Truncation implementations | 4 (3 crates + 1 duplicate test) | 1 (`text::truncate`) |
| `deepseek.rs` + `openai.rs` combined | ~241 lines | ~70 lines |
| `format!("tg:{}")` sites | 3 | 1 (inside `tg_session_name`) |
| "No sessions" string literals | 6 | 1 (`NO_SESSIONS_HINT`) |
| `TELEGRAM_MSG_LIMIT` definitions | 2 | 1 |
| Keyboard builder functions | 2 | 1 (`build_action_keyboard`) |
| `stream_with_tools` in codebase | Present (unused) | Removed |
| `Arc<Box<dyn SessionStore>>` | 15 occurrences | 0 |
| `LoggingConfig.rotation` type | `String` | `Rotation` enum |
| `cargo test` results | — | 317/317 pass |
| `cargo clippy -- -D warnings` | — | Zero warnings |
