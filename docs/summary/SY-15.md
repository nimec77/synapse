# SY-15 Summary: File Logging (Phase 14)

**Ticket:** SY-15
**Branch:** `feature/sy-15-phase14`
**Status:** Released
**Date:** 2026-02-21

---

## What Was Done

Added file-based logging with automatic rotation to `synapse-telegram`. A `LoggingConfig`
struct was defined in `synapse-core/src/config.rs` and deserialized from an optional
`[logging]` TOML section. The Telegram bot's tracing initialization was rewritten to use a
layered `tracing-subscriber` (stdout + rolling file appender via `tracing-appender`).

Omitting the `[logging]` section preserves the original stdout-only behavior — fully backward
compatible. `synapse-cli` is completely unaffected.

The ticket also completed the work started in SY-14 by adding the `system_prompt_file`
configuration field, allowing operators to load system prompts from external Markdown files.

---

## Changes Made

### 1. `LoggingConfig` struct (`synapse-core/src/config.rs`)

Added a new `LoggingConfig` struct with three serde-defaulted fields:

```rust
/// File-based logging configuration with rotation.
///
/// Deserialized from the `[logging]` section in `config.toml`.
/// Omit the section entirely to disable file logging (stdout only).
#[derive(Debug, Clone, PartialEq, Deserialize)]
pub struct LoggingConfig {
    #[serde(default = "default_log_directory")]
    pub directory: String,     // Default: "logs"

    #[serde(default = "default_max_files")]
    pub max_files: usize,      // Default: 7

    #[serde(default = "default_rotation")]
    pub rotation: String,      // Default: "daily"
}
```

Added `logging: Option<LoggingConfig>` (with `#[serde(default)]`) to the `Config` struct
after the `telegram` field. Added `logging: None` to `Config::default()`. Pattern is identical
to the `SessionConfig` and `TelegramConfig` fields.

### 2. `LoggingConfig` re-exported from `synapse-core/src/lib.rs`

```rust
pub use config::{Config, ConfigError, LoggingConfig, McpSettings, SessionConfig, TelegramConfig};
```

### 3. `tracing-appender` and `registry` feature in `synapse-telegram/Cargo.toml`

Added `tracing-appender = "0.2"` and the `"registry"` feature to `tracing-subscriber`
to enable the layered subscriber pattern. No new dependencies in `synapse-core`.

### 4. Layered tracing initialization (`synapse-telegram/src/main.rs`)

Config loading was moved before tracing initialization so that the logging setup can
read `config.logging`. A private `init_tracing(config: &Config) -> anyhow::Result<Option<WorkerGuard>>`
helper was extracted:

- **No `[logging]` section**: stdout-only `tracing_subscriber::fmt()` path, identical to
  previous behavior. Returns `Ok(None)`.
- **`[logging]` section present**: creates the configured directory with
  `std::fs::create_dir_all` (falls back to stdout-only on failure), maps the rotation string
  to `Rotation::DAILY / HOURLY / NEVER` (unknown values fall back to `DAILY` with a warning),
  builds a `RollingFileAppender` with `.filename_prefix("synapse-telegram")` and
  `.max_log_files(lc.max_files)`, wraps it in `tracing_appender::non_blocking`, builds a
  `tracing_subscriber::registry()` combining an `EnvFilter`, a stdout `fmt` layer, and a file
  `fmt` layer (`.with_ansi(false)`), and returns `Ok(Some(guard))`.

The `_guard` is stored in `main()` before the `Dispatcher::builder(...).dispatch().await` call,
guaranteeing the non-blocking writer outlives the entire bot process.

### 5. `system_prompt_file` field (`synapse-core/src/config.rs`)

Added a companion to `system_prompt` for loading prompts from external files:

```rust
#[serde(default)]
pub system_prompt_file: Option<String>,
```

A private `resolve_system_prompt(&mut self)` method on `Config` is called during
`Config::load_from()`. It reads and trims the file if `system_prompt` is not already set
inline. Priority: inline `system_prompt` wins over `system_prompt_file`. Whitespace-only
file contents leave `system_prompt` as `None`.

### 6. `config.example.toml` updates

Added the `[logging]` section and `system_prompt_file` field documentation:

```toml
# Alternatively, load the system prompt from an external file.
# If both system_prompt and system_prompt_file are set, the inline value wins.
# system_prompt_file = "prompts/system.md"

# Logging configuration (file-based output with rotation)
# [logging]
# directory = "logs"
# max_files = 7
# rotation = "daily"
```

---

## Key Design Decisions

### Config loaded before tracing init

The original `main()` initialized tracing first, then loaded config. Since file logging
depends on `config.logging`, the order was reversed. Config load failures before tracing is
available go to `eprintln!` and fall back to `Config::default()` (which has `logging: None`),
so stdout-only tracing is initialized afterward. This is an acceptable trade-off: the config
error message goes to stderr, then all subsequent logging works normally.

### Non-blocking writer guard lifetime

`tracing_appender::non_blocking()` returns a `WorkerGuard` that flushes all buffered log
writes on drop. Dropping it early silently loses log messages. The guard is stored as
`let _guard = init_tracing(&config)?;` in `main()`, before the dispatcher loop. Rust's drop
ordering guarantees it outlives the entire `dispatch().await` call.

### Fallback on directory creation failure

If `std::fs::create_dir_all` fails (permissions, read-only filesystem), the code falls
back to stdout-only instead of aborting startup. The error is printed to `eprintln!`
(tracing is not yet initialized at that point). This matches the PRD risk mitigation
strategy: a transient infrastructure issue should not prevent the bot from starting.

### File appender build failure is a hard error

If `RollingFileAppender::builder().build()` fails after the directory was created successfully,
the error propagates via `?` and aborts startup with a clear message. A misconfigured
(but syntactically valid) logging section that cannot produce log files should be treated
as a startup error, not silently degraded.

### ANSI codes disabled in file output

The file `fmt` layer uses `.with_ansi(false)` to suppress ANSI escape sequences. The stdout
layer retains the default terminal detection behavior.

### `system_prompt_file` resolution priority

Inline `system_prompt` takes priority over `system_prompt_file`. This prevents accidental
override of an intentional inline prompt by a stale file reference. Whitespace-only file
contents are treated as absent (no prompt set), so an empty prompt file is equivalent to
omitting both fields.

---

## Testing

### New unit tests in `synapse-core/src/config.rs` (13 new tests total)

**`LoggingConfig` tests (5):**
- `test_logging_config_defaults` — `LoggingConfig::default()` returns `directory = "logs"`, `max_files = 7`, `rotation = "daily"`
- `test_config_without_logging_section` — TOML without `[logging]` gives `config.logging.is_none()`
- `test_config_with_logging_section` — all three custom fields parse correctly
- `test_config_with_logging_section_partial_defaults` — only `directory` set; `max_files` and `rotation` use defaults
- `test_config_with_empty_logging_section` — empty `[logging]` section gives all defaults

**`system_prompt_file` tests (8):**
- `test_parse_system_prompt_file_field` — field parses to `Some(path)`; `system_prompt` remains `None`
- `test_resolve_system_prompt_from_file` — file contents become `system_prompt`
- `test_resolve_system_prompt_inline_takes_priority` — inline prompt wins over file
- `test_resolve_system_prompt_file_not_found` — missing file returns `ConfigError::IoError`
- `test_resolve_system_prompt_neither_set` — no fields set leaves `system_prompt == None`
- `test_resolve_system_prompt_empty_file` — whitespace-only file leaves `system_prompt == None`
- `test_resolve_system_prompt_trims_whitespace` — leading/trailing whitespace is stripped

**Previously added (SY-14, included in final count):**
- `test_config_with_system_prompt`, `test_config_without_system_prompt`, `test_config_default_system_prompt`

### Regression

| Crate | Tests | Result |
|-------|-------|--------|
| `synapse-cli` | 41 | All PASS |
| `synapse-core` | 176 | All PASS |
| `synapse-telegram` | 13 | All PASS |
| Doc-tests | 14 | All PASS |
| **Total** | **244** | **All PASS** |

`cargo fmt --check` — PASS. `cargo clippy -- -D warnings` — PASS.

---

## Files Changed

| File | Change |
|------|--------|
| `synapse-core/src/config.rs` | `LoggingConfig` struct + defaults + `Default` impl; `logging: Option<LoggingConfig>` on `Config`; `system_prompt_file` field; `resolve_system_prompt()` helper; 13 new tests |
| `synapse-core/src/lib.rs` | `LoggingConfig` added to `pub use config::{ ... }` re-export |
| `synapse-telegram/Cargo.toml` | `tracing-appender = "0.2"` added; `"registry"` feature added to `tracing-subscriber` |
| `synapse-telegram/src/main.rs` | Config loaded before tracing; `init_tracing()` helper; stdout-only and layered branches; guard lifetime in `main()` |
| `config.example.toml` | `system_prompt_file` field documented; `[logging]` section documented |
| `docs/tasklist.md` | Phase 14 all 5 sub-tasks checked `[x]`; Phase 14 row set to "Complete" |
| `docs/idea.md` | File-based logging added to idea list |
| `docs/vision.md` | `tracing-appender` listed in dependency table; "File Logging" section added |

## Files NOT Changed

- `synapse-core/Cargo.toml` — no new dependencies in core
- `synapse-cli/src/main.rs`, `synapse-cli/src/repl.rs` — CLI completely unaffected
- All provider implementations — unchanged
- All DB migrations — unchanged
