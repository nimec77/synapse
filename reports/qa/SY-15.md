# QA Report: SY-15 — Phase 14: File Logging

**Date:** 2026-02-21
**Branch:** feature/sy-15-phase14
**Reviewer:** Claude Code (automated QA)
**Status at review:** All tasks [x] complete (IMPLEMENT_STEP_OK)

---

## 1. Summary

SY-15 adds file-based logging with automatic rotation to `synapse-telegram`. A `LoggingConfig` struct is defined in `synapse-core/src/config.rs` and deserialized from an optional `[logging]` TOML section. The Telegram bot's tracing initialization is rewritten to use a layered subscriber (stdout + rolling file appender via `tracing-appender`). Omitting `[logging]` preserves the original stdout-only behavior. `synapse-cli` is completely unaffected.

---

## 2. Scope of Changes Verified

| File | Change | Verified |
|------|--------|----------|
| `synapse-core/src/config.rs` | `LoggingConfig` struct, default fns, `Default` impl, `logging: Option<LoggingConfig>` on `Config`, `Config::default()` updated, 5 unit tests | Yes |
| `synapse-core/src/lib.rs` | `LoggingConfig` added to `pub use config::{ ... }` re-export | Yes |
| `synapse-telegram/Cargo.toml` | `tracing-appender = "0.2"` added; `registry` feature added to `tracing-subscriber` | Yes |
| `synapse-telegram/src/main.rs` | Config loaded before tracing; `init_tracing()` helper; stdout-only branch; layered branch; guard lifetime in `main()` | Yes |
| `config.example.toml` | `[logging]` section (lines 70–80) documents all three fields with defaults and valid rotation values | Yes |
| `docs/tasklist.md` | Phase 14 all 5 sub-tasks checked `[x]` | Yes |

---

## 3. Positive Scenarios

### 3.1 File Logging Enabled With Default Values (Automated)

**Test:** `test_config_with_empty_logging_section`

TOML input: `[logging]` (no fields). Expected: `config.logging = Some(LoggingConfig { directory: "logs", max_files: 7, rotation: "daily" })`.

**Result:** PASS. Test exists and passes in `synapse-core`.

---

### 3.2 File Logging Enabled With Custom Values (Automated)

**Test:** `test_config_with_logging_section`

TOML input:
```toml
[logging]
directory = "/var/log/synapse"
max_files = 30
rotation = "hourly"
```
Expected: all three fields parse correctly to the specified values.

**Result:** PASS.

---

### 3.3 File Logging With Partial Defaults (Automated)

**Test:** `test_config_with_logging_section_partial_defaults`

TOML input: `[logging]\ndirectory = "/tmp/logs"`. Expected: `max_files = 7`, `rotation = "daily"` come from defaults.

**Result:** PASS.

---

### 3.4 LoggingConfig::default() Correctness (Automated)

**Test:** `test_logging_config_defaults`

Expected: `directory = "logs"`, `max_files = 7`, `rotation = "daily"`.

**Result:** PASS.

---

### 3.5 Config Without `[logging]` Section (Automated)

**Test:** `test_config_without_logging_section`

Expected: `config.logging.is_none()`.

**Result:** PASS. Backward compatibility confirmed in code.

---

### 3.6 stdout + File Layered Subscriber (Manual)

When `config.logging = Some(...)`, `init_tracing()`:
1. Calls `std::fs::create_dir_all(&lc.directory)`.
2. Maps rotation string to `Rotation::DAILY / HOURLY / NEVER`.
3. Builds `RollingFileAppender` with `.filename_prefix("synapse-telegram")`, `.max_log_files(lc.max_files)`.
4. Wraps in `tracing_appender::non_blocking`.
5. Builds `tracing_subscriber::registry()` with `EnvFilter`, stdout `fmt` layer, file `fmt` layer (`.with_ansi(false)`).
6. Returns `Ok(Some(guard))`.

Code inspection confirms implementation matches spec exactly. Manual verification required to observe actual log file creation on disk.

**Status:** Code correct; manual smoke test recommended before production deployment.

---

### 3.7 Guard Lifetime (Code Inspection)

`_guard` is stored as a local binding in `main()` at line 110 (`let _guard = init_tracing(&config)?;`), before the `Dispatcher::builder(...).dispatch().await` call at line 182. Rust drop order guarantees the guard outlives the dispatcher loop.

**Result:** PASS (code review).

---

### 3.8 Non-Blocking Writer (Code Inspection)

`tracing_appender::non_blocking()` wraps the `RollingFileAppender`. This uses a dedicated background thread for file I/O. No async runtime blocking occurs.

**Result:** PASS (code review). Satisfies the project convention prohibiting blocking I/O in async functions.

---

### 3.9 CLI Unaffected (Code Inspection)

`synapse-cli` source (`synapse-cli/src/main.rs`, `synapse-cli/src/repl.rs`) was not modified. CLI does not reference `LoggingConfig` or `tracing-appender`. All 41 CLI tests pass.

**Result:** PASS.

---

## 4. Negative and Edge Cases

### 4.1 Unknown Rotation Value (Manual)

**Scenario:** `rotation = "weekly"` in config.

**Expected behavior:** `init_tracing()` prints `"Warning: Unknown rotation 'weekly', falling back to daily"` to stderr and uses `Rotation::DAILY`.

**Code verification:** The `other` arm of the `match lc.rotation.as_str()` block (lines 53–59, `main.rs`) performs `eprintln!` and falls back to `Rotation::DAILY`.

**Status:** Code correct; manual test recommended to observe stderr output.

---

### 4.2 Log Directory Creation Failure (Manual)

**Scenario:** `directory = "/root/protected/logs"` where the process lacks write permission.

**Expected behavior:** `create_dir_all` returns `Err`; warning is printed to stderr; stdout-only tracing is initialized; bot continues normally.

**Code verification:** Lines 34–46 of `main.rs` catch the error, print to `eprintln!`, and fall back to `tracing_subscriber::fmt()...init()` returning `Ok(None)`.

**Status:** Code correct; manual test recommended on a restricted-permission path.

---

### 4.3 File Appender Build Failure After Directory Created (Code Inspection)

**Scenario:** `create_dir_all` succeeds but `RollingFileAppender::builder().build()` returns `Err` (e.g., path too long, filesystem error).

**Expected behavior:** The `.context("Failed to create rolling file appender")?` propagates the error, causing `init_tracing()` to return `Err`, which propagates from `main()` and aborts startup with a clear error message.

**Assessment:** This is intentional — a misconfigured logging section should abort startup rather than silently degrade. The PRD explicitly accepts this behavior. No fallback is needed here.

**Status:** PASS (code review).

---

### 4.4 Empty `rotation` String (Manual)

**Scenario:** `rotation = ""` in config.

**Expected behavior:** Falls into the `other` arm, falls back to `Rotation::DAILY` with a warning. The empty string is a valid string from the TOML parser's perspective, so no parse error occurs.

**Status:** Code handles it correctly via the `other` wildcard arm.

---

### 4.5 `max_files = 0` (Code Inspection)

**Scenario:** `max_files = 0`.

**Expected behavior:** `tracing-appender` v0.2.4 builder accepts `max_log_files(0)`. The behavior of `max_log_files(0)` is not explicitly documented (may mean "keep zero files" or "keep unlimited"). This is a low-risk edge case for an operator misconfiguration.

**Risk level:** Low. The config field type is `usize` so negative values are impossible. An operator setting `max_files = 0` would likely observe all log files being deleted immediately, which is an operator error rather than a software defect.

**Recommendation:** Consider a validation that rejects `max_files = 0` with an error, or documenting the behavior in `config.example.toml`. Not a blocker for release.

---

### 4.6 Relative vs Absolute Log Directory (Code Inspection)

**Scenario:** `directory = "logs"` (relative path, default).

**Expected behavior:** Files are created relative to the process working directory. On a VPS with a systemd unit, the working directory is typically `/` or the service directory.

**Risk:** Relative paths may create log directories in unexpected locations depending on how the bot is launched. The PRD acknowledges this ("relative or absolute path") but does not mandate an absolute path.

**Recommendation:** Document the working-directory dependency in `config.example.toml`. Not a blocker.

---

### 4.7 Config Load Failure Before Tracing Is Initialized (Code Inspection)

**Scenario:** `config.toml` exists but is malformed TOML.

**Expected behavior:** `Config::load()` returns `Err`. The `unwrap_or_else` on line 104 catches it, prints to `eprintln!`, and falls back to `Config::default()`. `Config::default()` has `logging: None`, so stdout-only tracing is initialized. Bot starts normally.

**Assessment:** The PRD explicitly accepts this: "Config loading errors fall back to `Config::default()`, which has `logging: None`."

**Status:** PASS (code review).

---

### 4.8 ANSI Codes Absent in File Output (Code Inspection)

**Code:** `.with_ansi(false)` on the file `fmt` layer (line 80 of `main.rs`).

**Expected:** No ANSI escape codes in log files. Stdout layer retains ANSI (`.with_ansi()` not called, defaults to terminal detection).

**Status:** PASS (code review).

---

## 5. Automated Tests

### 5.1 Tests Added in This Ticket

| Test Name | Location | Purpose | Result |
|-----------|----------|---------|--------|
| `test_logging_config_defaults` | `synapse-core/src/config.rs` | `LoggingConfig::default()` returns correct field values | PASS |
| `test_config_without_logging_section` | `synapse-core/src/config.rs` | TOML without `[logging]` gives `config.logging.is_none()` | PASS |
| `test_config_with_logging_section` | `synapse-core/src/config.rs` | All three custom fields parse correctly | PASS |
| `test_config_with_logging_section_partial_defaults` | `synapse-core/src/config.rs` | Only `directory` set; `max_files` and `rotation` get defaults | PASS |
| `test_config_with_empty_logging_section` | `synapse-core/src/config.rs` | Empty `[logging]` section gives all defaults | PASS |

### 5.2 Regression Test Summary

| Crate | Tests | Result |
|-------|-------|--------|
| `synapse-cli` | 41 | All PASS |
| `synapse-core` | 176 | All PASS |
| `synapse-telegram` | 13 | All PASS |
| Doc-tests (`synapse-core`) | 13 + 1 ignored | All PASS |
| **Total** | **243** | **All PASS** |

`cargo fmt --check` — PASS (no formatting issues).
`cargo clippy -- -D warnings` — PASS (no warnings).

---

## 6. Manual Checks Required

The following scenarios cannot be verified by automated tests due to global state (tracing subscriber singleton), filesystem I/O, and time-dependent rotation:

| Check | Steps | Expected Outcome |
|-------|-------|-----------------|
| Log file appears on startup | Add `[logging]` to `config.toml`, run `synapse-telegram` with a valid bot token | `logs/synapse-telegram.YYYY-MM-DD` created in working directory, same log lines appear on stdout and in file |
| Custom directory created | Set `directory = "/tmp/synapse-test-logs"`, start bot | `/tmp/synapse-test-logs/` created automatically |
| Hourly rotation file naming | Set `rotation = "hourly"`, start bot | File named `synapse-telegram.YYYY-MM-DD-HH` |
| Stdout-only when `[logging]` absent | Remove `[logging]` from config, start bot | No `logs/` directory created; normal stdout output only |
| ANSI codes absent in log file | Enable file logging, inspect file with `cat` | No `\x1b[` escape sequences in file content |
| Unknown rotation falls back | Set `rotation = "monthly"`, start bot | `Warning: Unknown rotation 'monthly', falling back to daily` on stderr; daily files created |
| Directory creation failure fallback | Set `directory = "/root/no-permission"`, run as unprivileged user | Warning on stderr; bot starts with stdout-only logging |
| Guard keeps file open | Send messages to bot, observe file grows; shut down bot | Final log lines ("Dispatcher stopped", "Agent shutdown complete") appear in the file before it closes |
| max_files rotation cleanup | Set `max_files = 2`, advance system clock by 3 days (or mock) | Oldest file deleted when third file is created |

---

## 7. Risk Zone

| Risk | Likelihood | Impact | Notes |
|------|-----------|--------|-------|
| `max_files = 0` keeps zero files (operator misconfiguration) | Low | Low | usize prevents negatives; zero is an unusual edge case; no crash, just behavioral surprise |
| Relative `directory` path resolves differently depending on launch method | Low | Medium | VPS/systemd users may find logs in unexpected location; document the working directory dependency |
| `tracing-appender` `max_log_files` deletes files immediately if count already exceeds limit | Low | Low | Startup could delete older log files that operator did not intend to remove |
| ANSI on stdout: terminal detection relies on isatty; if stdout is piped, colors are disabled | None | None | Standard tracing-subscriber behavior; consistent with existing deployment patterns |
| Guard dropped early if `main()` restructured in future | Low | High | Current guard placement (`let _guard` before dispatcher loop) is correct; any future refactor must preserve this |

No blocking risks for release. The two recommendations (document relative path behavior; consider `max_files = 0` validation) are minor quality-of-life improvements, not defects.

---

## 8. Architecture Compliance

| Rule | Status |
|------|--------|
| `LoggingConfig` defined in `synapse-core` (core owns config types) | PASS |
| `tracing-appender` dependency only in `synapse-telegram` | PASS |
| `synapse-core` gains no new Cargo dependencies | PASS |
| No `unwrap()` / `expect()` in `synapse-core` | PASS |
| `thiserror` in core, `anyhow` in telegram | PASS |
| No blocking I/O in async functions | PASS (`tracing-appender` uses a background thread) |
| Module system: no `mod.rs` files introduced | PASS |
| 100-character line limit respected | PASS (confirmed by `cargo fmt --check`) |
| `pub` items have `///` doc comments | PASS (`LoggingConfig` struct and all three fields) |
| `LoggingConfig` re-exported from `synapse-core/src/lib.rs` | PASS |

---

## 9. Final Verdict

**RELEASE**

All 5 acceptance criteria unit tests pass. The full 243-test suite passes with zero failures. `cargo fmt --check` and `cargo clippy -- -D warnings` are both clean. Code review confirms correct implementation of all planned behaviors: layered subscriber, guard lifetime, fallback to stdout-only on directory creation failure, unknown rotation fallback, ANSI disabled in file layer, config loaded before tracing init, and CLI completely unaffected.

Two minor non-blocking recommendations:
1. Document that `directory` is resolved relative to the process working directory in `config.example.toml`.
2. Consider adding a validation warning or error when `max_files = 0` is configured.

Neither recommendation is a defect or a blocker. The implementation is correct, complete, and safe to ship.
